<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantrax Pitcher Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 13px;
            color: #374151;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .pitcher-entry {
            display: grid;
            grid-template-columns: 1.5fr 2fr 1fr 1.5fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        .search-results {
            position: absolute;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: calc(100% - 4px);
            margin-top: 2px;
        }
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
        }
        .search-result-item:hover { background: #f9fafb; }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .team-section {
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
            overflow: hidden;
        }
        .team-header {
            padding: 20px;
            cursor: pointer;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .team-header:hover { background: #f9fafb; }
        .team-content { padding: 20px; padding-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; }
        .counted { background: #d1fae5; }
        .excluded { background: #fee2e2; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¾ Fantrax Pitcher Tracker</h1>
            <p>Track pitcher overages and calculate corrected scores</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">Step 1: Input</button>
            <button class="tab" onclick="switchTab(1)">Step 2: Review</button>
            <button class="tab" onclick="switchTab(2)">Step 3: Calculate</button>
        </div>
        
        <div class="tab-content active" id="tab0">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2>Week Setup</h2>
                <button class="btn btn-secondary" onclick="resetAll()">ðŸ”„ Clear</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                <div class="form-group">
                    <label>Week Start</label>
                    <input type="date" id="weekStart" onchange="updateWeekEnd()">
                </div>
                <div class="form-group">
                    <label>Week End</label>
                    <input type="date" id="weekEnd">
                </div>
                <div class="form-group">
                    <label>Max Starts (SP)</label>
                    <input type="number" id="maxStarts" value="7" min="0">
                </div>
                <div class="form-group">
                    <label>Max Relief (RP)</label>
                    <input type="number" id="maxRP" value="10" min="0">
                </div>
            </div>
            
            <h3>Pitcher Appearances</h3>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">
                Add each active appearance for ALL teams with overages
            </p>
            
            <div id="pitcherList">
                <div class="pitcher-entry">
                    <div class="form-group">
                        <input type="text" class="fantasy-team" placeholder="Fantasy Team">
                    </div>
                    <div class="form-group" style="position: relative;">
                        <input type="text" class="pitcher-name" placeholder="Pitcher Name" autocomplete="off">
                        <div class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <input type="text" class="mlb-team" placeholder="NYY" maxlength="3">
                    </div>
                    <div class="form-group">
                        <input type="date" class="game-date">
                    </div>
                    <button class="btn btn-danger" onclick="removeRow(this)">âœ•</button>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="addRow()">+ Add</button>
            <button class="btn btn-primary" onclick="fetchGames()" style="float: right;">Fetch Games â†’</button>
        </div>
        
        <div class="tab-content" id="tab1">
            <div id="reviewResults"><div class="loading">Complete Step 1</div></div>
        </div>
        
        <div class="tab-content" id="tab2">
            <div id="calcResults"><div class="loading">Complete Steps 1 & 2</div></div>
        </div>
    </div>
    
    <script>
        let allPitchers = [];
        let gameData = [];
        
        window.onload = function() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            document.getElementById('weekStart').valueAsDate = monday;
            updateWeekEnd();
            loadMLBPitchers();
            
            document.getElementById('pitcherList').addEventListener('input', function(e) {
                if (e.target.classList.contains('pitcher-name')) {
                    searchPitcher(e.target);
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('pitcher-name')) {
                    document.querySelectorAll('.search-results').forEach(d => d.style.display = 'none');
                }
            });
        };
        
        function updateWeekEnd() {
            const start = document.getElementById('weekStart').value;
            if (start) {
                const d = new Date(start);
                d.setDate(d.getDate() + 6);
                document.getElementById('weekEnd').valueAsDate = d;
                document.querySelectorAll('.game-date').forEach(input => {
                    input.min = start;
                    input.max = document.getElementById('weekEnd').value;
                    if (!input.value) input.value = start;
                });
            }
        }
        
        async function loadMLBPitchers() {
            try {
                const res = await fetch('https://statsapi.mlb.com/api/v1/sports/1/players?season=2024');
                const data = await res.json();
                if (data.people) {
                    allPitchers = data.people
                        .filter(p => p.primaryPosition && p.primaryPosition.abbreviation === 'P')
                        .map(p => ({ name: p.fullName, id: p.id, team: p.currentTeam?.abbreviation || 'FA' }));
                    console.log('Loaded ' + allPitchers.length + ' pitchers');
                }
            } catch(e) { console.error(e); }
        }
        
        function searchPitcher(input) {
            const query = input.value.toLowerCase();
            const div = input.parentElement.querySelector('.search-results');
            if (query.length < 2) { div.style.display = 'none'; return; }
            if (!allPitchers.length) {
                div.innerHTML = '<div class="search-result-item">Loading...</div>';
                div.style.display = 'block';
                return;
            }
            const matches = allPitchers.filter(p => p.name.toLowerCase().includes(query)).slice(0, 10);
            if (!matches.length) {
                div.innerHTML = '<div class="search-result-item">No matches</div>';
                div.style.display = 'block';
                return;
            }
            div.innerHTML = matches.map(p => 
                `<div class="search-result-item" onclick='selectPitcher(this, ${JSON.stringify(p)})'>
                    <strong>${p.name}</strong><span style="color:#6b7280;">${p.team}</span>
                </div>`
            ).join('');
            div.style.display = 'block';
        }
        
        function selectPitcher(el, p) {
            const entry = el.closest('.pitcher-entry');
            entry.querySelector('.pitcher-name').value = p.name;
            entry.querySelector('.pitcher-name').dataset.playerId = p.id;
            entry.querySelector('.mlb-team').value = p.team;
            el.parentElement.style.display = 'none';
        }
        
        function addRow() {
            const div = document.createElement('div');
            div.className = 'pitcher-entry';
            const ws = document.getElementById('weekStart').value;
            const we = document.getElementById('weekEnd').value;
            div.innerHTML = `
                <div class="form-group"><input type="text" class="fantasy-team" placeholder="Fantasy Team"></div>
                <div class="form-group" style="position: relative;">
                    <input type="text" class="pitcher-name" placeholder="Pitcher Name" autocomplete="off">
                    <div class="search-results" style="display: none;"></div>
                </div>
                <div class="form-group"><input type="text" class="mlb-team" placeholder="NYY" maxlength="3"></div>
                <div class="form-group"><input type="date" class="game-date" min="${ws}" max="${we}" value="${ws}"></div>
                <button class="btn btn-danger" onclick="removeRow(this)">âœ•</button>
            `;
            document.getElementById('pitcherList').appendChild(div);
        }
        
        function removeRow(btn) {
            if (document.querySelectorAll('.pitcher-entry').length > 1) {
                btn.closest('.pitcher-entry').remove();
            }
        }
        
        async function fetchGames() {
            const entries = document.querySelectorAll('.pitcher-entry');
            const pitchers = [];
            entries.forEach(e => {
                const ft = e.querySelector('.fantasy-team').value;
                const name = e.querySelector('.pitcher-name').value;
                const mlb = e.querySelector('.mlb-team').value;
                const date = e.querySelector('.game-date').value;
                const id = e.querySelector('.pitcher-name').dataset.playerId;
                if (ft && name && mlb && date) {
                    pitchers.push({ fantasyTeam: ft, name, mlbTeam: mlb, gameDate: date, playerId: id });
                }
            });
            if (!pitchers.length) { alert('Add at least one pitcher'); return; }
            
            document.getElementById('reviewResults').innerHTML = '<div class="loading">Fetching...</div>';
            switchTab(1);
            
            gameData = [];
            for (const p of pitchers) {
                const g = await fetchGameData(p.playerId, p.mlbTeam, p.gameDate, p.name);
                if (g) gameData.push({ ...p, gameTime: g.gameTime, type: g.type, stats: g.stats });
            }
            displayReview();
        }
        
        async function fetchGameData(id, team, date, name) {
            try {
                const teams = {NYY:147,BOS:111,TOR:141,TB:139,BAL:110,CLE:114,MIN:142,CWS:145,DET:116,KC:118,
                              HOU:117,TEX:140,SEA:136,LAA:108,OAK:133,ATL:144,NYM:121,PHI:143,MIA:146,WSH:120,
                              MIL:158,CHC:112,STL:138,PIT:134,CIN:113,LAD:119,SD:135,SF:137,ARI:109,COL:115};
                const tid = teams[team.toUpperCase()];
                const sched = await fetch(`https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=${tid}&startDate=${date}&endDate=${date}`);
                const sd = await sched.json();
                if (!sd.dates || !sd.dates.length) return null;
                
                for (const dt of sd.dates) {
                    for (const game of dt.games) {
                        const box = await fetch(`https://statsapi.mlb.com/api/v1/game/${game.gamePk}/boxscore`);
                        const bd = await box.json();
                        
                        let pitcher = null, teamData = null;
                        for (const t of [bd.teams.home, bd.teams.away]) {
                            for (const [k,p] of Object.entries(t.players || {})) {
                                if ((id && p.person.id == id) || (name && p.person.fullName.toLowerCase().includes(name.toLowerCase()))) {
                                    if (p.stats?.pitching && (p.stats.pitching.battersFaced > 0 || parseFloat(p.stats.pitching.inningsPitched||0) > 0)) {
                                        pitcher = p; teamData = t; break;
                                    }
                                }
                            }
                            if (pitcher) break;
                        }
                        
                        if (pitcher) {
                            const isStart = teamData.pitchers && teamData.pitchers[0] == pitcher.person.id;
                            return { gameTime: new Date(game.gameDate), type: isStart ? 'SP' : 'RP', stats: pitcher.stats.pitching };
                        }
                    }
                }
                return null;
            } catch(e) { console.error(e); return null; }
        }
        
        function displayReview() {
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            Object.keys(teams).forEach(t => teams[t].sort((a,b) => a.gameTime - b.gameTime));
            
            let html = '<div class="summary-card"><h2>Review by Team</h2></div>';
            Object.keys(teams).sort().forEach((tn, i) => {
                const apps = teams[tn];
                let sp = 0, rp = 0;
                html += `<div class="team-section"><div class="team-header" onclick="toggle(${i})">
                    <h3>${tn}</h3><span id="a${i}">â–¼</span></div><div id="t${i}" class="team-content">
                    <table><tr><th>#</th><th>Pitcher</th><th>Type</th><th>Time</th><th>Status</th></tr>`;
                apps.forEach((a,j) => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    html += `<tr class="${ok?'counted':'excluded'}"><td>${j+1}</td><td>${a.name}</td><td>${a.type}</td>
                        <td>${a.gameTime.toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})}</td>
                        <td>${ok?'âœ“ Counts':'âœ— Excluded'}</td></tr>`;
                });
                html += '</table></div></div>';
            });
            html += '<button class="btn btn-primary" onclick="switchTab(2);calculateStats();" style="width:100%;padding:15px;margin-top:20px;">Continue â†’</button>';
            document.getElementById('reviewResults').innerHTML = html;
        }
        
        function calculateStats() {
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            
            let html = '<div class="summary-card"><h2>Corrected Totals</h2><button class="btn btn-success" onclick="exportCSV()">ðŸ“Š Export CSV</button></div>';
            Object.keys(teams).sort().forEach((tn,i) => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0, total = 0;
                const pitchers = {};
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    if (!pitchers[a.name]) pitchers[a.name] = {counted:[],excluded:[]};
                    (ok ? pitchers[a.name].counted : pitchers[a.name].excluded).push(a);
                });
                
                html += `<div class="team-section"><div class="team-header" onclick="toggleC(${i})">
                    <h3>${tn}</h3><span id="ca${i}">â–¼</span></div><div id="c${i}" class="team-content">`;
                
                Object.keys(pitchers).forEach(pn => {
                    const p = pitchers[pn];
                    const all = [...p.counted, ...p.excluded];
                    let ip=0,er=0,k=0,bb=0,h=0;
                    all.forEach(a => {
                        if (a.stats) {
                            ip += parseIP(a.stats.inningsPitched);
                            er += parseInt(a.stats.earnedRuns||0);
                            k += parseInt(a.stats.strikeOuts||0);
                            bb += parseInt(a.stats.baseOnBalls||0);
                            h += parseInt(a.stats.hits||0);
                        }
                    });
                    const pts = (ip*1.5)+(er*-2)+(k*0.75)+(bb*-0.25)+(h*-0.25);
                    let cpts = pts;
                    if (p.counted.length > 0 && p.excluded.length > 0) {
                        const cip = p.counted.reduce((s,a) => s + parseIP(a.stats?.inningsPitched||0), 0);
                        cpts = ip > 0 ? pts * (cip / ip) : 0;
                    } else if (!p.counted.length) cpts = 0;
                    
                    total += cpts;
                    html += `<div style="background:white;padding:15px;margin:10px 0;border-radius:6px;border-left:4px solid ${cpts>0?'#10b981':'#ef4444'};">
                        <div style="display:flex;justify-content:space-between;"><strong>${pn}</strong>
                        <strong style="color:${cpts>0?'#10b981':'#ef4444'};">${cpts.toFixed(2)} pts</strong></div>
                        <div style="font-size:13px;color:#6b7280;margin-top:5px;">IP:${ip.toFixed(1)} ER:${er} K:${k} BB:${bb} H:${h}</div>
                        <div style="font-size:12px;color:#6b7280;margin-top:5px;">${p.counted.length} counted, ${p.excluded.length} excluded</div></div>`;
                });
                
                html += `<div style="background:#667eea;color:white;padding:15px;border-radius:6px;margin-top:15px;">
                    <strong>Team Total: ${total.toFixed(2)} points</strong></div></div></div>`;
            });
            document.getElementById('calcResults').innerHTML = html;
        }
        
        function parseIP(s) {
            if (!s) return 0;
            const f = parseFloat(s), w = Math.floor(f), d = Math.round((f-w)*10);
            return d === 1 ? w + 1/3 : d === 2 ? w + 2/3 : w;
        }
        
        function exportCSV() {
            const ws = document.getElementById('weekStart').value;
            const we = document.getElementById('weekEnd').value;
            let csv = 'Fantasy Team,Pitcher,MLB Team,Date,Type,Status\n';
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    csv += `"${tn}","${a.name}","${a.mlbTeam}","${a.gameTime.toLocaleDateString()}","${a.type}","${ok?'COUNTS':'EXCLUDED'}"\n`;
                });
            });
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Overages_${ws}_to_${we}.csv`;
            a.click();
        }
        
        function switchTab(i) {
            document.querySelectorAll('.tab').forEach((t,j) => t.classList.toggle('active', j===i));
            document.querySelectorAll('.tab-content').forEach((c,j) => c.classList.toggle('active', j===i));
        }
        
        function toggle(i) {
            const c = document.getElementById('t'+i), a = document.getElementById('a'+i);
            if (c.style.display === 'none') { c.style.display = 'block'; a.textContent = 'â–¼'; }
            else { c.style.display = 'none'; a.textContent = 'â–¶'; }
        }
        
        function toggleC(i) {
            const c = document.getElementById('c'+i), a = document.getElementById('ca'+i);
            if (c.style.display === 'none') { c.style.display = 'block'; a.textContent = 'â–¼'; }
            else { c.style.display = 'none'; a.textContent = 'â–¶'; }
        }
        
        function resetAll() { if (confirm('Clear all?')) location.reload(); }
    </script>
</body>
</html>
