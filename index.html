<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantrax Pitcher Overage Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e8e8e8;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        .input-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .week-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .pitcher-entry {
            display: grid;
            grid-template-columns: 1.5fr 2fr 1fr 1.5fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .pitchers-list {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }
        
        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }
        
        .alert-success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .results-table tr:hover {
            background: #f9fafb;
        }
        
        .excluded {
            background: #fee2e2 !important;
            color: #991b1b;
        }
        
        .counted {
            background: #d1fae5 !important;
            color: #065f46;
        }
        
        .stat-input {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .summary-card h3 {
            margin-bottom: 10px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 6px;
        }
        
        .stat-box .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-box .value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-result-item:hover {
            background: #f3f4f6;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .form-group {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öæ Fantrax Pitcher Overage Calculator</h1>
            <p>Automatically track pitcher usage and calculate corrected stats when limits are exceeded</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">1. Pitcher Input</button>
            <button class="tab" onclick="switchTab(1)">2. Game Times</button>
            <button class="tab" onclick="switchTab(2)">3. Calculate Stats</button>
        </div>
        
        <!-- Tab 1: Pitcher Input -->
        <div class="tab-content active" id="tab1">
            <div class="alert alert-info">
                <strong>Step 1:</strong> Add each ACTIVE pitcher appearance during the week for ALL teams that exceeded limits. Add the fantasy team name for each pitcher.
                <br><br>
                <strong>Important:</strong> If a pitcher was active multiple times, add them multiple times with different dates.
            </div>
            
            <div class="input-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">Week Information</h3>
                    <button class="btn btn-secondary" onclick="resetForm()" style="padding: 8px 16px;">
                        üîÑ Clear & Start Over
                    </button>
                </div>
                <div class="week-input">
                    <div class="form-group">
                        <label>Week Start</label>
                        <input type="date" id="weekStart" onchange="updateWeekEnd()">
                    </div>
                    <div class="form-group">
                        <label>Week End</label>
                        <input type="date" id="weekEnd" onchange="updateGameDateConstraints()">
                    </div>
                </div>
            </div>
            
            <div class="input-section">
                <h3>Appearance Limits</h3>
                <p style="font-size: 13px; color: #6b7280; margin-bottom: 10px;">Adjust these for special weeks (e.g., Opening Week, All-Star Break)</p>
                <div class="week-input">
                    <div class="form-group">
                        <label>Max Starts (SP)</label>
                        <input type="number" id="maxStarts" value="7" min="0" max="20">
                    </div>
                    <div class="form-group">
                        <label>Max Relief Appearances (RP)</label>
                        <input type="number" id="maxReliefApp" value="10" min="0" max="30">
                    </div>
                </div>
            </div>
            
            <div class="input-section">
                <h3>Add Active Appearances</h3>
                <p style="font-size: 13px; color: #6b7280; margin-bottom: 15px;">Add one row for each game where a pitcher was in an active lineup (not on bench). Include all teams with overages.</p>
                <div id="pitcherEntries">
                    <div class="pitcher-entry">
                        <div class="form-group">
                            <label>Fantasy Team</label>
                            <input type="text" class="team-name" placeholder="e.g., John's Team">
                        </div>
                        <div class="form-group">
                            <label>Pitcher Name</label>
                            <input type="text" class="pitcher-name" placeholder="Start typing name..." autocomplete="off">
                            <div class="search-results" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label>MLB Team</label>
                            <input type="text" class="pitcher-team" placeholder="NYY" maxlength="3">
                        </div>
                        <div class="form-group">
                            <label>Game Date</label>
                            <input type="date" class="game-date">
                        </div>
                        <button class="btn btn-danger" onclick="removeRow(this)" style="margin-top: 20px;">Remove</button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="addPitcherRow()" style="margin-top: 10px;">+ Add Another Appearance</button>
            </div>
            
            <button class="btn btn-primary btn-lg" onclick="fetchGameTimes()" style="width: 100%; padding: 15px; font-size: 16px;">
                Fetch Game Times & Continue ‚Üí
            </button>
        </div>
        
        <!-- Tab 2: Game Times -->
        <div class="tab-content" id="tab2">
            <div class="alert alert-warning">
                <strong>Step 2:</strong> Review the chronological order of pitchers. The tool has automatically fetched game start times.
            </div>
            
            <div id="gameTimesResults">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Click "Fetch Game Times" in Step 1 to see results</p>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: Calculate Stats -->
        <div class="tab-content" id="tab3">
            <div class="alert alert-success">
                <strong>Step 3:</strong> Enter stats for each pitcher and calculate corrected totals. Only pitchers within limits will count.
            </div>
            
            <div id="statsResults">
                <div class="loading">
                    <p>Complete Steps 1 & 2 first</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let pitchers = [];
        let gameTimesData = [];
        let allMLBPitchers = [];
        
        // Set default date to current week's Monday
        window.onload = function() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));
            document.getElementById('weekStart').valueAsDate = monday;
            updateWeekEnd();
            loadMLBPitchers();
            
            // Set initial game date to week start
            setTimeout(() => {
                const initialGameDate = document.querySelector('.game-date');
                if (initialGameDate) {
                    const weekStart = document.getElementById('weekStart').value;
                    if (weekStart) {
                        initialGameDate.value = weekStart;
                    }
                }
            }, 100);
            
            // Setup event delegation for pitcher search (handles dynamically added rows)
            document.getElementById('pitcherEntries').addEventListener('input', function(e) {
                if (e.target.classList.contains('pitcher-name')) {
                    searchPitcher(e.target);
                }
            });
            
            // Hide search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('pitcher-name')) {
                    document.querySelectorAll('.search-results').forEach(div => {
                        div.style.display = 'none';
                    });
                }
            });
        };
        
        async function loadMLBPitchers() {
            try {
                // Use 2024 season data (2025 rosters not finalized until spring)
                const year = 2024;
                
                // Try to load all players first, then filter
                const response = await fetch(`https://statsapi.mlb.com/api/v1/sports/1/players?season=${year}`);
                const data = await response.json();
                
                // Check if data.people exists
                if (!data.people || !Array.isArray(data.people)) {
                    console.error('MLB API returned unexpected format:', data);
                    throw new Error('Invalid API response format');
                }
                
                // Filter for pitchers - be more inclusive to catch everyone
                allMLBPitchers = data.people
                    .filter(p => {
                        // Include if primary position is pitcher OR if they have pitcher designation
                        const isPitcher = (p.primaryPosition && p.primaryPosition.abbreviation === 'P') ||
                                        (p.primaryPosition && p.primaryPosition.code === '1') ||
                                        (p.primaryPosition && p.primaryPosition.type === 'Pitcher');
                        return isPitcher;
                    })
                    .map(p => ({
                        name: p.fullName,
                        id: p.id,
                        team: (p.currentTeam && p.currentTeam.abbreviation) ? p.currentTeam.abbreviation : 'FA'
                    }));
                    
                console.log(`‚úÖ Loaded ${allMLBPitchers.length} MLB pitchers from ${year} season`);
            } catch (error) {
                console.error('‚ùå Error loading MLB pitchers:', error);
                // Fallback: try with gameType=R if first attempt fails
                try {
                    const response = await fetch(`https://statsapi.mlb.com/api/v1/sports/1/players?season=2024&gameType=R`);
                    const data = await response.json();
                    
                    if (!data.people || !Array.isArray(data.people)) {
                        console.error('Fallback MLB API also returned unexpected format');
                        allMLBPitchers = [];
                        return;
                    }
                    
                    allMLBPitchers = data.people
                        .filter(p => p.primaryPosition && (p.primaryPosition.abbreviation === 'P' || p.primaryPosition.code === '1'))
                        .map(p => ({
                            name: p.fullName,
                            id: p.id,
                            team: (p.currentTeam && p.currentTeam.abbreviation) ? p.currentTeam.abbreviation : 'FA'
                        }));
                        
                    console.log(`‚úÖ Loaded ${allMLBPitchers.length} MLB pitchers (fallback)`);
                } catch (fallbackError) {
                    console.error('‚ùå Fallback also failed:', fallbackError);
                    allMLBPitchers = [];
                }
            }
        }
        
        function searchPitcher(input) {
            const query = input.value.toLowerCase();
            const resultsDiv = input.parentElement.querySelector('.search-results');
            
            console.log(`üîç Search query: "${query}", allMLBPitchers length: ${allMLBPitchers.length}`);
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            if (allMLBPitchers.length === 0) {
                console.warn('‚ö†Ô∏è allMLBPitchers is empty - MLB API may not have loaded');
                resultsDiv.innerHTML = '<div class="search-result-item" style="color: #ef4444; padding: 10px;">Pitcher database loading... Please wait or type the full name.</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            const matches = allMLBPitchers
                .filter(p => p.name.toLowerCase().includes(query))
                .slice(0, 10);
            
            console.log(`Found ${matches.length} matches`);
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div class="search-result-item" style="color: #6b7280; padding: 10px;">No matches found. You can still enter the name manually.</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            resultsDiv.innerHTML = matches
                .map(p => `
                    <div class="search-result-item" onclick="selectPitcher(this, '${p.name}', '${p.team}', ${p.id})">
                        <span><strong>${p.name}</strong></span>
                        <span style="color: #6b7280; font-size: 12px;">${p.team}</span>
                    </div>
                `)
                .join('');
            
            resultsDiv.style.display = 'block';
        }
        
        function selectPitcher(element, name, team, playerId) {
            const entry = element.closest('.pitcher-entry');
            const nameInput = entry.querySelector('.pitcher-name');
            const teamInput = entry.querySelector('.pitcher-team');
            
            nameInput.value = name;
            teamInput.value = team;
            nameInput.dataset.playerId = playerId;
            
            element.closest('.search-results').style.display = 'none';
        }
        
        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('pitcher-name')) {
                document.querySelectorAll('.search-results').forEach(div => {
                    div.style.display = 'none';
                });
            }
        });
        
        function resetForm() {
            if (confirm('Clear all data and start over for a new week?')) {
                // Reset all form fields
                
                // Keep date fields but allow changing
                
                // Remove all pitcher entries except first
                const container = document.getElementById('pitcherEntries');
                const firstEntry = container.querySelector('.pitcher-entry');
                container.innerHTML = '';
                
                // Reset first entry
                const newEntry = document.createElement('div');
                newEntry.className = 'pitcher-entry';
                newEntry.innerHTML = `
                    <div class="form-group">
                        <label>Fantasy Team</label>
                        <input type="text" class="team-name" placeholder="e.g., John's Team">
                    </div>
                    <div class="form-group">
                        <label>Pitcher Name</label>
                        <input type="text" class="pitcher-name" placeholder="Start typing name..." autocomplete="off">
                        <div class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label>MLB Team</label>
                        <input type="text" class="pitcher-team" placeholder="NYY" maxlength="3">
                    </div>
                    <div class="form-group">
                        <label>Game Date</label>
                        <input type="date" class="game-date">
                    </div>
                    <button class="btn btn-danger" onclick="removeRow(this)" style="margin-top: 20px;">Remove</button>
                `;
                container.appendChild(newEntry);
                
                // Clear data arrays
                pitchers = [];
                gameTimesData = [];
                
                // Reset tabs
                document.getElementById('gameTimesResults').innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click "Fetch Game Times" in Step 1 to see results</p>
                    </div>
                `;
                
                document.getElementById('statsResults').innerHTML = `
                    <div class="loading">
                        <p>Complete Steps 1 & 2 first</p>
                    </div>
                `;
                
                switchTab(0);
            }
        }
        
        function updateWeekEnd() {
            const startDate = new Date(document.getElementById('weekStart').value);
            if (startDate) {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 6);
                
                // Only auto-fill if end date is empty
                const endInput = document.getElementById('weekEnd');
                if (!endInput.value) {
                    endInput.valueAsDate = endDate;
                }
                
                // Update all game date pickers with min/max constraints
                updateGameDateConstraints();
            }
        }
        
        function updateGameDateConstraints() {
            const weekStart = document.getElementById('weekStart').value;
            const weekEnd = document.getElementById('weekEnd').value;
            
            if (weekStart && weekEnd) {
                document.querySelectorAll('.game-date').forEach(input => {
                    input.min = weekStart;
                    input.max = weekEnd;
                });
            }
        }
        
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            tabs[index].classList.add('active');
            contents[index].classList.add('active');
        }
        
        function addPitcherRow() {
            const container = document.getElementById('pitcherEntries');
            const weekStart = document.getElementById('weekStart').value;
            
            const newRow = document.createElement('div');
            newRow.className = 'pitcher-entry';
            newRow.innerHTML = `
                <div class="form-group">
                    <input type="text" class="team-name" placeholder="e.g., John's Team">
                </div>
                <div class="form-group">
                    <input type="text" class="pitcher-name" placeholder="Start typing name..." autocomplete="off">
                    <div class="search-results" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <input type="text" class="pitcher-team" placeholder="NYY" maxlength="3">
                </div>
                <div class="form-group">
                    <input type="date" class="game-date" value="${weekStart || ''}">
                </div>
                <button class="btn btn-danger" onclick="removeRow(this)">Remove</button>
            `;
            container.appendChild(newRow);
            updateGameDateConstraints();
        }
        
        function removeRow(button) {
            if (document.querySelectorAll('.pitcher-entry').length > 1) {
                button.closest('.pitcher-entry').remove();
            } else {
                alert('You must have at least one pitcher entry');
            }
        }
        
        async function fetchGameTimes() {
            console.log('üöÄ fetchGameTimes called');
            const weekStart = document.getElementById('weekStart').value;
            const weekEnd = document.getElementById('weekEnd').value;
            
            console.log('Week:', weekStart, 'to', weekEnd);
            
            if (!weekStart) {
                alert('Please select a week start date');
                return;
            }
            
            // Collect pitcher data
            pitchers = [];
            const entries = document.querySelectorAll('.pitcher-entry');
            console.log(`Found ${entries.length} pitcher entries`);
            
            entries.forEach((entry, index) => {
                const fantasyTeam = entry.querySelector('.team-name').value;
                const nameInput = entry.querySelector('.pitcher-name');
                const name = nameInput.value;
                const team = entry.querySelector('.pitcher-team').value;
                const gameDate = entry.querySelector('.game-date').value;
                const playerId = nameInput.dataset.playerId;
                
                console.log(`Entry ${index}:`, {fantasyTeam, name, team, gameDate, playerId});
                
                if (fantasyTeam && name && team && gameDate) {
                    // Include even if no playerId - we'll try to find them by name
                    pitchers.push({ fantasyTeam, name, team, gameDate, playerId: playerId || null });
                } else if (name && team && gameDate && !fantasyTeam) {
                    alert(`Please enter fantasy team name for ${name}`);
                } else if (fantasyTeam && name && team && !gameDate) {
                    alert(`Please select a game date for ${name}`);
                }
            });
            
            console.log(`‚úÖ Collected ${pitchers.length} valid pitchers`);
            
            if (pitchers.length === 0) {
                alert('Please add at least one pitcher with all fields filled (Fantasy Team, Pitcher Name, MLB Team, Game Date)');
                return;
            }
            
            // Show loading
            document.getElementById('gameTimesResults').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Fetching game times and stats from MLB Stats API...</p>
                </div>
            `;
            
            switchTab(1);
            
            // Fetch game times for each pitcher
            try {
                const allAppearances = [];
                
                for (const pitcher of pitchers) {
                    const appearance = await getGameDataForDate(pitcher.playerId, pitcher.team, pitcher.gameDate, pitcher.name);
                    
                    if (appearance) {
                        allAppearances.push({
                            ...pitcher,
                            gameTime: appearance.gameTime,
                            gameDate: new Date(appearance.gameTime),
                            gameId: appearance.gameId,
                            stats: appearance.stats,
                            type: appearance.type,
                            autoDetected: true
                        });
                    } else {
                        // No game found for this date
                        allAppearances.push({
                            ...pitcher,
                            gameTime: null,
                            gameDate: null,
                            gameId: null,
                            stats: null,
                            type: 'RP', // Default
                            autoDetected: false
                        });
                    }
                }
                
                gameTimesData = allAppearances;
                
                // Sort by game time
                gameTimesData.sort((a, b) => {
                    if (!a.gameDate) return 1;
                    if (!b.gameDate) return -1;
                    return a.gameDate - b.gameDate;
                });
                
                displayGameTimes();
                
            } catch (error) {
                document.getElementById('gameTimesResults').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Error:</strong> Could not fetch all game times. ${error.message}
                        <br><br>
                        You can manually adjust times if needed or continue with available data.
                    </div>
                `;
            }
        }
        
        async function getGameDataForDate(playerId, teamAbbr, gameDate, pitcherName = null) {
            try {
                const teamIds = {
                    'NYY': 147, 'BOS': 111, 'TOR': 141, 'TB': 139, 'BAL': 110,
                    'CLE': 114, 'MIN': 142, 'CWS': 145, 'DET': 116, 'KC': 118,
                    'HOU': 117, 'TEX': 140, 'SEA': 136, 'LAA': 108, 'OAK': 133,
                    'ATL': 144, 'NYM': 121, 'PHI': 143, 'MIA': 146, 'WSH': 120,
                    'MIL': 158, 'CHC': 112, 'STL': 138, 'PIT': 134, 'CIN': 113,
                    'LAD': 119, 'SD': 135, 'SF': 137, 'ARI': 109, 'COL': 115
                };
                
                const teamId = teamIds[teamAbbr.toUpperCase()];
                if (!teamId) {
                    console.warn(`Unknown team: ${teamAbbr}`);
                    return null;
                }
                
                // Get schedule for the specific date
                const scheduleUrl = `https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=${teamId}&startDate=${gameDate}&endDate=${gameDate}`;
                const scheduleResponse = await fetch(scheduleUrl);
                const scheduleData = await scheduleResponse.json();
                
                if (!scheduleData.dates || scheduleData.dates.length === 0) {
                    console.warn(`No game found for ${teamAbbr} on ${gameDate}`);
                    return null;
                }
                
                // Check all games on this date (doubleheaders)
                for (const date of scheduleData.dates) {
                    for (const game of date.games) {
                        if (game.gamePk) {
                            try {
                                // Get game stats
                                const gameUrl = `https://statsapi.mlb.com/api/v1/game/${game.gamePk}/boxscore`;
                                const gameResponse = await fetch(gameUrl);
                                const gameData = await gameResponse.json();
                                
                                // Check both teams for the pitcher
                                const homeTeam = gameData.teams.home;
                                const awayTeam = gameData.teams.away;
                                
                                let pitcherData = null;
                                let isHomeTeam = false;
                                let foundPlayerId = playerId;
                                
                                // Helper function to check if pitcher matches
                                const matchesPitcher = (player) => {
                                    if (playerId && player.person.id == playerId) return true;
                                    if (pitcherName && player.person.fullName.toLowerCase().includes(pitcherName.toLowerCase())) return true;
                                    if (pitcherName && pitcherName.toLowerCase().includes(player.person.fullName.toLowerCase())) return true;
                                    return false;
                                };
                                
                                // Check home team pitchers
                                if (homeTeam.players) {
                                    for (const [key, player] of Object.entries(homeTeam.players)) {
                                        if (matchesPitcher(player) && player.stats && player.stats.pitching) {
                                            // Include if they have any pitching stats (even 0 IP - they appeared)
                                            const stats = player.stats.pitching;
                                            const pitched = stats.battersFaced > 0 || 
                                                          parseFloat(stats.inningsPitched || 0) > 0 ||
                                                          stats.hits > 0 || stats.runs > 0 || stats.earnedRuns > 0 ||
                                                          stats.strikeOuts > 0 || stats.baseOnBalls > 0;
                                            
                                            if (pitched) {
                                                pitcherData = player;
                                                isHomeTeam = true;
                                                foundPlayerId = player.person.id;
                                                break;
                                            }
                                        }
                                    }
                                }
                                
                                // Check away team pitchers if not found
                                if (!pitcherData && awayTeam.players) {
                                    for (const [key, player] of Object.entries(awayTeam.players)) {
                                        if (matchesPitcher(player) && player.stats && player.stats.pitching) {
                                            // Include if they have any pitching stats (even 0 IP - they appeared)
                                            const stats = player.stats.pitching;
                                            const pitched = stats.battersFaced > 0 || 
                                                          parseFloat(stats.inningsPitched || 0) > 0 ||
                                                          stats.hits > 0 || stats.runs > 0 || stats.earnedRuns > 0 ||
                                                          stats.strikeOuts > 0 || stats.baseOnBalls > 0;
                                            
                                            if (pitched) {
                                                pitcherData = player;
                                                isHomeTeam = false;
                                                foundPlayerId = player.person.id;
                                                break;
                                            }
                                        }
                                    }
                                }
                                
                                if (pitcherData && pitcherData.stats.pitching) {
                                    // Determine if this was a start or relief appearance
                                    const teamData = isHomeTeam ? homeTeam : awayTeam;
                                    const startingPitcherId = teamData.pitchers && teamData.pitchers.length > 0 
                                        ? teamData.pitchers[0] 
                                        : null;
                                    
                                    const isStart = startingPitcherId == foundPlayerId;
                                    const appearanceType = isStart ? 'SP' : 'RP';
                                    
                                    return {
                                        gameTime: game.gameDate,
                                        gameId: game.gamePk,
                                        stats: pitcherData.stats.pitching,
                                        type: appearanceType,
                                        isStart: isStart,
                                        playerId: foundPlayerId
                                    };
                                }
                            } catch (gameError) {
                                console.error(`Error fetching game ${game.gamePk}:`, gameError);
                            }
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error(`Error fetching game for ${teamAbbr} on ${gameDate}:`, error);
                return null;
            }
        }
        
        function displayGameTimes() {
            const maxStarts = parseInt(document.getElementById('maxStarts').value) || 7;
            const maxReliefApp = parseInt(document.getElementById('maxReliefApp').value) || 10;
            
            // Group appearances by fantasy team
            const teamGroups = {};
            gameTimesData.forEach((pitcher) => {
                if (!teamGroups[pitcher.fantasyTeam]) {
                    teamGroups[pitcher.fantasyTeam] = [];
                }
                teamGroups[pitcher.fantasyTeam].push(pitcher);
            });
            
            // Sort each team's appearances chronologically
            Object.keys(teamGroups).forEach(team => {
                teamGroups[team].sort((a, b) => {
                    if (!a.gameDate) return 1;
                    if (!b.gameDate) return -1;
                    return a.gameDate - b.gameDate;
                });
            });
            
            let html = `
                <div class="summary-card">
                    <h3>Pitcher Usage by Team (Chronological Order)</h3>
                    <p>Limits: ${maxStarts} Starts (SP) | ${maxReliefApp} Relief Appearances (RP)</p>
                    <p style="font-size: 13px; opacity: 0.9; margin-top: 5px;">Click on a team to expand/collapse details</p>
                </div>
            `;
            
            // Create expandable section for each team
            Object.keys(teamGroups).sort().forEach((fantasyTeam, teamIndex) => {
                const teamPitchers = teamGroups[fantasyTeam];
                let spCount = 0;
                let rpCount = 0;
                
                // Count SP and RP for this team
                teamPitchers.forEach(pitcher => {
                    if (pitcher.type === 'SP') spCount++;
                    else rpCount++;
                });
                
                const overSP = spCount > maxStarts;
                const overRP = rpCount > maxReliefApp;
                const hasOverage = overSP || overRP;
                
                html += `
                    <div style="background: #f9fafb; border-radius: 8px; margin-bottom: 15px; overflow: hidden; border: 2px solid ${hasOverage ? '#f59e0b' : '#e5e7eb'};">
                        <div onclick="toggleTeam(${teamIndex})" style="padding: 20px; cursor: pointer; background: ${hasOverage ? '#fffbeb' : 'white'}; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 18px; color: #1f2937;">
                                    ${fantasyTeam}
                                    ${hasOverage ? '<span style="color: #f59e0b; font-size: 14px; margin-left: 10px;">‚ö†Ô∏è OVERAGE</span>' : ''}
                                </h3>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 5px;">
                                    SP: ${spCount}/${maxStarts} ${overSP ? '(OVER)' : ''} | 
                                    RP: ${rpCount}/${maxReliefApp} ${overRP ? '(OVER)' : ''} | 
                                    ${teamPitchers.length} total appearances
                                </div>
                            </div>
                            <div style="font-size: 24px; color: #9ca3af;" id="arrow-${teamIndex}">‚ñº</div>
                        </div>
                        
                        <div id="team-${teamIndex}" style="display: block;">
                            <table class="results-table" style="margin: 0;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Pitcher</th>
                                        <th>MLB Team</th>
                                        <th>Type</th>
                                        <th>Game Time (ET)</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                let teamSP = 0;
                let teamRP = 0;
                
                teamPitchers.forEach((pitcher, index) => {
                    let status = '';
                    let rowClass = '';
                    
                    if (pitcher.type === 'SP') {
                        teamSP++;
                        if (teamSP <= maxStarts) {
                            status = `‚úì Counts (SP ${teamSP}/${maxStarts})`;
                            rowClass = 'counted';
                        } else {
                            status = `‚úó Excluded (Over SP limit)`;
                            rowClass = 'excluded';
                        }
                    } else {
                        teamRP++;
                        if (teamRP <= maxReliefApp) {
                            status = `‚úì Counts (RP ${teamRP}/${maxReliefApp})`;
                            rowClass = 'counted';
                        } else {
                            status = `‚úó Excluded (Over RP limit)`;
                            rowClass = 'excluded';
                        }
                    }
                    
                    const timeStr = pitcher.gameDate ? 
                        pitcher.gameDate.toLocaleString('en-US', { 
                            weekday: 'short',
                            month: 'short', 
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit',
                            timeZone: 'America/New_York'
                        }) : new Date(pitcher.gameDate).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric'
                        });
                    
                    const typeDisplay = pitcher.autoDetected 
                        ? `${pitcher.type} <span style="font-size: 11px; color: #10b981;">‚óè</span>` 
                        : `${pitcher.type} <span style="font-size: 11px; color: #6b7280;">‚óã</span>`;
                    
                    html += `
                        <tr class="${rowClass}">
                            <td>${index + 1}</td>
                            <td><strong>${pitcher.name}</strong></td>
                            <td>${pitcher.team}</td>
                            <td>${typeDisplay}</td>
                            <td>${timeStr}</td>
                            <td>${status}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                            <div style="padding: 15px; font-size: 12px; color: #6b7280; background: white;">
                                <span style="color: #10b981;">‚óè</span> = Auto-detected from game data &nbsp;&nbsp;
                                <span style="color: #6b7280;">‚óã</span> = Manual selection
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-primary btn-lg" onclick="switchTab(2)" style="padding: 15px 40px; font-size: 16px;">
                        Continue to Stats Entry ‚Üí
                    </button>
                </div>
            `;
            
            document.getElementById('gameTimesResults').innerHTML = html;
        }
        
        function toggleTeam(teamIndex) {
            const content = document.getElementById(`team-${teamIndex}`);
            const arrow = document.getElementById(`arrow-${teamIndex}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                arrow.textContent = '‚ñ∂';
            }
        }
        
        switchTab(2); // Prepare stats tab when game times are ready
        
        function createStatsInputs() {
            const maxStarts = parseInt(document.getElementById('maxStarts').value) || 7;
            const maxReliefApp = parseInt(document.getElementById('maxReliefApp').value) || 10;
            
            // Group appearances by fantasy team, then by pitcher
            const teamGroups = {};
            
            gameTimesData.forEach((appearance, index) => {
                if (!teamGroups[appearance.fantasyTeam]) {
                    teamGroups[appearance.fantasyTeam] = {
                        appearances: [],
                        pitcherGroups: {}
                    };
                }
                
                teamGroups[appearance.fantasyTeam].appearances.push({...appearance, globalIndex: index});
            });
            
            // For each team, calculate counts and group by pitcher
            Object.keys(teamGroups).forEach(fantasyTeam => {
                const teamData = teamGroups[fantasyTeam];
                
                // Sort chronologically
                teamData.appearances.sort((a, b) => {
                    if (!a.gameDate) return 1;
                    if (!b.gameDate) return -1;
                    return a.gameDate - b.gameDate;
                });
                
                // Calculate which count
                let spCount = 0;
                let rpCount = 0;
                
                teamData.appearances.forEach(appearance => {
                    if (appearance.type === 'SP') {
                        spCount++;
                        appearance.counts = spCount <= maxStarts;
                        appearance.spCount = spCount;
                    } else {
                        rpCount++;
                        appearance.counts = rpCount <= maxReliefApp;
                        appearance.rpCount = rpCount;
                    }
                    
                    // Group by pitcher
                    const key = `${appearance.name}-${appearance.playerId}`;
                    if (!teamData.pitcherGroups[key]) {
                        teamData.pitcherGroups[key] = {
                            name: appearance.name,
                            team: appearance.team,
                            appearances: []
                        };
                    }
                    teamData.pitcherGroups[key].appearances.push(appearance);
                });
            });
            
            let html = `
                <div class="summary-card">
                    <h3>Enter Pitcher Stats by Team</h3>
                    <p>Stats automatically populated from MLB API. Click on a team to expand/collapse.</p>
                </div>
            `;
            
            let globalGroupIndex = 0;
            
            // Create expandable sections for each team
            Object.keys(teamGroups).sort().forEach((fantasyTeam, teamIndex) => {
                const teamData = teamGroups[fantasyTeam];
                const pitcherCount = Object.keys(teamData.pitcherGroups).length;
                
                html += `
                    <div style="background: #f9fafb; border-radius: 8px; margin-bottom: 15px; overflow: hidden; border: 2px solid #667eea;">
                        <div onclick="toggleStatsTeam(${teamIndex})" style="padding: 20px; cursor: pointer; background: white; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 18px; color: #1f2937;">${fantasyTeam}</h3>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 5px;">${pitcherCount} pitcher${pitcherCount > 1 ? 's' : ''}, ${teamData.appearances.length} appearances</div>
                            </div>
                            <div style="font-size: 24px; color: #9ca3af;" id="stats-arrow-${teamIndex}">‚ñº</div>
                        </div>
                        
                        <div id="stats-team-${teamIndex}" style="display: block; padding: 20px; padding-top: 0;">
                `;
                
                // Add pitchers for this team
                Object.values(teamData.pitcherGroups).forEach(pitcher => {
                    const countedAppearances = pitcher.appearances.filter(a => a.counts);
                    const excludedAppearances = pitcher.appearances.filter(a => !a.counts);
                    
                    const allCount = countedAppearances.length === pitcher.appearances.length;
                    const noneCount = countedAppearances.length === 0;
                    
                    let statusText = '';
                    let borderColor = '';
                    if (allCount) {
                        statusText = `‚úì ALL ${pitcher.appearances.length} APPEARANCE${pitcher.appearances.length > 1 ? 'S' : ''} COUNT`;
                        borderColor = '#10b981';
                    } else if (noneCount) {
                        statusText = `‚úó ALL ${pitcher.appearances.length} APPEARANCE${pitcher.appearances.length > 1 ? 'S' : ''} EXCLUDED`;
                        borderColor = '#ef4444';
                    } else {
                        statusText = `‚ö† ${countedAppearances.length} of ${pitcher.appearances.length} APPEARANCES COUNT`;
                        borderColor = '#f59e0b';
                    }
                    
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid ${borderColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0;">${pitcher.name} (${pitcher.team}) - ${pitcher.appearances.length} Appearance${pitcher.appearances.length > 1 ? 's' : ''}</h4>
                                <span style="padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 12px; background: ${allCount ? '#d1fae5' : noneCount ? '#fee2e2' : '#fef3c7'}; color: ${allCount ? '#065f46' : noneCount ? '#991b1b' : '#92400e'};">${statusText}</span>
                            </div>
                    `;
                    
                    // Show breakdown if multiple appearances
                    if (pitcher.appearances.length > 1) {
                        html += `<div style="font-size: 12px; color: #6b7280; margin-bottom: 15px; background: #f9fafb; padding: 10px; border-radius: 4px;">`;
                        pitcher.appearances.forEach(app => {
                            const date = new Date(app.gameTime).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            const countLabel = app.type === 'SP' ? `SP ${app.spCount}/${maxStarts}` : `RP ${app.rpCount}/${maxReliefApp}`;
                            const icon = app.counts ? '‚úì' : '‚úó';
                            const color = app.counts ? '#10b981' : '#ef4444';
                            html += `<div style="margin: 5px 0;"><span style="color: ${color};">${icon}</span> ${date} - ${app.type} (${countLabel})</div>`;
                        });
                        html += `</div>`;
                    }
                    
                    // Combined stats input
                    html += `
                            <div class="stat-input" id="stats-group-${globalGroupIndex}">
                                <div class="form-group">
                                    <label>IP</label>
                                    <input type="number" step="0.1" class="stat-ip" data-group="${globalGroupIndex}" value="${getCombinedStat(pitcher.appearances, 'inningsPitched')}">
                                </div>
                                <div class="form-group">
                                    <label>ER</label>
                                    <input type="number" class="stat-er" data-group="${globalGroupIndex}" value="${getCombinedStat(pitcher.appearances, 'earnedRuns')}">
                                </div>
                                <div class="form-group">
                                    <label>K</label>
                                    <input type="number" class="stat-k" data-group="${globalGroupIndex}" value="${getCombinedStat(pitcher.appearances, 'strikeOuts')}">
                                </div>
                                <div class="form-group">
                                    <label>BB</label>
                                    <input type="number" class="stat-bb" data-group="${globalGroupIndex}" value="${getCombinedStat(pitcher.appearances, 'baseOnBalls')}">
                                </div>
                                <div class="form-group">
                                    <label>H</label>
                                    <input type="number" class="stat-h" data-group="${globalGroupIndex}" value="${getCombinedStat(pitcher.appearances, 'hits')}">
                                </div>
                                <div class="form-group">
                                    <label>HB</label>
                                    <input type="number" class="stat-hb" data-group="${globalGroupIndex}" value="${getCombinedStat(pitcher.appearances, 'hitBatsmen')}">
                                </div>
                                <div class="form-group">
                                    <label>QS</label>
                                    <input type="number" class="stat-qs" data-group="${globalGroupIndex}" value="${getCombinedQS(pitcher.appearances)}" max="${pitcher.appearances.length}">
                                </div>
                                <div class="form-group">
                                    <label>SV</label>
                                    <input type="number" class="stat-sv" data-group="${globalGroupIndex}" value="${getCombinedStat(pitcher.appearances, 'saves')}">
                                </div>
                                <div class="form-group">
                                    <label>HLD</label>
                                    <input type="number" class="stat-hld" data-group="${globalGroupIndex}" value="${getCombinedStat(pitcher.appearances, 'holds')}">
                                </div>
                            </div>
                            <input type="hidden" class="pitcher-metadata" data-group="${globalGroupIndex}" data-team="${fantasyTeam}" value='${JSON.stringify(pitcher)}'>
                        </div>
                    `;
                    
                    globalGroupIndex++;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `
                <button class="btn btn-success btn-lg" onclick="calculateTotals()" style="width: 100%; padding: 15px; font-size: 16px;">
                    Calculate Corrected Totals for All Teams
                </button>
                <div id="finalResults" style="margin-top: 30px;"></div>
            `;
            
            document.getElementById('statsResults').innerHTML = html;
        }
        
        function toggleStatsTeam(teamIndex) {
            const content = document.getElementById(`stats-team-${teamIndex}`);
            const arrow = document.getElementById(`stats-arrow-${teamIndex}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                arrow.textContent = '‚ñ∂';
            }
        }
                
                pitcherGroups[key].appearances.push({
                    ...appearance,
                    index: index,
                    counts: counts,
                    spCount: appearance.type === 'SP' ? spCount : null,
                    rpCount: appearance.type === 'RP' ? rpCount : null
                });
            });
            
            let html = `
                <div class="summary-card">
                    <h3>${teamName} - Pitcher Stats</h3>
                    <p>Stats automatically populated from MLB API. Multiple appearances are combined with notes showing which count toward limits.</p>
                </div>
            `;
            
            Object.values(pitcherGroups).forEach((pitcher, groupIndex) => {
                const countedAppearances = pitcher.appearances.filter(a => a.counts);
                const excludedAppearances = pitcher.appearances.filter(a => !a.counts);
                
                const allCount = countedAppearances.length === pitcher.appearances.length;
                const noneCount = countedAppearances.length === 0;
                const someCount = !allCount && !noneCount;
                
                let statusText = '';
                let borderColor = '';
                if (allCount) {
                    statusText = `‚úì ALL ${pitcher.appearances.length} APPEARANCE${pitcher.appearances.length > 1 ? 'S' : ''} COUNT`;
                    borderColor = '#10b981';
                } else if (noneCount) {
                    statusText = `‚úó ALL ${pitcher.appearances.length} APPEARANCE${pitcher.appearances.length > 1 ? 'S' : ''} EXCLUDED`;
                    borderColor = '#ef4444';
                } else {
                    statusText = `‚ö† ${countedAppearances.length} of ${pitcher.appearances.length} APPEARANCES COUNT`;
                    borderColor = '#f59e0b';
                }
                
                html += `
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid ${borderColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0;">${pitcher.name} (${pitcher.team}) - ${pitcher.appearances.length} Appearance${pitcher.appearances.length > 1 ? 's' : ''}</h4>
                            <span style="padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 12px; background: ${allCount ? '#d1fae5' : noneCount ? '#fee2e2' : '#fef3c7'}; color: ${allCount ? '#065f46' : noneCount ? '#991b1b' : '#92400e'};">${statusText}</span>
                        </div>
                `;
                
                // Show breakdown if multiple appearances
                if (pitcher.appearances.length > 1) {
                    html += `<div style="font-size: 12px; color: #6b7280; margin-bottom: 15px; background: white; padding: 10px; border-radius: 4px;">`;
                    pitcher.appearances.forEach(app => {
                        const date = new Date(app.gameTime).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const countLabel = app.type === 'SP' ? `SP ${app.spCount}/7` : `RP ${app.rpCount}/10`;
                        const icon = app.counts ? '‚úì' : '‚úó';
                        const color = app.counts ? '#10b981' : '#ef4444';
                        html += `<div style="margin: 5px 0;"><span style="color: ${color};">${icon}</span> ${date} - ${app.type} (${countLabel})</div>`;
                    });
                    html += `</div>`;
                }
                
                // Combined stats input
                html += `
                        <div class="stat-input" id="stats-group-${groupIndex}">
                            <div class="form-group">
                                <label>IP</label>
                                <input type="number" step="0.1" class="stat-ip" data-group="${groupIndex}" value="${getCombinedStat(pitcher.appearances, 'inningsPitched')}">
                            </div>
                            <div class="form-group">
                                <label>ER</label>
                                <input type="number" class="stat-er" data-group="${groupIndex}" value="${getCombinedStat(pitcher.appearances, 'earnedRuns')}">
                            </div>
                            <div class="form-group">
                                <label>K</label>
                                <input type="number" class="stat-k" data-group="${groupIndex}" value="${getCombinedStat(pitcher.appearances, 'strikeOuts')}">
                            </div>
                            <div class="form-group">
                                <label>BB</label>
                                <input type="number" class="stat-bb" data-group="${groupIndex}" value="${getCombinedStat(pitcher.appearances, 'baseOnBalls')}">
                            </div>
                            <div class="form-group">
                                <label>H</label>
                                <input type="number" class="stat-h" data-group="${groupIndex}" value="${getCombinedStat(pitcher.appearances, 'hits')}">
                            </div>
                            <div class="form-group">
                                <label>HB</label>
                                <input type="number" class="stat-hb" data-group="${groupIndex}" value="${getCombinedStat(pitcher.appearances, 'hitBatsmen')}">
                            </div>
                            <div class="form-group">
                                <label>QS</label>
                                <input type="number" class="stat-qs" data-group="${groupIndex}" value="${getCombinedQS(pitcher.appearances)}" max="${pitcher.appearances.length}">
                            </div>
                            <div class="form-group">
                                <label>SV</label>
                                <input type="number" class="stat-sv" data-group="${groupIndex}" value="${getCombinedStat(pitcher.appearances, 'saves')}">
                            </div>
                            <div class="form-group">
                                <label>HLD</label>
                                <input type="number" class="stat-hld" data-group="${groupIndex}" value="${getCombinedStat(pitcher.appearances, 'holds')}">
                            </div>
                        </div>
                `;
                
                // Store metadata for calculation
                html += `<input type="hidden" class="pitcher-metadata" data-group="${groupIndex}" value='${JSON.stringify(pitcher)}'>`;
                
                html += `</div>`;
            });
            
            html += `
                <button class="btn btn-success btn-lg" onclick="calculateTotals()" style="width: 100%; padding: 15px; font-size: 16px;">
                    Calculate Corrected Totals
                </button>
                <div id="finalResults" style="margin-top: 30px;"></div>
            `;
            
            document.getElementById('statsResults').innerHTML = html;
        }
        
        function getCombinedStat(appearances, statName) {
            let total = 0;
            appearances.forEach(app => {
                if (app.stats && app.stats[statName]) {
                    total += parseFloat(app.stats[statName]) || 0;
                }
            });
            return total || 0;
        }
        
        function getCombinedQS(appearances) {
            let total = 0;
            appearances.forEach(app => {
                if (app.stats) {
                    const ip = parseFloat(app.stats.inningsPitched) || 0;
                    const er = parseFloat(app.stats.earnedRuns) || 0;
                    if (ip >= 6 && er <= 3) total++;
                }
            });
            return total;
        }
        
        function parseIPValue(ipString) {
            // Convert baseball IP notation to actual innings
            // 5.1 = 5 and 1/3 innings = 5.333...
            // 5.2 = 5 and 2/3 innings = 5.666...
            // 5.0 or 5 = 5 innings
            
            if (!ipString) return 0;
            
            const ipFloat = parseFloat(ipString);
            const wholeInnings = Math.floor(ipFloat);
            const fraction = Math.round((ipFloat - wholeInnings) * 10); // Get the .1 or .2
            
            // Convert to actual decimal
            if (fraction === 1) {
                return wholeInnings + (1/3);
            } else if (fraction === 2) {
                return wholeInnings + (2/3);
            } else {
                return wholeInnings;
            }
        }
        
        function calculateTotals() {
            const scoringRules = {
                IP: 1.5,
                ER: -2,
                K: 0.75,
                BB: -0.25,
                H: -0.25,
                HB: -0.25,
                QS: 1,
                SV: 1,
                HLD: 1
            };
            
            let totalPoints = 0;
            let pitcherBreakdowns = [];
            
            // Get all pitcher groups
            const metadataElements = document.querySelectorAll('.pitcher-metadata');
            
            metadataElements.forEach((metaElement) => {
                const groupIndex = metaElement.dataset.group;
                const pitcherData = JSON.parse(metaElement.value);
                
                // Get input values
                const ipRaw = document.querySelector(`input.stat-ip[data-group="${groupIndex}"]`).value;
                const ip = parseIPValue(ipRaw);
                const er = parseFloat(document.querySelector(`input.stat-er[data-group="${groupIndex}"]`).value) || 0;
                const k = parseFloat(document.querySelector(`input.stat-k[data-group="${groupIndex}"]`).value) || 0;
                const bb = parseFloat(document.querySelector(`input.stat-bb[data-group="${groupIndex}"]`).value) || 0;
                const h = parseFloat(document.querySelector(`input.stat-h[data-group="${groupIndex}"]`).value) || 0;
                const hb = parseFloat(document.querySelector(`input.stat-hb[data-group="${groupIndex}"]`).value) || 0;
                const qs = parseFloat(document.querySelector(`input.stat-qs[data-group="${groupIndex}"]`).value) || 0;
                const sv = parseFloat(document.querySelector(`input.stat-sv[data-group="${groupIndex}"]`).value) || 0;
                const hld = parseFloat(document.querySelector(`input.stat-hld[data-group="${groupIndex}"]`).value) || 0;
                
                // Calculate total points
                const totalPts = (ip * scoringRules.IP) + 
                             (er * scoringRules.ER) + 
                             (k * scoringRules.K) + 
                             (bb * scoringRules.BB) + 
                             (h * scoringRules.H) + 
                             (hb * scoringRules.HB) + 
                             (qs * scoringRules.QS) + 
                             (sv * scoringRules.SV) + 
                             (hld * scoringRules.HLD);
                
                const countedAppearances = pitcherData.appearances.filter(a => a.counts);
                const excludedAppearances = pitcherData.appearances.filter(a => !a.counts);
                
                // Calculate points for counted vs excluded if there's a mix
                let countedPoints = totalPts;
                let excludedPoints = 0;
                let explanation = '';
                
                if (countedAppearances.length > 0 && excludedAppearances.length > 0) {
                    // Proportional split based on IP (or appearances if no IP data)
                    const countedIP = countedAppearances.reduce((sum, app) => 
                        sum + (parseFloat(app.stats?.inningsPitched) || 0), 0);
                    const excludedIP = excludedAppearances.reduce((sum, app) => 
                        sum + (parseFloat(app.stats?.inningsPitched) || 0), 0);
                    
                    if (countedIP + excludedIP > 0) {
                        const countedRatio = countedIP / (countedIP + excludedIP);
                        countedPoints = totalPts * countedRatio;
                        excludedPoints = totalPts * (1 - countedRatio);
                        
                        explanation = `${countedAppearances.length} appearance${countedAppearances.length > 1 ? 's' : ''} counted (${countedIP.toFixed(1)} IP), ${excludedAppearances.length} excluded (${excludedIP.toFixed(1)} IP). Points split proportionally: ${countedPoints.toFixed(2)} counted + ${excludedPoints.toFixed(2)} excluded = ${totalPts.toFixed(2)} total.`;
                    } else {
                        // Fallback to even split if no IP data
                        countedPoints = totalPts * (countedAppearances.length / pitcherData.appearances.length);
                        excludedPoints = totalPts * (excludedAppearances.length / pitcherData.appearances.length);
                        
                        explanation = `${countedAppearances.length} of ${pitcherData.appearances.length} appearances counted. Points split evenly: ${countedPoints.toFixed(2)} counted + ${excludedPoints.toFixed(2)} excluded = ${totalPts.toFixed(2)} total.`;
                    }
                } else if (countedAppearances.length === 0) {
                    countedPoints = 0;
                    excludedPoints = totalPts;
                    explanation = `All ${pitcherData.appearances.length} appearance${pitcherData.appearances.length > 1 ? 's' : ''} exceeded limits. 0 points awarded.`;
                } else {
                    explanation = `All ${pitcherData.appearances.length} appearance${pitcherData.appearances.length > 1 ? 's' : ''} counted. ${totalPts.toFixed(2)} points awarded.`;
                }
                
                totalPoints += countedPoints;
                
                const fantasyTeam = metaElement.dataset.team;
                
                pitcherBreakdowns.push({
                    name: pitcherData.name,
                    fantasyTeam: fantasyTeam,
                    totalAppearances: pitcherData.appearances.length,
                    countedAppearances: countedAppearances.length,
                    countedPoints: countedPoints,
                    excludedPoints: excludedPoints,
                    totalPts: totalPts,
                    explanation: explanation,
                    stats: { ipRaw, ip, er, k, bb, h, hb, qs, sv, hld }
                });
            });
            
            // Group by fantasy team
            const teamResults = {};
            pitcherBreakdowns.forEach(p => {
                if (!teamResults[p.fantasyTeam]) {
                    teamResults[p.fantasyTeam] = {
                        pitchers: [],
                        totalPoints: 0
                    };
                }
                teamResults[p.fantasyTeam].pitchers.push(p);
                teamResults[p.fantasyTeam].totalPoints += p.countedPoints;
            });
            
            const weekStart = document.getElementById('weekStart').value;
            const weekEnd = document.getElementById('weekEnd').value;
            const startDate = new Date(weekStart);
            const endDate = new Date(weekEnd);
            const dateRange = `${startDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - ${endDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
            
            let html = `
                <div class="summary-card">
                    <h3>üìä Corrected Totals - ${dateRange}</h3>
                    <div class="summary-stats">
                        <div class="stat-box">
                            <div class="label">Teams with Overages</div>
                            <div class="value">${Object.keys(teamResults).length}</div>
                        </div>
                        <div class="stat-box">
                            <div class="label">Total Pitchers</div>
                            <div class="value">${pitcherBreakdowns.length}</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-success" onclick="exportToCSV()" style="padding: 12px 30px; font-size: 15px;">
                            üìä Export Full Report to CSV
                        </button>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 8px;">Download detailed breakdown for all teams</p>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 10px;">Results by Team:</h4>
            `;
            
            // Display results grouped by team
            Object.keys(teamResults).sort().forEach((fantasyTeam, teamIndex) => {
                const teamData = teamResults[fantasyTeam];
                
                html += `
                    <div style="background: #f9fafb; border-radius: 8px; margin-bottom: 20px; overflow: hidden; border: 2px solid #667eea;">
                        <div onclick="toggleResultsTeam(${teamIndex})" style="padding: 20px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; font-size: 18px;">${fantasyTeam}</h3>
                                <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">${teamData.pitchers.length} pitcher${teamData.pitchers.length > 1 ? 's' : ''} | ${teamData.totalPoints.toFixed(2)} corrected points</div>
                            </div>
                            <div style="font-size: 24px;" id="results-arrow-${teamIndex}">‚ñº</div>
                        </div>
                        
                        <div id="results-team-${teamIndex}" style="display: block; padding: 20px; padding-top: 0;">
                `;
                
                teamData.pitchers.forEach(p => {
                    const borderColor = p.countedPoints === 0 ? '#ef4444' : 
                                       p.excludedPoints > 0 ? '#f59e0b' : '#10b981';
                    
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid ${borderColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <strong style="font-size: 16px;">${p.name}</strong>
                                    <div style="font-size: 13px; color: #6b7280; margin-top: 3px;">
                                        IP: ${p.stats.ipRaw} | ER: ${p.stats.er} | K: ${p.stats.k} | BB: ${p.stats.bb} | H: ${p.stats.h}
                                        ${p.stats.qs > 0 ? ` | QS: ${p.stats.qs}` : ''}
                                        ${p.stats.sv > 0 ? ` | SV: ${p.stats.sv}` : ''}
                                        ${p.stats.hld > 0 ? ` | HLD: ${p.stats.hld}` : ''}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-weight: 700; color: ${borderColor};">
                                        ${p.countedPoints.toFixed(2)} pts
                                    </div>
                                    ${p.excludedPoints > 0 ? `<div style="font-size: 11px; color: #6b7280;">(${p.excludedPoints.toFixed(2)} excluded)</div>` : ''}
                                </div>
                            </div>
                            <div style="font-size: 12px; color: #6b7280; background: #f9fafb; padding: 8px; border-radius: 4px;">
                                ${p.explanation}
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
                            <div>
                                <strong style="font-size: 16px;">${p.name}</strong>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 3px;">
                                    IP: ${p.stats.ipRaw} | ER: ${p.stats.er} | K: ${p.stats.k} | BB: ${p.stats.bb} | H: ${p.stats.h}
                                    ${p.stats.qs > 0 ? ` | QS: ${p.stats.qs}` : ''}
                                    ${p.stats.sv > 0 ? ` | SV: ${p.stats.sv}` : ''}
                                    ${p.stats.hld > 0 ? ` | HLD: ${p.stats.hld}` : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: 700; color: ${borderColor};">
                                    ${p.countedPoints.toFixed(2)} pts
                                </div>
                                ${p.excludedPoints > 0 ? `<div style="font-size: 11px; color: #6b7280;">(${p.excludedPoints.toFixed(2)} excluded)</div>` : ''}
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; background: white; padding: 8px; border-radius: 4px;">
                            ${p.explanation}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('finalResults').innerHTML = html;
            document.getElementById('finalResults').scrollIntoView({ behavior: 'smooth' });
        }
        
        function toggleResultsTeam(teamIndex) {
            const content = document.getElementById(`results-team-${teamIndex}`);
            const arrow = document.getElementById(`results-arrow-${teamIndex}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                arrow.textContent = '‚ñ∂';
            }
        }
        
        function exportToCSV() {
            const weekStart = document.getElementById('weekStart').value;
            const weekEnd = document.getElementById('weekEnd').value;
            
            // Format dates for filename
            const startDate = new Date(weekStart);
            const endDate = new Date(weekEnd);
            const dateRange = `${startDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}-${endDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
            const filename = `Pitcher_Overages_${dateRange.replace(/[^a-z0-9]/gi, '_')}.csv`;
            
            // Get all pitcher groups
            const metadataElements = document.querySelectorAll('.pitcher-metadata');
            const maxStarts = parseInt(document.getElementById('maxStarts').value) || 7;
            const maxReliefApp = parseInt(document.getElementById('maxReliefApp').value) || 10;
            
            // CSV Headers
            let csv = 'Matchup Period,Max Starts,Max Relief Appearances\n';
            csv += `"${weekStart} to ${weekEnd}",${maxStarts},${maxReliefApp}\n\n`;
            
            csv += 'Fantasy Team,Pitcher,Game Date,Game Time,Type,Status,IP,ER,K,BB,H,HB,QS,SV,HLD,Points\n';
            
            // Add each appearance
            gameTimesData.forEach((pitcher, index) => {
                let spCount = gameTimesData.slice(0, index + 1).filter(p => p.type === 'SP').length;
                let rpCount = gameTimesData.slice(0, index + 1).filter(p => p.type === 'RP').length;
                
                let counts = false;
                if (pitcher.type === 'SP' && spCount <= maxStarts) counts = true;
                if (pitcher.type === 'RP' && rpCount <= maxReliefApp) counts = true;
                
                const status = counts ? 'COUNTS' : 'EXCLUDED';
                const gameDate = pitcher.gameDate ? pitcher.gameDate.toLocaleDateString('en-US') : 'N/A';
                const gameTime = pitcher.gameDate ? pitcher.gameDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : 'N/A';
                
                const stats = pitcher.stats || {};
                const ip = stats.inningsPitched || 0;
                const er = stats.earnedRuns || 0;
                const k = stats.strikeOuts || 0;
                const bb = stats.baseOnBalls || 0;
                const h = stats.hits || 0;
                const hb = stats.hitBatsmen || 0;
                const qs = (parseFloat(ip) >= 6 && er <= 3) ? 1 : 0;
                const sv = stats.saves || 0;
                const hld = stats.holds || 0;
                
                // Calculate points for this appearance
                const ipParsed = parseIPValue(ip.toString());
                const points = (ipParsed * 1.5) + (er * -2) + (k * 0.75) + (bb * -0.25) + (h * -0.25) + (hb * -0.25) + (qs * 1) + (sv * 1) + (hld * 1);
                
                csv += `"${pitcher.fantasyTeam}","${pitcher.name}","${gameDate}","${gameTime}","${pitcher.type}","${status}",${ip},${er},${k},${bb},${h},${hb},${qs},${sv},${hld},${counts ? points.toFixed(2) : 0}\n`;
            });
            
            // Add summary section
            csv += '\n';
            csv += 'Summary by Team and Pitcher\n';
            csv += 'Fantasy Team,Pitcher,Total Appearances,Counted Appearances,Total Points (Counted Only),Notes\n';
            
            metadataElements.forEach((metaElement) => {
                const groupIndex = metaElement.dataset.group;
                const pitcherData = JSON.parse(metaElement.value);
                
                const ipRaw = document.querySelector(`input.stat-ip[data-group="${groupIndex}"]`).value;
                const ip = parseIPValue(ipRaw);
                const er = parseFloat(document.querySelector(`input.stat-er[data-group="${groupIndex}"]`).value) || 0;
                const k = parseFloat(document.querySelector(`input.stat-k[data-group="${groupIndex}"]`).value) || 0;
                const bb = parseFloat(document.querySelector(`input.stat-bb[data-group="${groupIndex}"]`).value) || 0;
                const h = parseFloat(document.querySelector(`input.stat-h[data-group="${groupIndex}"]`).value) || 0;
                const hb = parseFloat(document.querySelector(`input.stat-hb[data-group="${groupIndex}"]`).value) || 0;
                const qs = parseFloat(document.querySelector(`input.stat-qs[data-group="${groupIndex}"]`).value) || 0;
                const sv = parseFloat(document.querySelector(`input.stat-sv[data-group="${groupIndex}"]`).value) || 0;
                const hld = parseFloat(document.querySelector(`input.stat-hld[data-group="${groupIndex}"]`).value) || 0;
                
                const totalPts = (ip * 1.5) + (er * -2) + (k * 0.75) + (bb * -0.25) + (h * -0.25) + (hb * -0.25) + (qs * 1) + (sv * 1) + (hld * 1);
                const countedAppearances = pitcherData.appearances.filter(a => a.counts);
                const excludedAppearances = pitcherData.appearances.filter(a => !a.counts);
                
                let countedPoints = totalPts;
                if (countedAppearances.length > 0 && excludedAppearances.length > 0) {
                    const countedIP = countedAppearances.reduce((sum, app) => sum + (parseFloat(app.stats?.inningsPitched) || 0), 0);
                    const excludedIP = excludedAppearances.reduce((sum, app) => sum + (parseFloat(app.stats?.inningsPitched) || 0), 0);
                    
                    if (countedIP + excludedIP > 0) {
                        const countedRatio = countedIP / (countedIP + excludedIP);
                        countedPoints = totalPts * countedRatio;
                    } else {
                        countedPoints = totalPts * (countedAppearances.length / pitcherData.appearances.length);
                    }
                } else if (countedAppearances.length === 0) {
                    countedPoints = 0;
                }
                
                const fantasyTeam = metaElement.dataset.team;
                const note = countedAppearances.length === pitcherData.appearances.length ? 'All appearances counted' :
                            countedAppearances.length === 0 ? 'All appearances over limit' :
                            `${countedAppearances.length} of ${pitcherData.appearances.length} counted (prorated)`;
                
                csv += `"${fantasyTeam}","${pitcherData.name}",${pitcherData.appearances.length},${countedAppearances.length},${countedPoints.toFixed(2)},"${note}"\n`;
            });
            
            // Calculate final total
            let finalTotal = 0;
            metadataElements.forEach((metaElement) => {
                const groupIndex = metaElement.dataset.group;
                const pitcherData = JSON.parse(metaElement.value);
                
                const ipRaw = document.querySelector(`input.stat-ip[data-group="${groupIndex}"]`).value;
                const ip = parseIPValue(ipRaw);
                const er = parseFloat(document.querySelector(`input.stat-er[data-group="${groupIndex}"]`).value) || 0;
                const k = parseFloat(document.querySelector(`input.stat-k[data-group="${groupIndex}"]`).value) || 0;
                const bb = parseFloat(document.querySelector(`input.stat-bb[data-group="${groupIndex}"]`).value) || 0;
                const h = parseFloat(document.querySelector(`input.stat-h[data-group="${groupIndex}"]`).value) || 0;
                const hb = parseFloat(document.querySelector(`input.stat-hb[data-group="${groupIndex}"]`).value) || 0;
                const qs = parseFloat(document.querySelector(`input.stat-qs[data-group="${groupIndex}"]`).value) || 0;
                const sv = parseFloat(document.querySelector(`input.stat-sv[data-group="${groupIndex}"]`).value) || 0;
                const hld = parseFloat(document.querySelector(`input.stat-hld[data-group="${groupIndex}"]`).value) || 0;
                
                const totalPts = (ip * 1.5) + (er * -2) + (k * 0.75) + (bb * -0.25) + (h * -0.25) + (hb * -0.25) + (qs * 1) + (sv * 1) + (hld * 1);
                const countedAppearances = pitcherData.appearances.filter(a => a.counts);
                const excludedAppearances = pitcherData.appearances.filter(a => !a.counts);
                
                let countedPoints = totalPts;
                if (countedAppearances.length > 0 && excludedAppearances.length > 0) {
                    const countedIP = countedAppearances.reduce((sum, app) => sum + (parseFloat(app.stats?.inningsPitched) || 0), 0);
                    const excludedIP = excludedAppearances.reduce((sum, app) => sum + (parseFloat(app.stats?.inningsPitched) || 0), 0);
                    
                    if (countedIP + excludedIP > 0) {
                        const countedRatio = countedIP / (countedIP + excludedIP);
                        countedPoints = totalPts * countedRatio;
                    } else {
                        countedPoints = totalPts * (countedAppearances.length / pitcherData.appearances.length);
                    }
                } else if (countedAppearances.length === 0) {
                    countedPoints = 0;
                }
                
                finalTotal += countedPoints;
            });
            
            csv += '\n';
            csv += `FINAL CORRECTED TOTAL,,,${finalTotal.toFixed(2)}\n`;
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // Auto-create stats inputs when tab 3 is opened after game times are fetched
        const originalSwitchTab = switchTab;
        switchTab = function(index) {
            originalSwitchTab(index);
            if (index === 2 && gameTimesData.length > 0) {
                createStatsInputs();
            }
        };
    </script>
</body>
</html>
