<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantrax Pitcher Tracker</title>
    
    <!-- 
    Fantrax API Sync: CONFIGURED ‚úì
    Proxy URL: https://fantrax-proxy.vercel.app/api/roster
    -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #111827;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { color: #e0e7ff; }
        .tabs {
            display: flex;
            background: #1f2937;
            border-bottom: 2px solid #374151;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #1f2937;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            transition: all 0.2s;
        }
        .tab:hover {
            background: #374151;
            color: #d1d5db;
        }
        .tab.active {
            background: #111827;
            color: #60a5fa;
            border-bottom: 3px solid #3b82f6;
        }
        .tab-content { display: none; padding: 30px; background: #111827; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 13px;
            color: #d1d5db;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #374151;
            border-radius: 6px;
            font-size: 14px;
            background: #1f2937;
            color: #e5e7eb;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .form-group input::placeholder {
            color: #6b7280;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .pitcher-entry {
            display: grid;
            grid-template-columns: 1.5fr 2fr 1fr 1.5fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        .search-results {
            position: absolute;
            background: #1f2937;
            border: 2px solid #374151;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            width: calc(100% - 4px);
            margin-top: 2px;
        }
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            color: #e5e7eb;
        }
        .search-result-item:hover { background: #374151; }
        .summary-card {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .summary-card h2 { margin: 0; }
        .team-section {
            background: #1f2937;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #374151;
            overflow: hidden;
        }
        .team-header {
            padding: 20px;
            cursor: pointer;
            background: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #e5e7eb;
            font-weight: 600;
            transition: background 0.2s;
        }
        .team-header:hover { background: #4b5563; }
        .team-header h3 { margin: 0; color: #e5e7eb; }
        .team-content { padding: 20px; padding-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #374151; }
        th { background: #374151; font-weight: 600; color: #e5e7eb; }
        td { color: #d1d5db; }
        .counted { background: #1f2937; }
        .excluded { background: #1f2937; opacity: 0.7; }
        .loading { text-align: center; padding: 40px; color: #9ca3af; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { border-radius: 8px; }
            .header { padding: 20px; }
            .header h1 { font-size: 22px; }
            .tabs { flex-wrap: wrap; }
            .tab { font-size: 12px; padding: 12px 8px; }
            .tab-content { padding: 15px; }
            .pitcher-entry { grid-template-columns: 1fr; gap: 8px; }
            .summary-card { padding: 15px; flex-direction: column; gap: 10px; }
            .summary-card h2 { font-size: 18px; }
            table { font-size: 13px; }
            th, td { padding: 8px 6px; }
            .btn { padding: 8px 12px; font-size: 13px; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 18px; }
            .tab { font-size: 11px; padding: 10px 6px; }
            table { font-size: 12px; }
            th, td { padding: 6px 4px; }
        }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öæ Fantrax Pitcher Tracker</h1>
            <p>Track pitcher overages and calculate corrected scores</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">Step 1: Input</button>
            <button class="tab" onclick="switchTab(1)">Step 2: Review</button>
            <button class="tab" onclick="switchTab(2)">Step 3: Calculate</button>
            <button class="tab" onclick="switchTab(3)">How to Use</button>
        </div>
        
        <div class="tab-content active" id="tab0">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <button class="btn btn-danger" onclick="resetAll()">üîÑ Reset All</button>
                <div id="loadingStatus" style="padding: 10px; border-radius: 6px; display: none;"></div>
            </div>
            
            <!-- Mode Selector -->
            <div style="background:#13274F;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #CE1141;">
                <h3 style="color:#EAAA00;margin:0 0 15px 0;">Select Import Mode</h3>
                <div style="display:flex;gap:15px;">
                    <button class="btn" onclick="switchMode('roster')" id="modeRoster" style="flex:1;background:#CE1141;color:#fff;font-weight:600;">
                        üöÄ League Roster Import (NEW)
                    </button>
                    <button class="btn" onclick="switchMode('manual')" id="modeManual" style="flex:1;background:#2a3f5f;color:#fff;">
                        üìù Manual Entry
                    </button>
                </div>
            </div>
            
            <!-- Manual Entry Mode -->
            <div id="manualMode" style="display:none;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2>Week Setup</h2>
                <button class="btn btn-secondary" onclick="resetAll()">üîÑ Clear</button>
            </div>
            
            <div id="mlbLoadingStatus" style="background: #fef3c7; border: 2px solid #f59e0b; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; display: flex; align-items: center; gap: 10px;">
                <span style="animation: spin 1s linear infinite; display: inline-block;">‚è≥</span>
                <span>Loading MLB pitcher database...</span>
            </div>
            
            <style>
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            </style>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                <div class="form-group">
                    <label>Week Start</label>
                    <input type="date" id="weekStart" onchange="updateWeekEnd()">
                </div>
                <div class="form-group">
                    <label>Week End</label>
                    <input type="date" id="weekEnd" onchange="updateWeekEnd()">
                </div>
                <div class="form-group">
                    <label>Max Starts (SP)</label>
                    <input type="number" id="maxStarts" value="7" min="0">
                </div>
                <div class="form-group">
                    <label>Max Relief (RP)</label>
                    <input type="number" id="maxRP" value="10" min="0">
                </div>
            </div>
            
            <h2>Week Setup</h2>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">
                Add each active appearance for ALL teams with overages
            </p>
            
            <div style="background: #f0f9ff; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 10px;">üìã Bulk Paste Pitchers</h4>
                <p style="font-size: 13px; color: #374151; margin-bottom: 10px;">
                    Copy pitcher names from Fantrax (one per line) and paste below:
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="bulkTeamName" placeholder="Fantasy Team Name" style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                    <input type="date" id="bulkGameDate" style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                    <button class="btn btn-primary" onclick="processBulkPaste()">Add All</button>
                </div>
                <textarea id="bulkPaste" placeholder="Paste pitcher names here (one per line)&#10;&#10;Example:&#10;Max Fried&#10;Corbin Burnes&#10;Spencer Schwellenbach" 
                    style="width: 100%; height: 120px; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-family: monospace; font-size: 13px;"></textarea>
            </div>
            
            <button class="btn btn-secondary" onclick="loadTestData()" style="margin-bottom: 15px; font-size: 13px;">
                üìã Load Test Data (March 31-Apr 6)
            </button>
            
            <div id="pitcherList">
                <div class="pitcher-entry">
                    <div class="form-group">
                        <input type="text" class="fantasy-team" placeholder="Fantasy Team">
                    </div>
                    <div class="form-group" style="position: relative;">
                        <input type="text" class="pitcher-name" placeholder="Pitcher Name" autocomplete="off">
                        <div class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <input type="text" class="mlb-team" placeholder="NYY" maxlength="3">
                    </div>
                    <div class="form-group">
                        <input type="date" class="game-date">
                    </div>
                    <button class="btn btn-danger" onclick="removeRow(this)">‚úï</button>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="addRow()">+ Add</button>
            <button class="btn btn-primary" onclick="fetchGames()" style="float: right;">Fetch Games ‚Üí</button>
            </div>
            
            <!-- League Roster Import Mode -->
            <div id="rosterMode" style="display:block;">
                <!-- Hero Section - API Sync with Braves Colors -->
                <div style="background:linear-gradient(135deg, #13274F 0%, #1a3566 100%);padding:30px;border-radius:12px;margin-bottom:30px;box-shadow:0 10px 40px rgba(206,17,65,0.3);border:2px solid #CE1141;">
                    <div style="display:flex;align-items:center;gap:15px;margin-bottom:20px;">
                        <div style="font-size:48px;">üöÄ</div>
                        <div>
                            <h2 style="color:#fff;margin:0;font-size:28px;font-weight:bold;">Live Roster Sync</h2>
                            <p style="color:#EAAA00;margin:5px 0 0 0;font-size:14px;font-weight:500;">Instantly pull rosters from Fantrax - no manual upload needed</p>
                        </div>
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);padding:25px;border-radius:8px;border:1px solid rgba(234,170,0,0.3);">
                        <div class="form-group" style="margin-bottom:20px;">
                            <label style="color:#EAAA00;font-weight:600;font-size:14px;">Fantrax League ID</label>
                            <input type="text" id="fantraxLeagueId" class="form-group input" placeholder="e.g., cbla2gq5mhdvy7q4" value="cbla2gq5mhdvy7q4" style="font-size:16px;padding:12px;background:#fff;color:#13274F;border:2px solid #EAAA00;">
                            <div style="font-size:12px;color:#f0f0f0;margin-top:5px;">
                                üí° Find in your league URL: fantrax.com/fantasy/league/<strong style="color:#EAAA00;">YOUR_ID_HERE</strong>/
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom:20px;">
                            <label style="color:#EAAA00;font-weight:600;font-size:14px;">Week Dates</label>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                <input type="date" id="apiWeekStart" class="form-group input" style="padding:12px;background:#fff;color:#13274F;border:2px solid #EAAA00;">
                                <input type="date" id="apiWeekEnd" class="form-group input" style="padding:12px;background:#fff;color:#13274F;border:2px solid #EAAA00;">
                            </div>
                        </div>
                        
                        <button class="btn" onclick="syncFromFantrax()" style="width:100%;padding:16px;font-size:18px;font-weight:bold;background:#CE1141;color:#fff;border:none;position:relative;overflow:hidden;box-shadow:0 4px 20px rgba(206,17,65,0.4);">
                            <span style="position:relative;z-index:1;">‚ö° Sync Rosters & Find Pitchers</span>
                        </button>
                        
                        <!-- Snapshot Controls -->
                        <div style="margin-top:20px;padding:15px;background:rgba(234,170,0,0.1);border-radius:6px;border:1px solid rgba(234,170,0,0.3);">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                                <span style="font-size:20px;">üì∏</span>
                                <h4 style="color:#EAAA00;margin:0;font-size:14px;font-weight:600;">Roster Snapshot (Optional)</h4>
                            </div>
                            <p style="color:#f0f0f0;font-size:12px;margin:0 0 10px 0;">Save current rosters before weekly processing (recommended Sunday night)</p>
                            <div style="display:flex;gap:10px;">
                                <button class="btn" onclick="saveRosterSnapshot()" style="flex:1;background:#2a3f5f;color:#fff;font-size:13px;padding:10px;border:1px solid #EAAA00;">
                                    üíæ Save Snapshot
                                </button>
                                <button class="btn" onclick="loadRosterSnapshot()" style="flex:1;background:#2a3f5f;color:#fff;font-size:13px;padding:10px;border:1px solid #EAAA00;">
                                    üìÇ Load Snapshot
                                </button>
                            </div>
                            <div id="snapshotStatus" style="color:#EAAA00;font-size:11px;margin-top:8px;text-align:center;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top:20px;padding:15px;background:rgba(234,170,0,0.15);border-radius:6px;border-left:4px solid #EAAA00;">
                        <div style="display:flex;align-items:start;gap:10px;">
                            <span style="font-size:20px;">‚ö°</span>
                            <div style="flex:1;">
                                <strong style="color:#EAAA00;display:block;margin-bottom:5px;">Pro Tip:</strong>
                                <p style="color:#f0f0f0;margin:0;font-size:13px;line-height:1.5;">
                                    Run sync <strong>before Monday waivers</strong> to capture accurate rosters. Use "Save Snapshot" on Sunday night, then "Load Snapshot" Monday morning for perfect accuracy.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rosters Viewer (NEW) -->
                <div id="rostersViewer" style="display:none;background:#13274F;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #EAAA00;">
                    <h3 style="color:#EAAA00;margin:0 0 15px 0;">üìä Loaded Rosters</h3>
                    <div id="rostersViewerContent" style="color:#f0f0f0;"></div>
                </div>
                
                <!-- Alternative Method - CSV Upload -->
                <details style="margin-bottom:20px;">
                    <summary style="background:#2a3f5f;padding:15px;border-radius:8px;cursor:pointer;color:#f0f0f0;font-weight:600;list-style:none;display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(234,170,0,0.3);">
                        <span>üìÑ Alternative: Manual CSV Upload</span>
                        <span style="font-size:12px;color:#EAAA00;">Click to expand</span>
                    </summary>
                    
                    <div style="background:#13274F;padding:20px;border-radius:0 0 8px 8px;margin-top:-8px;border-top:2px solid #CE1141;">
                        <p style="color:#f0f0f0;margin-bottom:15px;font-size:14px;">Use this if API sync isn't working or for historical data analysis.</p>
                        
                        <div class="form-group">
                            <label style="color:#EAAA00;">Upload Fantrax CSV Export</label>
                            <input type="file" id="fantraxFile" accept=".csv" style="width:100%;padding:10px;border:2px solid #EAAA00;border-radius:6px;background:#fff;color:#13274F;cursor:pointer;">
                            <div style="font-size:12px;color:#f0f0f0;margin-top:5px;">
                                üí° Export from Fantrax: Players > Export > Download CSV
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="color:#EAAA00;">Week Dates</label>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                <input type="date" id="rosterWeekStart" class="form-group input" style="background:#fff;color:#13274F;border:2px solid #EAAA00;">
                                <input type="date" id="rosterWeekEnd" class="form-group input" style="background:#fff;color:#13274F;border:2px solid #EAAA00;">
                            </div>
                        </div>
                        
                        <button class="btn" onclick="processFantraxCSV()" style="width:100%;padding:15px;font-size:16px;background:#2a3f5f;color:#fff;border:2px solid #EAAA00;">
                            üîç Find All Pitchers Who Pitched This Week
                        </button>
                    </div>
                </details>
                
                <div id="rosterResults" style="display:none;">
                    <div style="background:#13274F;padding:20px;border-radius:8px;margin-bottom:20px;border:2px solid #CE1141;">
                        <h3 style="color:#EAAA00;margin:0 0 10px 0;">‚úÖ Pitchers Found</h3>
                        <p style="color:#f0f0f0;margin-bottom:15px;">Check the boxes for pitchers who were <strong>IN YOUR LINEUP</strong> (not benched)</p>
                        
                        <!-- Bulk Selection Buttons -->
                        <div style="display:flex;gap:10px;margin-bottom:15px;">
                            <button class="btn" onclick="selectAllPitchers()" style="flex:1;padding:10px;background:#2a3f5f;color:#fff;border:1px solid #EAAA00;font-size:13px;">
                                ‚òëÔ∏è Select All
                            </button>
                            <button class="btn" onclick="unselectAllPitchers()" style="flex:1;padding:10px;background:#2a3f5f;color:#fff;border:1px solid #EAAA00;font-size:13px;">
                                ‚òê Unselect All
                            </button>
                        </div>
                        
                        <!-- Continue Button at Top -->
                        <button class="btn" onclick="processSelectedPitchers()" style="width:100%;padding:15px;margin-bottom:20px;font-size:16px;background:#CE1141;color:#fff;font-weight:bold;box-shadow:0 4px 12px rgba(206,17,65,0.4);">
                            ‚öæ Continue with Selected Pitchers ‚Üí
                        </button>
                        
                        <div id="rosterCheckboxes"></div>
                        
                        <!-- Continue Button at Bottom -->
                        <button class="btn" onclick="processSelectedPitchers()" style="width:100%;padding:15px;margin-top:20px;font-size:16px;background:#CE1141;color:#fff;font-weight:bold;box-shadow:0 4px 12px rgba(206,17,65,0.4);">
                            ‚öæ Continue with Selected Pitchers ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="tab1">
            <div id="reviewResults"><div class="loading">Complete Step 1</div></div>
        </div>
        
        <div class="tab-content" id="tab2">
            <div id="calcResults"><div class="loading">Complete Steps 1 & 2</div></div>
        </div>
        
        <div class="tab-content" id="tab3">
            <div style="max-width: 900px; margin: 0 auto;">
                <h2>üìñ How to Use This Tool</h2>
                
                <div style="background:#1f2937;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #3b82f6;">
                    <h3 style="margin-top:0;color:#60a5fa;">Purpose</h3>
                    <p style="color:#d1d5db;margin:0;">This tool tracks pitcher overages for Fantrax H2H Categories leagues where stats continue to count even after exceeding the weekly limits (Max 7 GS, Max 10 RA). It generates reports for commissioners to manually adjust stats.</p>
                </div>
                
                <div style="background:#1f2937;padding:20px;border-radius:8px;margin-bottom:20px;">
                    <h3 style="margin-top:0;color:#60a5fa;">Step-by-Step Guide</h3>
                    
                    <div style="margin-bottom:20px;">
                        <h4 style="color:#93c5fd;margin-bottom:10px;">Step 1: Input Pitcher Data</h4>
                        <ol style="color:#d1d5db;line-height:1.8;">
                            <li><strong style="color:#e5e7eb;">Set Week Dates:</strong> Select your matchup period start and end dates</li>
                            <li><strong style="color:#e5e7eb;">Set Limits:</strong> Default is 7 Starts (SP) and 10 Relief (RP) - adjust if needed</li>
                            <li><strong style="color:#e5e7eb;">Wait for Database:</strong> Green banner appears when MLB pitcher database loads</li>
                            <li><strong style="color:#e5e7eb;">Add Pitchers:</strong>
                                <ul style="margin-top:5px;">
                                    <li><strong>Bulk Paste:</strong> Copy pitcher names from Fantrax (one per line), enter team name and date, click "Add All"</li>
                                    <li><strong>Manual:</strong> Click "+ Add" button to add one at a time</li>
                                    <li><strong>Auto-fill:</strong> MLB teams auto-fill when database is loaded</li>
                                </ul>
                            </li>
                            <li><strong style="color:#e5e7eb;">Fetch Games:</strong> Click "Fetch Games ‚Üí" to retrieve stats from MLB API</li>
                        </ol>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <h4 style="color:#93c5fd;margin-bottom:10px;">Step 2: Review Chronological Order</h4>
                        <p style="color:#d1d5db;margin:0 0 10px 0;">Appearances are sorted by actual game time. Check status column:</p>
                        <ul style="color:#d1d5db;line-height:1.8;">
                            <li><strong style="color:#10b981;">‚úì Counts (3/7 SP):</strong> This appearance counts, it's the 3rd of 7 allowed</li>
                            <li><strong style="color:#ef4444;">‚úó Excluded (8/7 SP):</strong> This appearance exceeds limits and needs removal</li>
                        </ul>
                        <p style="color:#9ca3af;margin-top:10px;font-size:13px;">If order looks correct, click "Continue ‚Üí"</p>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <h4 style="color:#93c5fd;margin-bottom:10px;">Step 3: Review Stats & Export</h4>
                        <p style="color:#d1d5db;margin:0 0 10px 0;">View the Commissioner Quick View Dashboard:</p>
                        <ul style="color:#d1d5db;line-height:1.8;">
                            <li><strong style="color:#10b981;">Green:</strong> Teams with no overages</li>
                            <li><strong style="color:#ef4444;">Red:</strong> Teams requiring adjustments</li>
                            <li><strong style="color:#f59e0b;">Orange:</strong> Total excluded appearances</li>
                        </ul>
                        <p style="color:#d1d5db;margin:10px 0;">Export Options:</p>
                        <ul style="color:#d1d5db;line-height:1.8;">
                            <li><strong style="color:#10b981;">"üìä Export CSV":</strong> For Google Sheets (lightweight, easy sharing)</li>
                            <li><strong style="color:#3b82f6;">"üìó Export Excel":</strong> For Excel (multi-sheet workbook with formatting)</li>
                        </ul>
                    </div>
                </div>
                
                <div style="background:#1f2937;padding:20px;border-radius:8px;margin-bottom:20px;">
                    <h3 style="margin-top:0;color:#60a5fa;">CSV Report Structure</h3>
                    
                    <div style="margin-bottom:15px;">
                        <h4 style="color:#93c5fd;margin-bottom:8px;">Section 1: Summary by Team</h4>
                        <p style="color:#d1d5db;margin:0;font-size:14px;">Shows aggregate stats for each team with three columns per category:</p>
                        <ul style="color:#d1d5db;font-size:14px;line-height:1.6;">
                            <li><strong>Total (All):</strong> What Fantrax shows (includes excluded apps)</li>
                            <li><strong>To Remove:</strong> Stats from excluded apps only</li>
                            <li><strong>Corrected:</strong> What the true total should be</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <h4 style="color:#93c5fd;margin-bottom:8px;">Section 2: Players Requiring Adjustment</h4>
                        <p style="color:#d1d5db;margin:0;font-size:14px;">Lists ONLY pitchers with excluded appearances. Shows exactly what to remove per player across all categories (IP, K, QS, ERA, SVH, BB+HBP).</p>
                    </div>
                    
                    <div>
                        <h4 style="color:#93c5fd;margin-bottom:8px;">Section 3: Detailed Breakdown</h4>
                        <p style="color:#d1d5db;margin:0;font-size:14px;">Every appearance with game time, type (SP/RP), status (COUNTS/EXCLUDED), and full stats.</p>
                    </div>
                </div>
                
                <div style="background:#1f2937;padding:20px;border-radius:8px;margin-bottom:20px;">
                    <h3 style="margin-top:0;color:#60a5fa;">Manual Stat Adjustment Process</h3>
                    <ol style="color:#d1d5db;line-height:1.8;">
                        <li>Open exported CSV in Excel or Google Sheets</li>
                        <li>Go to "Players Requiring Adjustment" section</li>
                        <li>For each player listed, manually subtract their stats in Fantrax:
                            <ul style="margin-top:5px;font-size:14px;">
                                <li>IP (Innings Pitched)</li>
                                <li>K (Strikeouts)</li>
                                <li>QS (Quality Starts)</li>
                                <li>ERA (Earned Run Average) - recalculate based on corrected IP/ER</li>
                                <li>SVH (Saves + Holds)</li>
                                <li>BB+HBP (Walks + Hit By Pitch)</li>
                            </ul>
                        </li>
                        <li>Upload CSV to Google Drive for league transparency</li>
                    </ol>
                </div>
                
                <div style="background:#1f2937;padding:20px;border-radius:8px;margin-bottom:20px;">
                    <h3 style="margin-top:0;color:#60a5fa;">Tips & Tricks</h3>
                    <ul style="color:#d1d5db;line-height:1.8;">
                        <li><strong style="color:#e5e7eb;">Bulk Paste is Fastest:</strong> Copy all pitcher names at once from Fantrax roster page</li>
                        <li><strong style="color:#e5e7eb;">Check Names with Accents:</strong> Tool handles Su√°rez, P√©rez automatically</li>
                        <li><strong style="color:#e5e7eb;">N/A Teams:</strong> If MLB team shows "N/A", pitcher isn't in 2025 database - enter team manually</li>
                        <li><strong style="color:#e5e7eb;">Same-Game Pitchers:</strong> Tool uses appearance order from boxscore for proper chronological sorting</li>
                        <li><strong style="color:#e5e7eb;">Color Coding in Step 3:</strong>
                            <ul style="margin-top:5px;">
                                <li>üü¢ Green: All appearances counted</li>
                                <li>üü† Orange: Mixed (some counted, some excluded)</li>
                                <li>üî¥ Red: All appearances excluded</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                
                <div style="background:#1f2937;padding:20px;border-radius:8px;border-left:4px solid #ef4444;">
                    <h3 style="margin-top:0;color:#f87171;">Important Notes</h3>
                    <ul style="color:#d1d5db;line-height:1.8;margin:0;">
                        <li><strong style="color:#fca5a5;">Database Load Time:</strong> Wait 2-5 seconds for green "MLB pitcher database loaded" banner</li>
                        <li><strong style="color:#fca5a5;">Past Games Only:</strong> MLB API only has data for games already played - no future dates</li>
                        <li><strong style="color:#fca5a5;">Manual Adjustment Required:</strong> This tool generates reports - commissioners must manually adjust stats in Fantrax</li>
                        <li><strong style="color:#fca5a5;">No Hitting Overages Yet:</strong> Currently tracks pitching only</li>
                    </ul>
                </div>
                
                <div style="background:#1f2937;padding:20px;border-radius:8px;margin-top:20px;text-align:center;">
                    <p style="color:#9ca3af;margin:0;">Questions? Contact your league administrator</p>
                    <p style="color:#6b7280;margin:5px 0 0 0;font-size:12px;">Fantrax Pitcher Tracker v4.0.0 - Dark Mode</p>
                </div>
            </div>
        </div>
    </div>
    
    <div style="position: fixed; bottom: 10px; left: 10px; font-size: 11px; color: #9ca3af; font-family: monospace;">
        v5.3.7 - Data Index Fixed
    </div>
    
    <script>
        let allPitchers = [];
        let mlbPitchers = [];
        
        // Function to remove accents for better matching
        function removeAccents(str) {
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }
        let gameData = [];
        let rosterModeData = []; // Store found pitchers for checkbox selection
        let currentMode = 'manual'; // 'manual' or 'roster'
        let currentImportMethod = 'api'; // 'api' or 'csv'
        
        function switchImportMethod(method) {
            currentImportMethod = method;
            if (method === 'api') {
                document.getElementById('apiImportMethod').style.display = 'block';
                document.getElementById('csvImportMethod').style.display = 'none';
                document.getElementById('methodAPI').classList.remove('btn-secondary');
                document.getElementById('methodAPI').classList.add('btn-primary');
                document.getElementById('methodCSV').classList.remove('btn-primary');
                document.getElementById('methodCSV').classList.add('btn-secondary');
            } else {
                document.getElementById('apiImportMethod').style.display = 'none';
                document.getElementById('csvImportMethod').style.display = 'block';
                document.getElementById('methodAPI').classList.remove('btn-primary');
                document.getElementById('methodAPI').classList.add('btn-secondary');
                document.getElementById('methodCSV').classList.remove('btn-secondary');
                document.getElementById('methodCSV').classList.add('btn-primary');
            }
        }
        
        // Display rosters in viewer
        function displayRostersViewer(teams, pitchers) {
            const viewer = document.getElementById('rostersViewer');
            const content = document.getElementById('rostersViewerContent');
            
            // Group pitchers by team
            const pitchersByTeam = {};
            pitchers.forEach(p => {
                if (!pitchersByTeam[p.team]) pitchersByTeam[p.team] = [];
                pitchersByTeam[p.team].push(p);
            });
            
            let html = `<div style="margin-bottom:15px;padding:12px;background:rgba(234,170,0,0.1);border-radius:6px;border-left:4px solid #CE1141;">
                <strong style="color:#CE1141;">‚úÖ Successfully loaded ${teams.length} teams with ${pitchers.length} total pitchers</strong>
            </div>`;
            
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px;">';
            
            teams.forEach(team => {
                const teamPitchers = pitchersByTeam[team.name] || [];
                html += `
                    <details style="background:rgba(255,255,255,0.05);padding:15px;border-radius:6px;border:1px solid rgba(234,170,0,0.3);">
                        <summary style="cursor:pointer;font-weight:600;color:#EAAA00;font-size:14px;user-select:none;">
                            ${team.name} <span style="color:#fff;font-weight:normal;">(${teamPitchers.length} P)</span>
                        </summary>
                        <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(234,170,0,0.2);">
                            ${teamPitchers.length > 0 ? teamPitchers.map(p => 
                                `<div style="padding:4px 0;color:#f0f0f0;font-size:13px;">‚Ä¢ ${p.player}</div>`
                            ).join('') : '<div style="color:#999;font-size:13px;">No pitchers</div>'}
                        </div>
                    </details>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
            viewer.style.display = 'block';
        }
        
        async function syncFromFantrax() {
            const leagueId = document.getElementById('fantraxLeagueId').value.trim();
            const weekStart = document.getElementById('apiWeekStart').value;
            const weekEnd = document.getElementById('apiWeekEnd').value;
            
            if (!leagueId) {
                alert('Please enter your Fantrax League ID');
                return;
            }
            
            if (!weekStart || !weekEnd) {
                alert('Please select week dates');
                return;
            }
            
            // Show progress
            document.getElementById('rosterResults').style.display = 'block';
            document.getElementById('rosterCheckboxes').innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div style="display:inline-block;width:50px;height:50px;border:5px solid #374151;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite;"></div>
                    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
                    <p style="color:#e5e7eb;margin-top:20px;font-size:16px;">Syncing from Fantrax API...</p>
                    <p style="color:#9ca3af;font-size:13px;">This may take a minute</p>
                </div>
            `;
            
            try {
                // Call Fantrax API via CORS proxy
                console.log('Fetching rosters from Fantrax for league:', leagueId);
                
                // Using deployed Vercel proxy
                const PROXY_URL = 'https://fantrax-proxy.vercel.app/api/roster';
                
                const response = await fetch(`${PROXY_URL}?leagueId=${leagueId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Fantrax API Response:', data);
                
                // Official API returns rosters as an object with team IDs as keys
                let teamRosters = [];
                
                if (data.rosters) {
                    // Convert rosters object to array
                    teamRosters = Object.entries(data.rosters).map(([teamId, rosterData]) => ({
                        teamId: teamId,
                        name: rosterData.teamName || rosterData.name || 'Unknown Team',
                        roster: rosterData.rosterItems || rosterData.roster || []
                    }));
                    console.log('Converted rosters to array:', teamRosters);
                } else if (data.teamRosters) {
                    // Direct array format
                    teamRosters = data.teamRosters;
                } else if (data.responses && data.responses[0]) {
                    // Old wrapped format
                    const responseData = data.responses[0];
                    if (responseData.data && responseData.data.teamRosters) {
                        teamRosters = responseData.data.teamRosters;
                    }
                }
                
                if (!teamRosters || teamRosters.length === 0) {
                    throw new Error('No team rosters found in response. Check console for response structure.');
                }
                
                console.log('Team rosters:', teamRosters);
                
                // Build roster array (team, player, position)
                const roster = [];
                
                // Check if we have player names mapping
                const playerNames = data.playerNames || {};
                console.log('Player names available:', Object.keys(playerNames).length);
                console.log('Player names sample:', Object.keys(playerNames).slice(0, 3).map(k => `${k}: ${playerNames[k]?.name || playerNames[k]}`));
                
                teamRosters.forEach(team => {
                    const teamName = team.name || team.teamName || 'Unknown Team';
                    const rosterItems = team.roster || team.rosterItems || [];
                    
                    console.log(`Processing ${teamName}: ${rosterItems.length} players`);
                    
                    rosterItems.forEach(item => {
                        // Get player ID
                        const fantraxId = item.id || item.playerId;
                        const position = item.position || '';
                        
                        // Only process pitchers
                        if (!position || !(position.includes('SP') || position.includes('RP') || position === 'P')) {
                            return;
                        }
                        
                        // Look up player name from playerNames mapping
                        const playerData = playerNames[fantraxId] || {};
                        const playerName = playerData.name || playerData.fullName || `Player_${fantraxId}`;
                        
                        roster.push({ 
                            team: teamName, 
                            player: playerName,
                            position: position,
                            fantraxId: fantraxId
                        });
                        console.log(`  Found pitcher: ${playerName} (${position})`);
                    });
                });
                
                if (roster.length === 0) {
                    alert('No pitchers found in league rosters. Check your League ID.');
                    document.getElementById('rosterResults').style.display = 'none';
                    return;
                }
                
                console.log(`Found ${roster.length} pitchers`);
                
                // Display rosters viewer
                displayRostersViewer(teamRosters, roster);
                
                // Now process like CSV (find who pitched)
                await processRosterData(roster, weekStart, weekEnd);
                
            } catch (error) {
                console.error('Fantrax API Error:', error);
                alert(`Failed to sync from Fantrax: ${error.message}\n\nTry:\n1. Check League ID is correct\n2. Make sure league is public\n3. Use CSV upload as backup`);
                document.getElementById('rosterResults').style.display = 'none';
            }
        }
        
        async function processRosterData(roster, weekStart, weekEnd) {
            // Same logic as processFantraxCSV, but with roster array instead of CSV parsing
            rosterModeData = [];
            const seenAppearances = new Set();
            
            document.getElementById('rosterCheckboxes').innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div style="display:inline-block;width:50px;height:50px;border:5px solid #374151;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite;"></div>
                    <p style="color:#e5e7eb;margin-top:20px;font-size:16px;">Finding pitchers who pitched this week...</p>
                    <p style="color:#9ca3af;font-size:13px;">Processing <span id="progressCount">0</span>/${roster.length} players</p>
                </div>
            `;
            
            let processed = 0;
            for (const player of roster) {
                processed++;
                document.getElementById('progressCount').textContent = processed;
                
                try {
                    const searchResults = mlbPitchers.filter(p => 
                        removeAccents(p.fullName.toLowerCase()).includes(removeAccents(player.player.toLowerCase()))
                    );
                    
                    if (searchResults.length === 0) {
                        console.log(`Not found in MLB DB: ${player.player}`);
                        continue;
                    }
                    
                    const mlbPlayer = searchResults[0];
                    console.log(`Processing: ${mlbPlayer.fullName} (${player.team})`);
                    
                    const gamesUrl = `https://statsapi.mlb.com/api/v1/schedule?sportId=1&startDate=${weekStart}&endDate=${weekEnd}&teamId=${mlbPlayer.currentTeam.id}`;
                    const gamesResp = await fetch(gamesUrl);
                    const gamesData = await gamesResp.json();
                    
                    if (!gamesData.dates || gamesData.dates.length === 0) continue;
                    
                    for (const dateEntry of gamesData.dates) {
                        for (const game of dateEntry.games) {
                            const boxscoreUrl = `https://statsapi.mlb.com/api/v1/game/${game.gamePk}/boxscore`;
                            const boxResp = await fetch(boxscoreUrl);
                            const boxData = await boxResp.json();
                            
                            const teamSide = boxData.teams.home.team.id === mlbPlayer.currentTeam.id ? 'home' : 'away';
                            const teamData = boxData.teams[teamSide];
                            
                            const pitcher = Object.values(teamData.players).find(p => 
                                p.person && p.person.id === mlbPlayer.id && p.stats && p.stats.pitching
                            );
                            
                            if (pitcher && pitcher.stats.pitching) {
                                // CRITICAL: Only include if they actually pitched (faced at least 1 batter)
                                const battersFaced = pitcher.stats.pitching.battersFaced || 0;
                                const pitchesThrown = pitcher.stats.pitching.numberOfPitches || 0;
                                
                                if (battersFaced === 0 && pitchesThrown === 0) {
                                    console.log(`  SKIPPED: ${pitcher.person.fullName} - listed but did not pitch (0 BF, 0 pitches)`);
                                    continue;
                                }
                                
                                const appearanceKey = `${player.team}|${mlbPlayer.id}|${game.gamePk}`;
                                
                                if (seenAppearances.has(appearanceKey)) {
                                    console.log(`  DUPLICATE CAUGHT: ${mlbPlayer.fullName} game ${game.gamePk}`);
                                    continue;
                                }
                                
                                seenAppearances.add(appearanceKey);
                                
                                const isStart = teamData.pitchers && teamData.pitchers[0] == pitcher.person.id;
                                const pitcherOrder = teamData.pitchers ? teamData.pitchers.indexOf(pitcher.person.id) : 0;
                                
                                let gameTime = new Date(game.gameDate);
                                if (boxData.gameInfo && boxData.gameInfo.firstPitch) {
                                    gameTime = new Date(boxData.gameInfo.firstPitch);
                                }
                                gameTime = new Date(gameTime.getTime() + (pitcherOrder * 1000));
                                
                                const ip = pitcher.stats.pitching.inningsPitched || '0';
                                console.log(`  ADDED: ${pitcher.person.fullName} (${isStart ? 'SP' : 'RP'}) on ${gameTime.toISOString()} - IP: ${ip}, BF: ${battersFaced}`);
                                
                                rosterModeData.push({
                                    fantasyTeam: player.team,
                                    name: pitcher.person.fullName,
                                    playerId: pitcher.person.id,
                                    mlbTeam: mlbPlayer.currentTeam.abbreviation,
                                    gameDate: gameTime.toISOString(),  // CRITICAL: Use actual first pitch time
                                    gameTime: gameTime,
                                    type: isStart ? 'SP' : 'RP',
                                    stats: pitcher.stats.pitching
                                });
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error processing', player.player, e);
                }
            }
            
            console.log(`=== FINAL RESULTS ===`);
            console.log(`Total appearances found: ${rosterModeData.length}`);
            console.log(`Unique appearance keys: ${seenAppearances.size}`);
            
            displayRosterResults();
        }
        
        function saveRosterSnapshot() {
            if (rosterModeData.length === 0) {
                alert('No roster data to save. Sync from Fantrax first.');
                return;
            }
            
            const weekStart = document.getElementById('apiWeekStart').value;
            const weekEnd = document.getElementById('apiWeekEnd').value;
            const leagueId = document.getElementById('fantraxLeagueId').value;
            
            if (!weekStart || !weekEnd) {
                alert('Please set week dates first');
                return;
            }
            
            const snapshot = {
                leagueId: leagueId,
                weekStart: weekStart,
                weekEnd: weekEnd,
                timestamp: new Date().toISOString(),
                data: rosterModeData
            };
            
            const snapshotKey = `fantrax_snapshot_${weekStart}`;
            localStorage.setItem(snapshotKey, JSON.stringify(snapshot));
            
            document.getElementById('snapshotStatus').innerHTML = 
                `‚úÖ Saved snapshot for week ${weekStart} to ${weekEnd} (${rosterModeData.length} appearances)`;
            document.getElementById('snapshotStatus').style.color = '#34d399';
            
            console.log('Snapshot saved:', snapshotKey);
        }
        
        function loadRosterSnapshot() {
            const weekStart = document.getElementById('apiWeekStart').value;
            
            if (!weekStart) {
                alert('Please set week start date to load snapshot');
                return;
            }
            
            const snapshotKey = `fantrax_snapshot_${weekStart}`;
            const savedData = localStorage.getItem(snapshotKey);
            
            if (!savedData) {
                alert(`No snapshot found for week starting ${weekStart}`);
                document.getElementById('snapshotStatus').innerHTML = 
                    `‚ùå No snapshot found for ${weekStart}`;
                document.getElementById('snapshotStatus').style.color = '#ef4444';
                return;
            }
            
            try {
                const snapshot = JSON.parse(savedData);
                rosterModeData = snapshot.data;
                
                document.getElementById('apiWeekStart').value = snapshot.weekStart;
                document.getElementById('apiWeekEnd').value = snapshot.weekEnd;
                document.getElementById('fantraxLeagueId').value = snapshot.leagueId;
                
                displayRosterResults();
                
                const snapshotDate = new Date(snapshot.timestamp).toLocaleString();
                document.getElementById('snapshotStatus').innerHTML = 
                    `‚úÖ Loaded snapshot from ${snapshotDate} (${rosterModeData.length} appearances)`;
                document.getElementById('snapshotStatus').style.color = '#34d399';
                
                console.log('Snapshot loaded:', snapshot);
            } catch (e) {
                alert('Error loading snapshot: ' + e.message);
                console.error('Load error:', e);
            }
        }
        
        function switchMode(mode) {
            currentMode = mode;
            if (mode === 'manual') {
                document.getElementById('manualMode').style.display = 'block';
                document.getElementById('rosterMode').style.display = 'none';
                document.getElementById('modeManual').style.background = '#CE1141';
                document.getElementById('modeManual').style.fontWeight = '600';
                document.getElementById('modeRoster').style.background = '#2a3f5f';
                document.getElementById('modeRoster').style.fontWeight = 'normal';
            } else {
                document.getElementById('manualMode').style.display = 'none';
                document.getElementById('rosterMode').style.display = 'block';
                document.getElementById('modeManual').style.background = '#2a3f5f';
                document.getElementById('modeManual').style.fontWeight = 'normal';
                document.getElementById('modeRoster').style.background = '#CE1141';
                document.getElementById('modeRoster').style.fontWeight = '600';
            }
        }
        
        async function processFantraxCSV() {
            const weekStart = document.getElementById('rosterWeekStart').value;
            const weekEnd = document.getElementById('rosterWeekEnd').value;
            const fileInput = document.getElementById('fantraxFile');
            
            if (!weekStart || !weekEnd) {
                alert('Please select week dates');
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please upload a Fantrax CSV file');
                return;
            }
            
            const file = fileInput.files[0];
            const text = await file.text();
            
            // Parse CSV
            const lines = text.split('\n');
            const roster = [];
            
            // Skip header row, parse data
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parse CSV - need more columns to get Status (fantasy team)
                // Columns: ID, Player, Team(MLB), Position, RkOv, Status(FantasyTeam), ...
                const match = line.match(/"([^"]*?)","([^"]*?)","([^"]*?)","([^"]*?)","([^"]*?)","([^"]*?)"/);
                if (match) {
                    const player = match[2];      // Player name
                    const mlbTeam = match[3];     // MLB team (not used)
                    const position = match[4];    // Position
                    const fantasyTeam = match[6]; // Status = Fantasy team name
                    
                    // Include pitchers (SP, RP, P) - include FA now since players can be dropped mid-week
                    if ((position.includes('SP') || position.includes('RP') || position === 'P') && fantasyTeam) {
                        roster.push({ team: fantasyTeam, player: player });
                    }
                }
            }
            
            if (roster.length === 0) {
                alert('No pitchers found in CSV. Make sure you uploaded the Fantrax export.');
                return;
            }
            
            // CRITICAL FIX: Remove duplicates from roster FIRST
            const uniqueRoster = [];
            const seenRosterPlayers = new Set();
            
            roster.forEach(p => {
                const key = `${p.team}|${p.player}`;
                if (!seenRosterPlayers.has(key)) {
                    seenRosterPlayers.add(key);
                    uniqueRoster.push(p);
                }
            });
            
            console.log(`Total entries in CSV: ${roster.length}`);
            console.log(`Unique pitchers after dedup: ${uniqueRoster.length}`);
            
            // Show progress indicator
            document.getElementById('rosterResults').style.display = 'block';
            document.getElementById('rosterCheckboxes').innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div style="display:inline-block;width:50px;height:50px;border:5px solid #374151;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite;"></div>
                    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
                    <p style="color:#e5e7eb;margin-top:20px;font-size:16px;">Finding pitchers who pitched this week...</p>
                    <p style="color:#9ca3af;font-size:13px;">Processing <span id="progressCount">0</span>/${uniqueRoster.length} players</p>
                </div>
            `;
            
            // Find which pitchers pitched during the week
            rosterModeData = [];
            const seenAppearances = new Set(); // Track unique appearances globally
            
            let processed = 0;
            for (const player of uniqueRoster) {
                processed++;
                document.getElementById('progressCount').textContent = processed;
                
                try {
                    // Search for player in MLB database
                    const searchResults = mlbPitchers.filter(p => 
                        removeAccents(p.fullName.toLowerCase()).includes(removeAccents(player.player.toLowerCase()))
                    );
                    
                    if (searchResults.length === 0) {
                        console.log(`Not found in MLB DB: ${player.player}`);
                        continue;
                    }
                    
                    const mlbPlayer = searchResults[0];
                    console.log(`Processing: ${mlbPlayer.fullName} (${player.team})`);
                    
                    // Check if they pitched during the week
                    const gamesUrl = `https://statsapi.mlb.com/api/v1/schedule?sportId=1&startDate=${weekStart}&endDate=${weekEnd}&teamId=${mlbPlayer.currentTeam.id}`;
                    const gamesResp = await fetch(gamesUrl);
                    const gamesData = await gamesResp.json();
                    
                    if (!gamesData.dates || gamesData.dates.length === 0) {
                        console.log(`  No games found for ${mlbPlayer.fullName}`);
                        continue;
                    }
                    
                    for (const dateEntry of gamesData.dates) {
                        for (const game of dateEntry.games) {
                            // Fetch boxscore for this specific game
                            const boxscoreUrl = `https://statsapi.mlb.com/api/v1/game/${game.gamePk}/boxscore`;
                            const boxResp = await fetch(boxscoreUrl);
                            const boxData = await boxResp.json();
                            
                            // Check ONLY the side where this pitcher's team is playing
                            const teamSide = boxData.teams.home.team.id === mlbPlayer.currentTeam.id ? 'home' : 'away';
                            const teamData = boxData.teams[teamSide];
                            
                            // Find this specific pitcher in the boxscore
                            const pitcher = Object.values(teamData.players).find(p => 
                                p.person && p.person.id === mlbPlayer.id && p.stats && p.stats.pitching
                            );
                            
                            if (pitcher && pitcher.stats.pitching) {
                                // CRITICAL: Only include if they actually pitched (faced at least 1 batter)
                                const battersFaced = pitcher.stats.pitching.battersFaced || 0;
                                const pitchesThrown = pitcher.stats.pitching.numberOfPitches || 0;
                                
                                if (battersFaced === 0 && pitchesThrown === 0) {
                                    console.log(`  SKIPPED: ${pitcher.person.fullName} - listed but did not pitch (0 BF, 0 pitches)`);
                                    continue;
                                }
                                
                                // Create unique key
                                const appearanceKey = `${player.team}|${mlbPlayer.id}|${game.gamePk}`;
                                
                                if (seenAppearances.has(appearanceKey)) {
                                    console.log(`  DUPLICATE CAUGHT: ${mlbPlayer.fullName} game ${game.gamePk}`);
                                    continue;
                                }
                                
                                seenAppearances.add(appearanceKey);
                                
                                const isStart = teamData.pitchers && teamData.pitchers[0] == pitcher.person.id;
                                const pitcherOrder = teamData.pitchers ? teamData.pitchers.indexOf(pitcher.person.id) : 0;
                                
                                let gameTime = new Date(game.gameDate);
                                if (boxData.gameInfo && boxData.gameInfo.firstPitch) {
                                    gameTime = new Date(boxData.gameInfo.firstPitch);
                                }
                                gameTime = new Date(gameTime.getTime() + (pitcherOrder * 1000));
                                
                                const ip = pitcher.stats.pitching.inningsPitched || '0';
                                console.log(`  ADDED: ${pitcher.person.fullName} (${isStart ? 'SP' : 'RP'}) on ${gameTime.toISOString()} - IP: ${ip}, BF: ${battersFaced}`);
                                
                                rosterModeData.push({
                                    fantasyTeam: player.team,
                                    name: pitcher.person.fullName,
                                    playerId: pitcher.person.id,
                                    mlbTeam: mlbPlayer.currentTeam.abbreviation,
                                    gameDate: gameTime.toISOString(),  // CRITICAL: Use actual first pitch time
                                    gameTime: gameTime,
                                    type: isStart ? 'SP' : 'RP',
                                    stats: pitcher.stats.pitching
                                });
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error processing', player.player, e);
                }
            }
            
            console.log(`=== FINAL RESULTS ===`);
            console.log(`Total appearances found: ${rosterModeData.length}`);
            console.log(`Unique appearance keys: ${seenAppearances.size}`);
            console.log(`Should match: ${rosterModeData.length === seenAppearances.size ? 'YES ‚úì' : 'NO - DUPLICATES EXIST!'}`);
            
            // Display results with checkboxes
            displayRosterResults();
        }
        
        function displayRosterResults() {
            if (rosterModeData.length === 0) {
                alert('No pitchers found who pitched during this week. Check your dates and roster.');
                return;
            }
            
            // Add original index to each pitcher for reference
            rosterModeData.forEach((p, i) => {
                p.originalIndex = i;
            });
            
            // Group by team
            const byTeam = {};
            rosterModeData.forEach(p => {
                if (!byTeam[p.fantasyTeam]) byTeam[p.fantasyTeam] = [];
                byTeam[p.fantasyTeam].push(p);
            });
            
            let html = '';
            Object.keys(byTeam).sort().forEach((team, teamIdx) => {
                html += `<div style="background:#2a3f5f;padding:15px;border-radius:6px;margin-bottom:15px;border-left:4px solid #EAAA00;">
                    <h4 style="color:#EAAA00;margin:0 0 10px 0;">${team}</h4>`;
                
                byTeam[team].forEach((p, idx) => {
                    const id = `check_${teamIdx}_${idx}`;
                    const date = new Date(p.gameDate).toLocaleDateString();
                    html += `<div style="padding:8px;margin:5px 0;background:#13274F;border-radius:4px;display:flex;align-items:center;gap:10px;">
                        <input type="checkbox" id="${id}" data-index="${p.originalIndex}" style="width:18px;height:18px;cursor:pointer;">
                        <label for="${id}" style="color:#e5e7eb;cursor:pointer;flex:1;display:flex;justify-content:space-between;">
                            <span><strong>${p.name}</strong> (${p.type})</span>
                            <span style="color:#9ca3af;">${date}</span>
                        </label>
                    </div>`;
                });
                
                html += `</div>`;
            });
            
            document.getElementById('rosterCheckboxes').innerHTML = html;
            document.getElementById('rosterResults').style.display = 'block';
        }
        
        function selectAllPitchers() {
            const checkboxes = document.querySelectorAll('#rosterCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            console.log(`Selected all ${checkboxes.length} pitchers`);
        }
        
        function unselectAllPitchers() {
            const checkboxes = document.querySelectorAll('#rosterCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            console.log(`Unselected all ${checkboxes.length} pitchers`);
        }
        
        function processSelectedPitchers() {
            // Collect checked pitchers
            const selected = [];
            const checkboxes = document.querySelectorAll('#rosterCheckboxes input[type="checkbox"]');
            
            console.log(`=== PROCESSING SELECTIONS ===`);
            console.log(`Total checkboxes found: ${checkboxes.length}`);
            console.log(`Total rosterModeData entries: ${rosterModeData.length}`);
            
            checkboxes.forEach((cb, idx) => {
                const dataIndex = parseInt(cb.getAttribute('data-index'));
                const isChecked = cb.checked;
                
                if (isChecked) {
                    const pitcher = rosterModeData[dataIndex];
                    console.log(`  ‚úì Checkbox ${idx} (data-index=${dataIndex}): ${pitcher.name} (${pitcher.fantasyTeam})`);
                    selected.push(pitcher);
                } else {
                    const pitcher = rosterModeData[dataIndex];
                    console.log(`  ‚òê Checkbox ${idx} (data-index=${dataIndex}): ${pitcher.name} (${pitcher.fantasyTeam}) - SKIPPED`);
                }
            });
            
            console.log(`=== SELECTION COMPLETE ===`);
            console.log(`Selected ${selected.length} pitchers`);
            console.log(`Teams in selection:`, [...new Set(selected.map(p => p.fantasyTeam))]);
            
            if (selected.length === 0) {
                alert('Please select at least one pitcher who was in your lineup');
                return;
            }
            
            // Set gameData to selected pitchers
            gameData = selected;
            
            console.log(`gameData set to ${gameData.length} pitchers`);
            
            // Copy week dates to main form
            document.getElementById('weekStart').value = document.getElementById('rosterWeekStart').value;
            document.getElementById('weekEnd').value = document.getElementById('rosterWeekEnd').value;
            
            // Switch to Step 2
            switchTab(1);
            displayReview();
        }
        
        window.onload = function() {
            // Set specific test week
            document.getElementById('weekStart').value = '2025-03-31';
            document.getElementById('weekEnd').value = '2025-04-06';
            
            loadMLBPitchers();
            
            // Load test data (commented out - using bulk paste now)
            // loadTestData();
            
            document.getElementById('pitcherList').addEventListener('input', function(e) {
                if (e.target.classList.contains('pitcher-name')) {
                    searchPitcher(e.target);
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('pitcher-name')) {
                    document.querySelectorAll('.search-results').forEach(d => d.style.display = 'none');
                }
            });
        };
        
        function loadTestData() {
            const testData = [
                {team: 'Christian', pitcher: 'Justin Slaten', mlb: 'BOS', date: '2025-03-31'},
                {team: 'Christian', pitcher: 'Cristopher S√°nchez', mlb: 'PHI', date: '2025-03-31'},
                {team: 'Christian', pitcher: 'Mason Montgomery', mlb: 'TB', date: '2025-04-01'},
                {team: 'Christian', pitcher: 'Griffin Jax', mlb: 'MIN', date: '2025-04-01'},
                {team: 'Christian', pitcher: 'Ben Joyce', mlb: 'LAA', date: '2025-04-01'},
                {team: 'Christian', pitcher: 'Porter Hodge', mlb: 'CHC', date: '2025-04-01'},
                {team: 'Christian', pitcher: 'Hayden Birdsong', mlb: 'SF', date: '2025-04-02'},
                {team: 'Christian', pitcher: 'Reed Garrett', mlb: 'NYM', date: '2025-04-02'},
                {team: 'Christian', pitcher: 'Porter Hodge', mlb: 'CHC', date: '2025-04-04'},
                {team: 'Christian', pitcher: 'Reed Garrett', mlb: 'NYM', date: '2025-04-04'},
                {team: 'Christian', pitcher: 'Max Fried', mlb: 'NYY', date: '2025-04-04'},
                {team: 'Christian', pitcher: 'Spencer Schwellenbach', mlb: 'ATL', date: '2025-04-04'},
                {team: 'Christian', pitcher: 'Reese Olson', mlb: 'DET', date: '2025-04-05'},
                {team: 'Christian', pitcher: 'Mason Montgomery', mlb: 'TB', date: '2025-04-05'},
                {team: 'Christian', pitcher: 'Hayden Birdsong', mlb: 'SF', date: '2025-04-05'},
                {team: 'Christian', pitcher: 'Bryce Miller', mlb: 'SEA', date: '2025-04-05'},
                {team: 'Christian', pitcher: 'Corbin Burnes', mlb: 'ARI', date: '2025-04-06'},
                {team: 'Christian', pitcher: 'Chase Dollander', mlb: 'COL', date: '2025-04-06'}
            ];
            
            const container = document.getElementById('pitcherList');
            container.innerHTML = ''; // Clear existing
            
            testData.forEach((data, index) => {
                const div = document.createElement('div');
                div.className = 'pitcher-entry';
                div.innerHTML = `
                    <div class="form-group"><input type="text" class="fantasy-team" placeholder="Fantasy Team" value="${data.team}"></div>
                    <div class="form-group" style="position: relative;">
                        <input type="text" class="pitcher-name" placeholder="Pitcher Name" autocomplete="off" value="${data.pitcher}">
                        <div class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group"><input type="text" class="mlb-team" placeholder="NYY" maxlength="3" value="${data.mlb}"></div>
                    <div class="form-group"><input type="date" class="game-date" min="2025-03-31" max="2025-04-06" value="${data.date}"></div>
                    <button class="btn btn-danger" onclick="removeRow(this)">‚úï</button>
                `;
                container.appendChild(div);
            });
            
            console.log('‚úÖ Loaded test data with', testData.length, 'pitchers for March 31 - April 6, 2025');
        }
        
        function updateWeekEnd() {
            const start = document.getElementById('weekStart').value;
            const endInput = document.getElementById('weekEnd');
            
            if (start) {
                // Only auto-fill if week end is empty
                if (!endInput.value) {
                    const d = new Date(start);
                    d.setDate(d.getDate() + 6);
                    endInput.valueAsDate = d;
                }
                
                // Update game date constraints
                const weekEnd = endInput.value;
                if (weekEnd) {
                    document.querySelectorAll('.game-date').forEach(input => {
                        input.min = start;
                        input.max = weekEnd;
                        if (!input.value) input.value = start;
                    });
                }
            }
        }
        
        async function loadMLBPitchers() {
            try {
                const res = await fetch('https://statsapi.mlb.com/api/v1/sports/1/players?season=2025');
                const data = await res.json();
                if (data.people) {
                    allPitchers = data.people
                        .filter(p => p.primaryPosition && p.primaryPosition.abbreviation === 'P')
                        .map(p => ({ name: p.fullName, id: p.id, team: p.currentTeam?.abbreviation || 'FA' }));
                    
                    // Also create mlbPitchers for bulk paste auto-fill
                    mlbPitchers = data.people.filter(p => p.primaryPosition && p.primaryPosition.abbreviation === 'P');
                    
                    console.log('‚úÖ Loaded ' + allPitchers.length + ' pitchers');
                    
                    // Check for Chase Dollander specifically
                    const dollander = allPitchers.find(p => p.name.toLowerCase().includes('dollander'));
                    if (dollander) {
                        console.log('Found Chase Dollander:', dollander);
                    } else {
                        console.log('‚ö†Ô∏è Chase Dollander not in 2025 roster (may be rookie/minor leaguer)');
                    }
                    
                    // Update loading status indicator
                    const statusDiv = document.getElementById('mlbLoadingStatus');
                    if (statusDiv) {
                        statusDiv.style.background = '#d1fae5';
                        statusDiv.style.borderColor = '#10b981';
                        statusDiv.innerHTML = '<span>‚úÖ</span><span>MLB pitcher database loaded (' + allPitchers.length + ' pitchers)</span>';
                    }
                }
            } catch(e) { 
                console.error('‚ùå Error loading pitchers:', e);
                
                // Update status to show error
                const statusDiv = document.getElementById('mlbLoadingStatus');
                if (statusDiv) {
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.borderColor = '#ef4444';
                    statusDiv.innerHTML = '<span>‚ùå</span><span>Failed to load MLB database. Auto-fill will not work.</span>';
                }
            }
        }
        
        function searchPitcher(input) {
            const query = input.value.toLowerCase();
            const div = input.parentElement.querySelector('.search-results');
            if (query.length < 2) { div.style.display = 'none'; return; }
            if (!allPitchers.length) {
                div.innerHTML = '<div class="search-result-item">Loading...</div>';
                div.style.display = 'block';
                return;
            }
            const matches = allPitchers.filter(p => removeAccents(p.name.toLowerCase()).includes(removeAccents(query))).slice(0, 10);
            if (!matches.length) {
                div.innerHTML = '<div class="search-result-item">No matches</div>';
                div.style.display = 'block';
                return;
            }
            div.innerHTML = matches.map(p => 
                `<div class="search-result-item" onclick='selectPitcher(this, ${JSON.stringify(p)})'>
                    <strong>${p.name}</strong><span style="color:#6b7280;">${p.team}</span>
                </div>`
            ).join('');
            div.style.display = 'block';
        }
        
        function selectPitcher(el, p) {
            const entry = el.closest('.pitcher-entry');
            entry.querySelector('.pitcher-name').value = p.name;
            entry.querySelector('.pitcher-name').dataset.playerId = p.id;
            entry.querySelector('.mlb-team').value = p.team;
            el.parentElement.style.display = 'none';
        }
        
        function addRow() {
            const div = document.createElement('div');
            div.className = 'pitcher-entry';
            const ws = document.getElementById('weekStart').value;
            const we = document.getElementById('weekEnd').value;
            div.innerHTML = `
                <div class="form-group"><input type="text" class="fantasy-team" placeholder="Fantasy Team"></div>
                <div class="form-group" style="position: relative;">
                    <input type="text" class="pitcher-name" placeholder="Pitcher Name" autocomplete="off">
                    <div class="search-results" style="display: none;"></div>
                </div>
                <div class="form-group"><input type="text" class="mlb-team" placeholder="NYY" maxlength="3"></div>
                <div class="form-group"><input type="date" class="game-date" min="${ws}" max="${we}" value="${ws}"></div>
                <button class="btn btn-danger" onclick="removeRow(this)">‚úï</button>
            `;
            document.getElementById('pitcherList').appendChild(div);
        }
        
        function removeRow(btn) {
            if (document.querySelectorAll('.pitcher-entry').length > 1) {
                btn.closest('.pitcher-entry').remove();
            }
        }
        
        async function fetchGames() {
            const entries = document.querySelectorAll('.pitcher-entry');
            
            // Check for future dates before processing
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let hasFutureDates = false;
            entries.forEach(e => {
                const dateInput = e.querySelector('.game-date');
                if (dateInput.value) {
                    const gameDate = new Date(dateInput.value);
                    gameDate.setHours(0, 0, 0, 0);
                    
                    if (gameDate > today) {
                        hasFutureDates = true;
                    }
                }
            });
            
            if (hasFutureDates) {
                const proceed = confirm('‚ö†Ô∏è Warning: Some game dates are in the FUTURE.\n\nThe MLB Stats API only has data for games that have already been played.\n\nFuture games will show "Could not find game data" errors.\n\nContinue anyway?');
                if (!proceed) return;
            }
            
            const pitchers = [];
            entries.forEach(e => {
                const ft = e.querySelector('.fantasy-team').value;
                const name = e.querySelector('.pitcher-name').value;
                const mlb = e.querySelector('.mlb-team').value;
                const date = e.querySelector('.game-date').value;
                const id = e.querySelector('.pitcher-name').dataset.playerId;
                
                console.log('Entry:', { ft, name, mlb, date, id });
                
                if (ft && name && mlb && date) {
                    pitchers.push({ fantasyTeam: ft, name, mlbTeam: mlb, gameDate: date, playerId: id });
                }
            });
            
            console.log('Collected pitchers:', pitchers);
            
            if (!pitchers.length) { alert('Add at least one pitcher'); return; }
            
            document.getElementById('reviewResults').innerHTML = '<div class="loading">Fetching...</div>';
            switchTab(1);
            
            gameData = [];
            const notFound = [];
            
            for (const p of pitchers) {
                console.log('Fetching game for:', p.name);
                const g = await fetchGameData(p.playerId, p.mlbTeam, p.gameDate, p.name);
                console.log('Result for', p.name, ':', g);
                if (g) {
                    gameData.push({ ...p, gameTime: g.gameTime, type: g.type, stats: g.stats });
                } else {
                    notFound.push(p);
                }
            }
            
            console.log('Final gameData:', gameData);
            console.log('Not found:', notFound);
            
            if (notFound.length > 0) {
                const names = notFound.map(p => `${p.name} (${p.mlbTeam}, ${p.gameDate})`).join('\n');
                alert(`‚ö†Ô∏è Could not find game data for:\n\n${names}\n\nMost common reasons:\n\n1. Pitcher did NOT actually pitch that day\n   ‚Üí Check MLB.com game logs to verify\n\n2. Wrong team abbreviation\n   ‚Üí Use: NYY, BOS, PHI, MIA, etc.\n\n3. Game was postponed/cancelled\n\n4. Pitcher was on roster but didn't appear\n\nCheck browser console (F12) for detailed logs.`);
            }
            
            displayReview();
        }
        
        async function fetchGameData(id, team, date, name) {
            try {
                console.log(`üîç Searching for: ${name} (${team}) on ${date}, ID: ${id || 'none'}`);
                
                const teams = {NYY:147,BOS:111,TOR:141,TB:139,BAL:110,CLE:114,MIN:142,CWS:145,CHW:145,DET:116,KC:118,
                              HOU:117,TEX:140,SEA:136,LAA:108,OAK:133,ATL:144,NYM:121,PHI:143,MIA:146,WSH:120,
                              MIL:158,CHC:112,STL:138,PIT:134,CIN:113,LAD:119,SD:135,SF:137,ARI:109,COL:115};
                const tid = teams[team.toUpperCase()];
                
                if (!tid) {
                    console.error('‚ùå Unknown team:', team);
                    return null;
                }
                
                console.log(`üìÖ Fetching schedule for team ${team} (${tid}) on ${date}`);
                const sched = await fetch(`https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=${tid}&startDate=${date}&endDate=${date}`);
                const sd = await sched.json();
                
                if (!sd.dates || !sd.dates.length) {
                    console.log('‚ùå No games found for', team, 'on', date);
                    return null;
                }
                
                console.log(`Found ${sd.dates[0].games.length} game(s)`);
                
                for (const dt of sd.dates) {
                    for (const game of dt.games) {
                        console.log(`üì¶ Fetching boxscore for game ${game.gamePk}`);
                        const box = await fetch(`https://statsapi.mlb.com/api/v1/game/${game.gamePk}/boxscore`);
                        const bd = await box.json();
                        
                        let pitcher = null, teamData = null;
                        
                        // Search both teams
                        for (const t of [bd.teams.home, bd.teams.away]) {
                            const teamName = t.team.name;
                            console.log(`  Searching ${teamName} roster...`);
                            
                            for (const [k,p] of Object.entries(t.players || {})) {
                                // Check by ID if available
                                if (id && p.person.id == id) {
                                    console.log(`    ‚úì Found by ID: ${p.person.fullName}`);
                                    if (p.stats?.pitching && (p.stats.pitching.battersFaced > 0 || parseFloat(p.stats.pitching.inningsPitched||0) > 0)) {
                                        pitcher = p; teamData = t; break;
                                    }
                                }
                                // Check by name if no ID
                                if (!id && removeAccents(p.person.fullName.toLowerCase()).includes(removeAccents(name.toLowerCase()))) {
                                    console.log(`    ‚úì Found by name: ${p.person.fullName}`);
                                    if (p.stats?.pitching && (p.stats.pitching.battersFaced > 0 || parseFloat(p.stats.pitching.inningsPitched||0) > 0)) {
                                        pitcher = p; teamData = t; break;
                                    }
                                }
                            }
                            if (pitcher) break;
                        }
                        
                        if (pitcher) {
                            const isStart = teamData.pitchers && teamData.pitchers[0] == pitcher.person.id;
                            
                            // Get pitcher's appearance order (their index in the pitchers array)
                            const pitcherOrder = teamData.pitchers ? teamData.pitchers.indexOf(pitcher.person.id) : 0;
                            
                            // Try to get actual first pitch time, fall back to scheduled time
                            let gameTime = new Date(game.gameDate); // Scheduled time
                            
                            // Check if boxscore has actual game start time
                            if (bd.gameInfo && bd.gameInfo.firstPitch) {
                                gameTime = new Date(bd.gameInfo.firstPitch);
                                console.log(`   Using actual first pitch: ${gameTime.toLocaleTimeString()}`);
                            } else {
                                console.log(`   Using scheduled start: ${gameTime.toLocaleTimeString()} (actual first pitch not available)`);
                            }
                            
                            // Add milliseconds offset based on pitcher order (ensures stable sort for same-game pitchers)
                            gameTime = new Date(gameTime.getTime() + (pitcherOrder * 1000));
                            
                            console.log(`‚úÖ Found ${pitcher.person.fullName} - ${isStart ? 'SP' : 'RP'} (appearance #${pitcherOrder + 1} in game)`);
                            return { gameTime: gameTime, type: isStart ? 'SP' : 'RP', stats: pitcher.stats.pitching };
                        } else {
                            console.log('‚ùå Pitcher not found in this game');
                        }
                    }
                }
                
                console.log(`‚ùå ${name} not found in any games for ${team} on ${date}`);
                return null;
            } catch(e) { 
                console.error('‚ùå Error fetching game:', e); 
                return null; 
            }
        }
        
        function displayReview() {
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            Object.keys(teams).forEach(t => teams[t].sort((a,b) => a.gameTime - b.gameTime));
            
            let html = '<div class="summary-card"><h2>Review by Team</h2></div>';
            Object.keys(teams).sort().forEach((tn, i) => {
                const apps = teams[tn];
                let sp = 0, rp = 0;
                html += `<div class="team-section"><div class="team-header" onclick="toggle(${i})">
                    <h3>${tn}</h3><span id="a${i}">‚ñº</span></div><div id="t${i}" class="team-content">
                    <table><tr><th>#</th><th>Pitcher</th><th>Type</th><th>Time</th><th>Status</th></tr>`;
                apps.forEach((a,j) => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    const statusText = ok ? `‚úì Counts (${a.type === 'SP' ? sp + '/' + maxS + ' SP' : rp + '/' + maxR + ' RP'})` : `‚úó Excluded (${a.type === 'SP' ? sp + '/' + maxS + ' SP' : rp + '/' + maxR + ' RP'})`;
                    html += `<tr class="${ok?'counted':'excluded'}"><td>${j+1}</td><td>${a.name}</td><td>${a.type}</td>
                        <td>${a.gameTime.toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})}</td>
                        <td>${statusText}</td></tr>`;
                });
                html += '</table></div></div>';
            });
            html += '<button class="btn btn-primary" onclick="switchTab(2);calculateStats();" style="width:100%;padding:15px;margin-top:20px;">Continue ‚Üí</button>';
            document.getElementById('reviewResults').innerHTML = html;
        }
        
        function calculateStats() {
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            
            // Build Quick View Dashboard Data
            const dashboardData = [];
            let totalTeamsWithOverages = 0;
            let totalExcludedApps = 0;
            
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                let spOverages = 0, rpOverages = 0;
                let excludedIP = 0;
                const affectedPitchers = new Set();
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    if (!ok) {
                        if (a.type === 'SP') spOverages++;
                        else rpOverages++;
                        
                        totalExcludedApps++;
                        affectedPitchers.add(a.name);
                        
                        const stats = a.stats || {};
                        excludedIP += parseIP(stats.inningsPitched || 0);
                    }
                });
                
                if (spOverages > 0 || rpOverages > 0) {
                    totalTeamsWithOverages++;
                    dashboardData.push({
                        team: tn,
                        spOverages,
                        rpOverages,
                        excludedIP,
                        affectedPitchers: affectedPitchers.size
                    });
                }
            });
            
            // Build Dashboard HTML
            let html = '<div class="summary-card"><h2>Commissioner Quick View</h2></div>';
            
            // Traffic Light Summary
            const totalTeams = Object.keys(teams).length;
            const teamsNoOverages = totalTeams - totalTeamsWithOverages;
            
            html += `<div style="background:#1f2937;padding:25px;border-radius:12px;margin-bottom:20px;border:2px solid #374151;box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                <h3 style="margin:0 0 20px 0;color:#e5e7eb;font-size:20px;">Weekly Overview</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;">
                    <div style="background:#111827;padding:20px;border-radius:8px;border-left:4px solid #10b981;box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                        <div style="font-size:48px;font-weight:bold;color:#10b981;">${teamsNoOverages}</div>
                        <div style="font-size:14px;color:#9ca3af;margin-top:8px;">Teams - No Overages</div>
                    </div>
                    <div style="background:#111827;padding:20px;border-radius:8px;border-left:4px solid #ef4444;box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                        <div style="font-size:48px;font-weight:bold;color:#ef4444;">${totalTeamsWithOverages}</div>
                        <div style="font-size:14px;color:#9ca3af;margin-top:8px;">Teams - With Overages</div>
                    </div>
                    <div style="background:#111827;padding:20px;border-radius:8px;border-left:4px solid #f59e0b;box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                        <div style="font-size:48px;font-weight:bold;color:#f59e0b;">${totalExcludedApps}</div>
                        <div style="font-size:14px;color:#9ca3af;margin-top:8px;">Total Excluded Apps</div>
                    </div>
                </div>
            </div>`;
            
            // Teams Requiring Adjustments Table
            if (dashboardData.length > 0) {
                html += `<div style="background:#1f2937;border:2px solid #f59e0b;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                    <h3 style="margin:0 0 15px 0;color:#fbbf24;display:flex;align-items:center;gap:10px;font-size:18px;"><span style="font-size:24px;">‚ö†Ô∏è</span> Teams Requiring Manual Adjustments</h3>
                    <table style="width:100%;border-collapse:collapse;">
                        <tr style="background:#374151;">
                            <th style="padding:12px;text-align:left;border-bottom:2px solid #4b5563;color:#e5e7eb;font-weight:600;">Team</th>
                            <th style="padding:12px;text-align:center;border-bottom:2px solid #4b5563;color:#e5e7eb;font-weight:600;">SP Overages</th>
                            <th style="padding:12px;text-align:center;border-bottom:2px solid #4b5563;color:#e5e7eb;font-weight:600;">RP Overages</th>
                            <th style="padding:12px;text-align:center;border-bottom:2px solid #4b5563;color:#e5e7eb;font-weight:600;">IP to Remove</th>
                            <th style="padding:12px;text-align:center;border-bottom:2px solid #4b5563;color:#e5e7eb;font-weight:600;">Pitchers Affected</th>
                        </tr>`;
                
                dashboardData.forEach(d => {
                    html += `<tr style="border-bottom:1px solid #374151;background:#111827;">
                        <td style="padding:12px;font-weight:600;color:#e5e7eb;">${d.team}</td>
                        <td style="padding:12px;text-align:center;color:${d.spOverages > 0 ? '#ef4444' : '#6b7280'};">${d.spOverages > 0 ? d.spOverages : '-'}</td>
                        <td style="padding:12px;text-align:center;color:${d.rpOverages > 0 ? '#ef4444' : '#6b7280'};">${d.rpOverages > 0 ? d.rpOverages : '-'}</td>
                        <td style="padding:12px;text-align:center;font-weight:600;color:#fbbf24;">${d.excludedIP.toFixed(1)}</td>
                        <td style="padding:12px;text-align:center;color:#9ca3af;">${d.affectedPitchers}</td>
                    </tr>`;
                });
                
                html += `</table></div>`;
            } else {
                html += `<div style="background:#1f2937;border:2px solid #10b981;padding:20px;border-radius:12px;margin-bottom:20px;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                    <h3 style="margin:0 0 10px 0;color:#34d399;font-size:22px;">‚úÖ No Overages This Week!</h3>
                    <p style="margin:0;color:#9ca3af;font-size:15px;">All teams stayed within limits.</p>
                </div>`;
            }
            
            html += '<div class="summary-card"><h2>Detailed Stats by Team</h2><div style="display:flex;gap:10px;"><button class="btn btn-success" onclick="exportCSV()">üìä Export CSV</button><button class="btn btn-primary" onclick="exportExcel()">üìó Export Excel</button></div></div>';
            
            Object.keys(teams).sort().forEach((tn,i) => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0, total = 0;
                const pitchers = {};
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    if (!pitchers[a.name]) pitchers[a.name] = {counted:[],excluded:[]};
                    (ok ? pitchers[a.name].counted : pitchers[a.name].excluded).push(a);
                });
                
                html += `<div class="team-section"><div class="team-header" onclick="toggleC(${i})">
                    <h3>${tn}</h3><span id="ca${i}">‚ñº</span></div><div id="c${i}" class="team-content">`;
                
                Object.keys(pitchers).forEach(pn => {
                    const p = pitchers[pn];
                    const all = [...p.counted, ...p.excluded];
                    let ip=0,er=0,k=0,bb=0,h=0,hb=0,sv=0,hld=0,qs=0;
                    all.forEach(a => {
                        if (a.stats) {
                            ip += parseIP(a.stats.inningsPitched);
                            er += parseInt(a.stats.earnedRuns||0);
                            k += parseInt(a.stats.strikeOuts||0);
                            bb += parseInt(a.stats.baseOnBalls||0);
                            h += parseInt(a.stats.hits||0);
                            hb += parseInt(a.stats.hitBatsmen||0);
                            sv += parseInt(a.stats.saves||0);
                            hld += parseInt(a.stats.holds||0);
                            // QS: 6+ IP with 3 or fewer ER
                            const gameIP = parseIP(a.stats.inningsPitched||0);
                            const gameER = parseInt(a.stats.earnedRuns||0);
                            if (gameIP >= 6 && gameER <= 3) qs++;
                        }
                    });
                    
                    // NEW LEAGUE RULES - H2H Categories (no points)
                    // Categories: IP, QS, K, ERA, SVH (Saves+Holds), BB+HBP
                    const svh = sv + hld; // Saves + Holds combined
                    const bbhbp = bb + hb; // Walks + Hit By Pitch combined
                    const era = ip > 0 ? (er * 9) / ip : 0; // ERA calculation
                    
                    // For display purposes, show if appearances were counted or excluded
                    // (In new system, stats still count but need manual removal by commissioner)
                    
                    // Determine color based on counted vs excluded appearances
                    let borderColor, textColor;
                    if (p.counted.length > 0 && p.excluded.length === 0) {
                        borderColor = '#10b981';
                        textColor = '#10b981';
                    } else if (p.counted.length === 0 && p.excluded.length > 0) {
                        borderColor = '#ef4444';
                        textColor = '#ef4444';
                    } else {
                        borderColor = '#f59e0b';
                        textColor = '#f59e0b';
                    }
                    
                    total += ip;
                    html += `<div style="background:#1f2937;padding:20px;margin:15px 0;border-radius:8px;border-left:5px solid ${borderColor};box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                            <strong style="font-size:18px;color:#e5e7eb;">${pn}</strong>
                            <strong style="font-size:20px;color:${textColor};">${ip.toFixed(1)} IP</strong>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;background:#111827;padding:15px;border-radius:6px;">
                            <div>
                                <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px;">Innings Pitched</div>
                                <div style="font-size:18px;font-weight:600;color:#e5e7eb;margin-top:4px;">${ip.toFixed(1)}</div>
                            </div>
                            <div>
                                <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px;">Strikeouts</div>
                                <div style="font-size:18px;font-weight:600;color:#60a5fa;margin-top:4px;">${k}</div>
                            </div>
                            <div>
                                <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px;">Quality Starts</div>
                                <div style="font-size:18px;font-weight:600;color:#34d399;margin-top:4px;">${qs}</div>
                            </div>
                            <div>
                                <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px;">ERA</div>
                                <div style="font-size:18px;font-weight:600;color:#f59e0b;margin-top:4px;">${era.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px;">Saves + Holds</div>
                                <div style="font-size:18px;font-weight:600;color:#a78bfa;margin-top:4px;">${svh}</div>
                            </div>
                            <div>
                                <div style="font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px;">BB + HBP</div>
                                <div style="font-size:18px;font-weight:600;color:#ef4444;margin-top:4px;">${bbhbp}</div>
                            </div>
                        </div>
                        <div style="font-size:13px;color:#9ca3af;margin-top:12px;padding-top:12px;border-top:1px solid #374151;">
                            <span style="color:#10b981;">‚úì ${p.counted.length} counted</span>
                            ${p.excluded.length > 0 ? `<span style="color:#ef4444;margin-left:15px;">‚úó ${p.excluded.length} excluded</span>` : ''}
                        </div>
                    </div>`;
                });
                
                // Calculate combined team stats (only counted appearances)
                let teamIP=0, teamER=0, teamK=0, teamBB=0, teamH=0, teamHB=0, teamSV=0, teamHLD=0, teamQS=0;
                let spCount = 0, rpCount = 0;
                apps.forEach(a => {
                    if (a.type === 'SP') spCount++; else rpCount++;
                    const ok = (a.type === 'SP' && spCount <= maxS) || (a.type === 'RP' && rpCount <= maxR);
                    if (ok && a.stats) {
                        teamIP += parseIP(a.stats.inningsPitched||0);
                        teamER += parseInt(a.stats.earnedRuns||0);
                        teamK += parseInt(a.stats.strikeOuts||0);
                        teamBB += parseInt(a.stats.baseOnBalls||0);
                        teamH += parseInt(a.stats.hits||0);
                        teamHB += parseInt(a.stats.hitBatsmen||0);
                        teamSV += parseInt(a.stats.saves||0);
                        teamHLD += parseInt(a.stats.holds||0);
                        const gameIP = parseIP(a.stats.inningsPitched||0);
                        const gameER = parseInt(a.stats.earnedRuns||0);
                        if (gameIP >= 6 && gameER <= 3) teamQS++;
                    }
                });
                
                const teamSVH = teamSV + teamHLD;
                const teamBBHBP = teamBB + teamHB;
                const teamERA = teamIP > 0 ? (teamER * 9) / teamIP : 0;
                
                html += `<div style="background:#f3f4f6;padding:15px;border-radius:6px;margin-top:15px;border:2px solid #d1d5db;">
                    <strong style="font-size:14px;">Combined Team Stats (Counted Only)</strong>
                    <div style="font-size:13px;color:#374151;margin-top:8px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                        <div><strong>IP:</strong> ${teamIP.toFixed(1)}</div>
                        <div><strong>K:</strong> ${teamK}</div>
                        <div><strong>QS:</strong> ${teamQS}</div>
                        <div><strong>ERA:</strong> ${teamERA.toFixed(2)}</div>
                        <div><strong>SVH:</strong> ${teamSVH}</div>
                        <div><strong>BB+HBP:</strong> ${teamBBHBP}</div>
                    </div></div>`;
                
                html += `<div style="background:#667eea;color:white;padding:15px;border-radius:6px;margin-top:15px;">
                    <strong>Team Total IP (Counted): ${total.toFixed(1)}</strong></div></div></div>`;
            });
            document.getElementById('calcResults').innerHTML = html;
        }
        
        function parseIP(s) {
            if (!s) return 0;
            const f = parseFloat(s), w = Math.floor(f), d = Math.round((f-w)*10);
            return d === 1 ? w + 1/3 : d === 2 ? w + 2/3 : w;
        }
        
        function exportCSV() {
            const ws = document.getElementById('weekStart').value;
            const we = document.getElementById('weekEnd').value;
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            
            let csv = 'Matchup Period,Max Starts,Max Relief\n';
            csv += `"${ws} to ${we}",${maxS},${maxR}\n\n`;
            
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            
            // Add summary section FIRST
            csv += 'Summary by Team - H2H CATEGORIES\n';
            csv += 'Fantasy Team,Total IP (All),IP to Remove,Corrected IP,Total K (All),K to Remove,Corrected K,Total QS (All),QS to Remove,Corrected QS,Total SVH (All),SVH to Remove,Corrected SVH,Total BB+HBP (All),BB+HBP to Remove,Corrected BB+HBP,Weighted ERA (All),ERA (Counted Only)\n';
            
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                let allIP=0, allER=0, allK=0, allBB=0, allHB=0, allSV=0, allHLD=0, allQS=0;
                let countedIP=0, countedER=0, countedK=0, countedBB=0, countedHB=0, countedSV=0, countedHLD=0, countedQS=0;
                let removedIP=0, removedER=0, removedK=0, removedBB=0, removedHB=0, removedSV=0, removedHLD=0, removedQS=0;
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    const stats = a.stats || {};
                    const ip = parseIP(stats.inningsPitched || 0);
                    const er = parseInt(stats.earnedRuns || 0);
                    const k = parseInt(stats.strikeOuts || 0);
                    const bb = parseInt(stats.baseOnBalls || 0);
                    const hb = parseInt(stats.hitBatsmen || 0);
                    const sv = parseInt(stats.saves || 0);
                    const hld = parseInt(stats.holds || 0);
                    const qs = (ip >= 6 && er <= 3) ? 1 : 0;
                    
                    // Add to ALL totals
                    allIP += ip;
                    allER += er;
                    allK += k;
                    allBB += bb;
                    allHB += hb;
                    allSV += sv;
                    allHLD += hld;
                    allQS += qs;
                    
                    if (ok) {
                        countedIP += ip;
                        countedER += er;
                        countedK += k;
                        countedBB += bb;
                        countedHB += hb;
                        countedSV += sv;
                        countedHLD += hld;
                        countedQS += qs;
                    } else {
                        removedIP += ip;
                        removedER += er;
                        removedK += k;
                        removedBB += bb;
                        removedHB += hb;
                        removedSV += sv;
                        removedHLD += hld;
                        removedQS += qs;
                    }
                });
                
                const allSVH = allSV + allHLD;
                const allBBHBP = allBB + allHB;
                const countedSVH = countedSV + countedHLD;
                const countedBBHBP = countedBB + countedHB;
                const removedSVH = removedSV + removedHLD;
                const removedBBHBP = removedBB + removedHB;
                const allERA = allIP > 0 ? (allER * 9) / allIP : 0;
                const countedERA = countedIP > 0 ? (countedER * 9) / countedIP : 0;
                
                csv += `"${tn}",${allIP.toFixed(1)},${removedIP.toFixed(1)},${countedIP.toFixed(1)},${allK},${removedK},${countedK},${allQS},${removedQS},${countedQS},${allSVH},${removedSVH},${countedSVH},${allBBHBP},${removedBBHBP},${countedBBHBP},${allERA.toFixed(2)},${countedERA.toFixed(2)}\n`;
            });
            
            // NEW SECTION: Players Requiring Manual Adjustment (only excluded appearances)
            csv += '\n\nPlayers Requiring Manual Adjustment\n';
            csv += 'Fantasy Team,Pitcher,# Excluded Apps,IP to Remove,ER to Remove,K to Remove,BB to Remove,HB to Remove,SV to Remove,HLD to Remove,QS to Remove,SVH to Remove,BB+HBP to Remove,ERA of Excluded\n';
            
            // Internal check: Build player-level exclusions
            const playerExclusions = {};
            
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    // Only track EXCLUDED appearances
                    if (!ok) {
                        const playerKey = `${tn}|||${a.name}`; // Use delimiter to prevent collision
                        
                        if (!playerExclusions[playerKey]) {
                            playerExclusions[playerKey] = {
                                team: tn,
                                name: a.name,
                                count: 0,
                                ip: 0, er: 0, k: 0, bb: 0, hb: 0, sv: 0, hld: 0, qs: 0
                            };
                        }
                        
                        const stats = a.stats || {};
                        const ip = parseIP(stats.inningsPitched || 0);
                        const er = parseInt(stats.earnedRuns || 0);
                        const k = parseInt(stats.strikeOuts || 0);
                        const bb = parseInt(stats.baseOnBalls || 0);
                        const hb = parseInt(stats.hitBatsmen || 0);
                        const sv = parseInt(stats.saves || 0);
                        const hld = parseInt(stats.holds || 0);
                        const qs = (ip >= 6 && er <= 3) ? 1 : 0;
                        
                        playerExclusions[playerKey].count++;
                        playerExclusions[playerKey].ip += ip;
                        playerExclusions[playerKey].er += er;
                        playerExclusions[playerKey].k += k;
                        playerExclusions[playerKey].bb += bb;
                        playerExclusions[playerKey].hb += hb;
                        playerExclusions[playerKey].sv += sv;
                        playerExclusions[playerKey].hld += hld;
                        playerExclusions[playerKey].qs += qs;
                    }
                });
            });
            
            // Internal check: Verify all excluded stats are accounted for
            let totalExcludedIP = 0;
            
            // Write player exclusions to CSV
            Object.keys(playerExclusions).sort().forEach(key => {
                const p = playerExclusions[key];
                const svh = p.sv + p.hld;
                const bbhbp = p.bb + p.hb;
                const era = p.ip > 0 ? (p.er * 9) / p.ip : 0;
                
                totalExcludedIP += p.ip; // Track for validation
                
                csv += `"${p.team}","${p.name}",${p.count},${p.ip.toFixed(1)},${p.er},${p.k},${p.bb},${p.hb},${p.sv},${p.hld},${p.qs},${svh},${bbhbp},${era.toFixed(2)}\n`;
            });
            
            // If no exclusions, add a note
            if (Object.keys(playerExclusions).length === 0) {
                csv += 'No players with excluded appearances this week\n';
            }
            
            // Now add detailed breakdown
            csv += '\n\nDetailed Breakdown by Appearance\n';
            csv += 'Fantasy Team,Pitcher,MLB Team,Game Date,Game Time (ET),Type,Status,IP,ER,K,BB,HB,SV,HLD,QS,SVH,BB+HBP,ERA\n';
            
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    // Calculate stats for this appearance
                    const stats = a.stats || {};
                    const ip = parseIP(stats.inningsPitched || 0);
                    const er = parseInt(stats.earnedRuns || 0);
                    const k = parseInt(stats.strikeOuts || 0);
                    const bb = parseInt(stats.baseOnBalls || 0);
                    const hb = parseInt(stats.hitBatsmen || 0);
                    const sv = parseInt(stats.saves || 0);
                    const hld = parseInt(stats.holds || 0);
                    const qs = (ip >= 6 && er <= 3) ? 1 : 0;
                    const svh = sv + hld;
                    const bbhbp = bb + hb;
                    const era = ip > 0 ? (er * 9) / ip : 0;
                    
                    const date = a.gameTime.toLocaleDateString('en-US', {month: 'numeric', day: 'numeric', year: 'numeric'});
                    const time = a.gameTime.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true});
                    
                    csv += `"${tn}","${a.name}","${a.mlbTeam}","${date}","${time}","${a.type}","${ok?'COUNTS':'EXCLUDED'}",`;
                    csv += `${ip.toFixed(1)},${er},${k},${bb},${hb},${sv},${hld},${qs},${svh},${bbhbp},${era.toFixed(2)}\n`;
                });
            });
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Pitcher_Overages_${ws}_to_${we}.csv`;
            a.click();
        }
        
        function exportExcel() {
            // Internal check: Verify XLSX library is loaded
            if (typeof XLSX === 'undefined') {
                alert('Excel export library not loaded. Please refresh the page and try again.');
                return;
            }
            
            const ws_date = document.getElementById('weekStart').value;
            const we_date = document.getElementById('weekEnd').value;
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // SHEET 0: QUICK REFERENCE (NEW - Condensed Commissioner View)
            const quickData = [];
            quickData.push(['QUICK REFERENCE - Commissioner Adjustments']);
            quickData.push([`Week: ${ws_date} to ${we_date}`]);
            quickData.push([]);
            
            // Build quick reference table
            const quickTeams = [];
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                let removedIP = 0, removedK = 0, removedQS = 0, removedSVH = 0, removedBBHBP = 0;
                let pitcherNames = [];
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    if (!ok) {
                        const stats = a.stats || {};
                        const ip = parseIP(stats.inningsPitched || 0);
                        removedIP += ip;
                        removedK += parseInt(stats.strikeOuts || 0);
                        if (ip >= 6 && parseInt(stats.earnedRuns || 0) <= 3) removedQS++;
                        removedSVH += parseInt(stats.saves || 0) + parseInt(stats.holds || 0);
                        removedBBHBP += parseInt(stats.baseOnBalls || 0) + parseInt(stats.hitBatsmen || 0);
                        
                        if (!pitcherNames.includes(a.name)) pitcherNames.push(a.name);
                    }
                });
                
                if (removedIP > 0) {
                    quickTeams.push({
                        team: tn,
                        pitchers: pitcherNames.join(', '),
                        ip: removedIP,
                        k: removedK,
                        qs: removedQS,
                        svh: removedSVH,
                        bbhbp: removedBBHBP
                    });
                }
            });
            
            if (quickTeams.length > 0) {
                quickData.push(['Team', 'Pitchers to Adjust', 'Remove IP', 'Remove K', 'Remove QS', 'Remove SVH', 'Remove BB+HBP']);
                quickTeams.forEach(t => {
                    quickData.push([t.team, t.pitchers, t.ip, t.k, t.qs, t.svh, t.bbhbp]);
                });
            } else {
                quickData.push(['No adjustments needed this week!']);
            }
            
            const ws_quick = XLSX.utils.aoa_to_sheet(quickData);
            
            // Apply formatting to Quick Reference sheet
            const quickRange = XLSX.utils.decode_range(ws_quick['!ref']);
            for (let R = quickRange.s.r; R <= quickRange.e.r; ++R) {
                for (let C = quickRange.s.c; C <= quickRange.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    if (!ws_quick[cellAddress]) continue;
                    
                    // Apply styles
                    if (!ws_quick[cellAddress].s) ws_quick[cellAddress].s = {};
                    
                    // Header row (row 3 in quick ref)
                    if (R === 3) {
                        ws_quick[cellAddress].s = {
                            font: { bold: true, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "374151" } },
                            alignment: { horizontal: "center", vertical: "center" }
                        };
                    }
                    // Data rows - alternating colors
                    else if (R > 3) {
                        ws_quick[cellAddress].s = {
                            fill: { fgColor: { rgb: R % 2 === 0 ? "1F2937" : "111827" } },
                            alignment: { horizontal: "center", vertical: "center" },
                            font: { color: { rgb: "E5E7EB" } }
                        };
                    }
                }
            }
            
            // Set column widths for Quick Reference
            ws_quick['!cols'] = [
                {wch: 15}, // Team
                {wch: 30}, // Pitchers
                {wch: 12}, // IP
                {wch: 10}, // K
                {wch: 10}, // QS
                {wch: 10}, // SVH
                {wch: 12}  // BB+HBP
            ];
            
            XLSX.utils.book_append_sheet(wb, ws_quick, 'Quick Reference');
            
            // SHEET 1: Summary by Team
            const summaryData = [];
            summaryData.push(['Matchup Period', 'Max Starts', 'Max Relief']);
            summaryData.push([`${ws_date} to ${we_date}`, maxS, maxR]);
            summaryData.push([]);
            summaryData.push(['Summary by Team - H2H CATEGORIES']);
            summaryData.push(['Fantasy Team', 'Total IP (All)', 'IP to Remove', 'Corrected IP', 'Total K (All)', 'K to Remove', 'Corrected K', 'Total QS (All)', 'QS to Remove', 'Corrected QS', 'Total SVH (All)', 'SVH to Remove', 'Corrected SVH', 'Total BB+HBP (All)', 'BB+HBP to Remove', 'Corrected BB+HBP', 'Weighted ERA (All)', 'ERA (Counted Only)']);
            
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                let allIP=0, allER=0, allK=0, allBB=0, allHB=0, allSV=0, allHLD=0, allQS=0;
                let countedIP=0, countedER=0, countedK=0, countedBB=0, countedHB=0, countedSV=0, countedHLD=0, countedQS=0;
                let removedIP=0, removedER=0, removedK=0, removedBB=0, removedHB=0, removedSV=0, removedHLD=0, removedQS=0;
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    const stats = a.stats || {};
                    const ip = parseIP(stats.inningsPitched || 0);
                    const er = parseInt(stats.earnedRuns || 0);
                    const k = parseInt(stats.strikeOuts || 0);
                    const bb = parseInt(stats.baseOnBalls || 0);
                    const hb = parseInt(stats.hitBatsmen || 0);
                    const sv = parseInt(stats.saves || 0);
                    const hld = parseInt(stats.holds || 0);
                    const qs = (ip >= 6 && er <= 3) ? 1 : 0;
                    
                    allIP += ip; allER += er; allK += k; allBB += bb; allHB += hb; allSV += sv; allHLD += hld; allQS += qs;
                    
                    if (ok) {
                        countedIP += ip; countedER += er; countedK += k; countedBB += bb; countedHB += hb; countedSV += sv; countedHLD += hld; countedQS += qs;
                    } else {
                        removedIP += ip; removedER += er; removedK += k; removedBB += bb; removedHB += hb; removedSV += sv; removedHLD += hld; removedQS += qs;
                    }
                });
                
                const allSVH = allSV + allHLD;
                const allBBHBP = allBB + allHB;
                const countedSVH = countedSV + countedHLD;
                const countedBBHBP = countedBB + countedHB;
                const removedSVH = removedSV + removedHLD;
                const removedBBHBP = removedBB + removedHB;
                const allERA = allIP > 0 ? (allER * 9) / allIP : 0;
                const countedERA = countedIP > 0 ? (countedER * 9) / countedIP : 0;
                
                summaryData.push([tn, allIP, removedIP, countedIP, allK, removedK, countedK, allQS, removedQS, countedQS, allSVH, removedSVH, countedSVH, allBBHBP, removedBBHBP, countedBBHBP, allERA, countedERA]);
            });
            
            const ws_summary = XLSX.utils.aoa_to_sheet(summaryData);
            
            // Format Summary sheet: center align all cells, alternating rows
            const sumRange = XLSX.utils.decode_range(ws_summary['!ref']);
            for (let R = sumRange.s.r; R <= sumRange.e.r; ++R) {
                for (let C = sumRange.s.c; C <= sumRange.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    if (!ws_summary[cellAddress]) continue;
                    
                    if (!ws_summary[cellAddress].s) ws_summary[cellAddress].s = {};
                    
                    // Header row (row 4)
                    if (R === 4) {
                        ws_summary[cellAddress].s = {
                            font: { bold: true },
                            alignment: { horizontal: "center", vertical: "center" }
                        };
                    }
                    // Data rows - center align with alternating colors
                    else if (R > 4) {
                        ws_summary[cellAddress].s = {
                            alignment: { horizontal: "center", vertical: "center" },
                            fill: { fgColor: { rgb: R % 2 === 0 ? "F3F4F6" : "FFFFFF" } }
                        };
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, ws_summary, 'Summary');
            
            // SHEET 2: Players Requiring Adjustment (Hierarchical by Team)
            const playersData = [];
            playersData.push(['PLAYERS REQUIRING MANUAL ADJUSTMENT']);
            playersData.push(['Organized by Team for Easy Reference']);
            playersData.push([]);
            
            const playerExclusions = {};
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    if (!ok) {
                        const playerKey = `${tn}|||${a.name}`;
                        
                        if (!playerExclusions[playerKey]) {
                            playerExclusions[playerKey] = {
                                team: tn, name: a.name, count: 0,
                                ip: 0, er: 0, k: 0, bb: 0, hb: 0, sv: 0, hld: 0, qs: 0
                            };
                        }
                        
                        const stats = a.stats || {};
                        const ip = parseIP(stats.inningsPitched || 0);
                        const er = parseInt(stats.earnedRuns || 0);
                        const k = parseInt(stats.strikeOuts || 0);
                        const bb = parseInt(stats.baseOnBalls || 0);
                        const hb = parseInt(stats.hitBatsmen || 0);
                        const sv = parseInt(stats.saves || 0);
                        const hld = parseInt(stats.holds || 0);
                        const qs = (ip >= 6 && er <= 3) ? 1 : 0;
                        
                        playerExclusions[playerKey].count++;
                        playerExclusions[playerKey].ip += ip;
                        playerExclusions[playerKey].er += er;
                        playerExclusions[playerKey].k += k;
                        playerExclusions[playerKey].bb += bb;
                        playerExclusions[playerKey].hb += hb;
                        playerExclusions[playerKey].sv += sv;
                        playerExclusions[playerKey].hld += hld;
                        playerExclusions[playerKey].qs += qs;
                    }
                });
            });
            
            // Organize by team for hierarchical display
            const teamPlayerMap = {};
            Object.keys(playerExclusions).forEach(key => {
                const p = playerExclusions[key];
                if (!teamPlayerMap[p.team]) {
                    teamPlayerMap[p.team] = [];
                }
                teamPlayerMap[p.team].push(p);
            });
            
            // Write hierarchical structure
            if (Object.keys(teamPlayerMap).length === 0) {
                playersData.push(['No teams with excluded appearances this week']);
            } else {
                Object.keys(teamPlayerMap).sort().forEach(teamName => {
                    // Team header row
                    playersData.push([`TEAM: ${teamName}`]);
                    playersData.push(['Player', '# Apps', 'IP', 'ER', 'K', 'BB', 'HB', 'SV', 'HLD', 'QS', 'SVH', 'BB+HBP', 'ERA']);
                    
                    // Player rows for this team
                    teamPlayerMap[teamName].forEach(p => {
                        const svh = p.sv + p.hld;
                        const bbhbp = p.bb + p.hb;
                        const era = p.ip > 0 ? (p.er * 9) / p.ip : 0;
                        
                        playersData.push([
                            `  ${p.name}`, // Indent player name
                            p.count,
                            p.ip,
                            p.er,
                            p.k,
                            p.bb,
                            p.hb,
                            p.sv,
                            p.hld,
                            p.qs,
                            svh,
                            bbhbp,
                            era
                        ]);
                    });
                    
                    // Blank row between teams
                    playersData.push([]);
                });
            }
            
            const ws_players = XLSX.utils.aoa_to_sheet(playersData);
            
            // Format Players sheet: center align, alternating colors
            if (ws_players['!ref']) {
                const plRange = XLSX.utils.decode_range(ws_players['!ref']);
                for (let R = plRange.s.r; R <= plRange.e.r; ++R) {
                    for (let C = plRange.s.c; C <= plRange.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                        if (!ws_players[cellAddress]) continue;
                        
                        if (!ws_players[cellAddress].s) ws_players[cellAddress].s = {};
                        
                        // Team header rows (contain "TEAM:")
                        if (ws_players[cellAddress].v && typeof ws_players[cellAddress].v === 'string' && ws_players[cellAddress].v.includes('TEAM:')) {
                            ws_players[cellAddress].s = {
                                font: { bold: true, color: { rgb: "FFFFFF" } },
                                fill: { fgColor: { rgb: "3B82F6" } },
                                alignment: { horizontal: "left", vertical: "center" }
                            };
                        }
                        // Column header rows (Player, # Apps, etc.)
                        else if (ws_players[cellAddress].v === 'Player' || ws_players[cellAddress].v === '# Apps') {
                            ws_players[cellAddress].s = {
                                font: { bold: true },
                                fill: { fgColor: { rgb: "374151" } },
                                alignment: { horizontal: "center", vertical: "center" }
                            };
                        }
                        // Data rows
                        else if (R > 2) {
                            ws_players[cellAddress].s = {
                                alignment: { horizontal: "center", vertical: "center" },
                                fill: { fgColor: { rgb: R % 2 === 0 ? "F3F4F6" : "FFFFFF" } }
                            };
                        }
                    }
                }
                
                ws_players['!cols'] = [{wch: 20}, {wch: 10}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 10}, {wch: 12}, {wch: 10}];
            }
            
            XLSX.utils.book_append_sheet(wb, ws_players, 'Players to Adjust');
            
            // SHEET 3: Detailed Breakdown
            const detailData = [];
            detailData.push(['Detailed Breakdown by Appearance']);
            detailData.push(['Fantasy Team', 'Pitcher', 'MLB Team', 'Game Date', 'Game Time (ET)', 'Type', 'Status', 'IP', 'ER', 'K', 'BB', 'HB', 'SV', 'HLD', 'QS', 'SVH', 'BB+HBP', 'ERA']);
            
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    const stats = a.stats || {};
                    const ip = parseIP(stats.inningsPitched || 0);
                    const er = parseInt(stats.earnedRuns || 0);
                    const k = parseInt(stats.strikeOuts || 0);
                    const bb = parseInt(stats.baseOnBalls || 0);
                    const hb = parseInt(stats.hitBatsmen || 0);
                    const sv = parseInt(stats.saves || 0);
                    const hld = parseInt(stats.holds || 0);
                    const qs = (ip >= 6 && er <= 3) ? 1 : 0;
                    const svh = sv + hld;
                    const bbhbp = bb + hb;
                    const era = ip > 0 ? (er * 9) / ip : 0;
                    
                    const date = a.gameTime.toLocaleDateString('en-US', {month: 'numeric', day: 'numeric', year: 'numeric'});
                    const time = a.gameTime.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true});
                    
                    detailData.push([tn, a.name, a.mlbTeam, date, time, a.type, ok?'COUNTS':'EXCLUDED', ip, er, k, bb, hb, sv, hld, qs, svh, bbhbp, era]);
                });
            });
            
            const ws_detail = XLSX.utils.aoa_to_sheet(detailData);
            
            // Format Detail sheet: center align, alternating colors
            const detRange = XLSX.utils.decode_range(ws_detail['!ref']);
            for (let R = detRange.s.r; R <= detRange.e.r; ++R) {
                for (let C = detRange.s.c; C <= detRange.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                    if (!ws_detail[cellAddress]) continue;
                    
                    if (!ws_detail[cellAddress].s) ws_detail[cellAddress].s = {};
                    
                    // Header row (row 1)
                    if (R === 1) {
                        ws_detail[cellAddress].s = {
                            font: { bold: true },
                            fill: { fgColor: { rgb: "374151" } },
                            alignment: { horizontal: "center", vertical: "center" }
                        };
                    }
                    // Data rows - alternating colors
                    else if (R > 1) {
                        ws_detail[cellAddress].s = {
                            alignment: { horizontal: "center", vertical: "center" },
                            fill: { fgColor: { rgb: R % 2 === 0 ? "F3F4F6" : "FFFFFF" } }
                        };
                    }
                }
            }
            
            ws_detail['!cols'] = [{wch: 15}, {wch: 18}, {wch: 10}, {wch: 12}, {wch: 14}, {wch: 8}, {wch: 10}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 10}, {wch: 12}, {wch: 10}];
            
            XLSX.utils.book_append_sheet(wb, ws_detail, 'Detailed Breakdown');
            
            // Internal check: Verify all sheets added
            console.log('Excel workbook sheets:', wb.SheetNames);
            
            // Export with proper filename
            XLSX.writeFile(wb, `Pitcher_Overages_${ws_date}_to_${we_date}.xlsx`);
        }
        
        function switchTab(i) {
            document.querySelectorAll('.tab').forEach((t,j) => t.classList.toggle('active', j===i));
            document.querySelectorAll('.tab-content').forEach((c,j) => c.classList.toggle('active', j===i));
        }
        
        function toggle(i) {
            const c = document.getElementById('t'+i), a = document.getElementById('a'+i);
            if (c.style.display === 'none') { c.style.display = 'block'; a.textContent = '‚ñº'; }
            else { c.style.display = 'none'; a.textContent = '‚ñ∂'; }
        }
        
        function toggleC(i) {
            const c = document.getElementById('c'+i), a = document.getElementById('ca'+i);
            if (c.style.display === 'none') { c.style.display = 'block'; a.textContent = '‚ñº'; }
            else { c.style.display = 'none'; a.textContent = '‚ñ∂'; }
        }
        
        function resetAll() { if (confirm('Clear all?')) location.reload(); }
        
        function processBulkPaste() {
            const teamName = document.getElementById('bulkTeamName').value.trim();
            const gameDate = document.getElementById('bulkGameDate').value;
            const pasteText = document.getElementById('bulkPaste').value.trim();
            
            if (!teamName) {
                alert('Please enter a fantasy team name');
                return;
            }
            
            if (!gameDate) {
                alert('Please select a game date');
                return;
            }
            
            if (!pasteText) {
                alert('Please paste pitcher names');
                return;
            }
            
            const weekStart = document.getElementById('weekStart').value;
            const weekEnd = document.getElementById('weekEnd').value;
            
            // Split by newlines and filter out empty lines
            const pitcherNames = pasteText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            if (pitcherNames.length === 0) {
                alert('No pitcher names found');
                return;
            }
            
            // Get container (don't clear - append to existing)
            const container = document.getElementById('pitcherList');
            
            let notFoundCount = 0;
            
            // Add each pitcher with auto-filled team
            pitcherNames.forEach(name => {
                const div = document.createElement('div');
                div.className = 'pitcher-entry';
                
                let mlbTeam = '';
                let pitcherDisplayName = name;
                
                // Try to find the pitcher in MLB database (only if loaded)
                if (typeof mlbPitchers !== 'undefined' && mlbPitchers.length > 0) {
                    const pitcher = mlbPitchers.find(p => 
                        removeAccents(p.fullName.toLowerCase()) === removeAccents(name.toLowerCase()) ||
                        removeAccents(p.fullName.toLowerCase()).includes(removeAccents(name.toLowerCase())) ||
                        removeAccents(name.toLowerCase()).includes(removeAccents(p.fullName.toLowerCase()))
                    );
                    
                    if (pitcher && pitcher.currentTeam) {
                        // Found the pitcher - use their team
                        mlbTeam = pitcher.currentTeam.abbreviation || '';
                        pitcherDisplayName = pitcher.fullName; // Use official name
                    } else {
                        // Not found - mark as N/A
                        mlbTeam = 'N/A';
                        notFoundCount++;
                    }
                } else {
                    // MLB database not loaded yet - leave blank
                    mlbTeam = '';
                }
                
                div.innerHTML = `
                    <div class="form-group"><input type="text" class="fantasy-team" value="${teamName}"></div>
                    <div class="form-group" style="position: relative;">
                        <input type="text" class="pitcher-name" value="${pitcherDisplayName}">
                        <div class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group"><input type="text" class="mlb-team" placeholder="NYY" maxlength="3" value="${mlbTeam}"></div>
                    <div class="form-group"><input type="date" class="game-date" min="${weekStart}" max="${weekEnd}" value="${gameDate}"></div>
                    <button class="btn btn-danger" onclick="removeRow(this)">‚úï</button>
                `;
                container.appendChild(div);
            });
            
            // Clear the textarea
            document.getElementById('bulkPaste').value = '';
            
            // Show appropriate message
            if (typeof mlbPitchers === 'undefined' || mlbPitchers.length === 0) {
                alert(`Added ${pitcherNames.length} pitchers!\n\nMLB database still loading... Teams will need to be filled in manually.`);
            } else if (notFoundCount > 0) {
                alert(`Added ${pitcherNames.length} pitchers!\n\n${notFoundCount} pitcher(s) marked as N/A - not found in 2024 MLB database.\nThey may be rookies, minor leaguers, or check spelling.`);
            } else {
                alert(`‚úÖ Added ${pitcherNames.length} pitchers! All teams auto-filled.`);
            }
        }
        
        async function testFantraxId() {
            const id = document.getElementById('testId').value.trim();
            const resultDiv = document.getElementById('testResult');
            
            if (!id) {
                resultDiv.innerHTML = '‚ö†Ô∏è Please enter an ID';
                return;
            }
            
            resultDiv.innerHTML = 'üîç Testing...';
            
            // Test as League ID
            try {
                const leagueUrl = `https://www.fantrax.com/fxea/general/getLeagueInfo?leagueId=${id}`;
                const leagueRes = await fetch(leagueUrl);
                const leagueData = await leagueRes.json();
                
                if (leagueData && !leagueData.error && leagueData.leagueName) {
                    resultDiv.innerHTML = `‚úÖ <strong>This is a LEAGUE ID!</strong><br>League: ${leagueData.leagueName}<br>Sport: ${leagueData.sport || 'Unknown'}`;
                    return;
                }
            } catch(e) {
                console.log('Not a league ID:', e);
            }
            
            // Test as Secret ID (User ID)
            try {
                const secretUrl = `https://www.fantrax.com/fxea/general/getLeagues?userSecretId=${id}`;
                const secretRes = await fetch(secretUrl);
                const secretData = await secretRes.json();
                
                if (secretData && secretData.leagues && secretData.leagues.length > 0) {
                    const leagueList = secretData.leagues.map(l => `- ${l.leagueName}`).join('<br>');
                    resultDiv.innerHTML = `‚úÖ <strong>This is a SECRET ID!</strong><br>Found ${secretData.leagues.length} leagues:<br>${leagueList}`;
                    return;
                }
            } catch(e) {
                console.log('Not a secret ID:', e);
            }
            
            resultDiv.innerHTML = '‚ùå Could not identify this ID. Make sure it\'s copied correctly from Fantrax.';
        }
    </script>
</body>
</html>
