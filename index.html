<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantrax Pitcher Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 13px;
            color: #374151;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-success { background: #10b981; color: white; }
        .pitcher-entry {
            display: grid;
            grid-template-columns: 1.5fr 2fr 1fr 1.5fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        .search-results {
            position: absolute;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: calc(100% - 4px);
            margin-top: 2px;
        }
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
        }
        .search-result-item:hover { background: #f9fafb; }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .team-section {
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
            overflow: hidden;
        }
        .team-header {
            padding: 20px;
            cursor: pointer;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .team-header:hover { background: #f9fafb; }
        .team-content { padding: 20px; padding-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; }
        .counted { background: #d1fae5; }
        .excluded { background: #fee2e2; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öæ Fantrax Pitcher Tracker</h1>
            <p>Track pitcher overages and calculate corrected scores</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">Step 1: Input</button>
            <button class="tab" onclick="switchTab(1)">Step 2: Review</button>
            <button class="tab" onclick="switchTab(2)">Step 3: Calculate</button>
        </div>
        
        <div class="tab-content active" id="tab0">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2>Week Setup</h2>
                <button class="btn btn-secondary" onclick="resetAll()">üîÑ Clear</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                <div class="form-group">
                    <label>Week Start</label>
                    <input type="date" id="weekStart" onchange="updateWeekEnd()">
                </div>
                <div class="form-group">
                    <label>Week End</label>
                    <input type="date" id="weekEnd" onchange="updateWeekEnd()">
                </div>
                <div class="form-group">
                    <label>Max Starts (SP)</label>
                    <input type="number" id="maxStarts" value="7" min="0">
                </div>
                <div class="form-group">
                    <label>Max Relief (RP)</label>
                    <input type="number" id="maxRP" value="10" min="0">
                </div>
            </div>
            
            <div style="background: #f0f9ff; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">üîó Fantrax Integration</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">League ID</label>
                        <input type="text" id="fantraxLeagueId" value="cbla2gq5mhdvy7q4" style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; width: 100%; font-size: 13px;">
                    </div>
                    <div>
                        <label style="font-size: 13px; font-weight: 600; margin-bottom: 5px; display: block;">Secret ID</label>
                        <input type="text" id="fantraxSecretId" value="vocazvbjlcp76mt9" style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; width: 100%; font-size: 13px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                    <select id="fantraxTeamSelect" style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                        <option value="">-- Select Your Team --</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadFromFantrax()" style="white-space: nowrap;">üì• Load from Fantrax</button>
                </div>
                <div id="fantraxStatus" style="font-size: 12px; color: #6b7280; margin-top: 10px;"></div>
            </div>
            
            <h3>OR Manually Add Pitcher Appearances</h3>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 10px;">
                Add each active appearance for ALL teams with overages
            </p>
            <button class="btn btn-secondary" onclick="loadTestData()" style="margin-bottom: 15px; font-size: 13px;">
                üìã Load Test Data (March 31-Apr 6)
            </button>
            
            <div style="background: #f0f9ff; border: 2px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">üîß Test Fantrax API</h4>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="testId" placeholder="Paste your ID here" style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                    <button class="btn btn-primary" onclick="testFantraxId()">Test ID</button>
                </div>
                <div id="testResult" style="font-size: 13px; color: #374151;"></div>
            </div>
            
            <div id="pitcherList">
                <div class="pitcher-entry">
                    <div class="form-group">
                        <input type="text" class="fantasy-team" placeholder="Fantasy Team">
                    </div>
                    <div class="form-group" style="position: relative;">
                        <input type="text" class="pitcher-name" placeholder="Pitcher Name" autocomplete="off">
                        <div class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <input type="text" class="mlb-team" placeholder="NYY" maxlength="3">
                    </div>
                    <div class="form-group">
                        <input type="date" class="game-date">
                    </div>
                    <button class="btn btn-danger" onclick="removeRow(this)">‚úï</button>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="addRow()">+ Add</button>
            <button class="btn btn-primary" onclick="fetchGames()" style="float: right;">Fetch Games ‚Üí</button>
        </div>
        
        <div class="tab-content" id="tab1">
            <div id="reviewResults"><div class="loading">Complete Step 1</div></div>
        </div>
        
        <div class="tab-content" id="tab2">
            <div id="calcResults"><div class="loading">Complete Steps 1 & 2</div></div>
        </div>
    </div>
    
    <script>
        let allPitchers = [];
        let gameData = [];
        
        window.onload = function() {
            // Set specific test week
            document.getElementById('weekStart').value = '2025-03-31';
            document.getElementById('weekEnd').value = '2025-04-06';
            
            loadMLBPitchers();
            
            // Load Fantrax teams
            loadFantraxTeams();
            
            // Load test data (commented out - using Fantrax now)
            // loadTestData();
            
            document.getElementById('pitcherList').addEventListener('input', function(e) {
                if (e.target.classList.contains('pitcher-name')) {
                    searchPitcher(e.target);
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('pitcher-name')) {
                    document.querySelectorAll('.search-results').forEach(d => d.style.display = 'none');
                }
            });
        };
        
        function loadTestData() {
            const testData = [
                {team: 'Christian', pitcher: 'Justin Slaten', mlb: 'BOS', date: '2025-03-31'},
                {team: 'Christian', pitcher: 'Cristopher S√°nchez', mlb: 'PHI', date: '2025-03-31'},
                {team: 'Christian', pitcher: 'Mason Montgomery', mlb: 'TB', date: '2025-04-01'},
                {team: 'Christian', pitcher: 'Griffin Jax', mlb: 'MIN', date: '2025-04-01'},
                {team: 'Christian', pitcher: 'Ben Joyce', mlb: 'LAA', date: '2025-04-01'},
                {team: 'Christian', pitcher: 'Porter Hodge', mlb: 'CHC', date: '2025-04-01'},
                {team: 'Christian', pitcher: 'Hayden Birdsong', mlb: 'SF', date: '2025-04-02'},
                {team: 'Christian', pitcher: 'Reed Garrett', mlb: 'NYM', date: '2025-04-02'},
                {team: 'Christian', pitcher: 'Porter Hodge', mlb: 'CHC', date: '2025-04-04'},
                {team: 'Christian', pitcher: 'Reed Garrett', mlb: 'NYM', date: '2025-04-04'},
                {team: 'Christian', pitcher: 'Max Fried', mlb: 'NYY', date: '2025-04-04'},
                {team: 'Christian', pitcher: 'Spencer Schwellenbach', mlb: 'ATL', date: '2025-04-04'},
                {team: 'Christian', pitcher: 'Reese Olson', mlb: 'DET', date: '2025-04-05'},
                {team: 'Christian', pitcher: 'Mason Montgomery', mlb: 'TB', date: '2025-04-05'},
                {team: 'Christian', pitcher: 'Hayden Birdsong', mlb: 'SF', date: '2025-04-05'},
                {team: 'Christian', pitcher: 'Bryce Miller', mlb: 'SEA', date: '2025-04-05'},
                {team: 'Christian', pitcher: 'Corbin Burnes', mlb: 'ARI', date: '2025-04-06'},
                {team: 'Christian', pitcher: 'Chase Dollander', mlb: 'COL', date: '2025-04-06'}
            ];
            
            const container = document.getElementById('pitcherList');
            container.innerHTML = ''; // Clear existing
            
            testData.forEach((data, index) => {
                const div = document.createElement('div');
                div.className = 'pitcher-entry';
                div.innerHTML = `
                    <div class="form-group"><input type="text" class="fantasy-team" placeholder="Fantasy Team" value="${data.team}"></div>
                    <div class="form-group" style="position: relative;">
                        <input type="text" class="pitcher-name" placeholder="Pitcher Name" autocomplete="off" value="${data.pitcher}">
                        <div class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group"><input type="text" class="mlb-team" placeholder="NYY" maxlength="3" value="${data.mlb}"></div>
                    <div class="form-group"><input type="date" class="game-date" min="2025-03-31" max="2025-04-06" value="${data.date}"></div>
                    <button class="btn btn-danger" onclick="removeRow(this)">‚úï</button>
                `;
                container.appendChild(div);
            });
            
            console.log('‚úÖ Loaded test data with', testData.length, 'pitchers for March 31 - April 6, 2025');
        }
        
        function updateWeekEnd() {
            const start = document.getElementById('weekStart').value;
            const endInput = document.getElementById('weekEnd');
            
            if (start) {
                // Only auto-fill if week end is empty
                if (!endInput.value) {
                    const d = new Date(start);
                    d.setDate(d.getDate() + 6);
                    endInput.valueAsDate = d;
                }
                
                // Update game date constraints
                const weekEnd = endInput.value;
                if (weekEnd) {
                    document.querySelectorAll('.game-date').forEach(input => {
                        input.min = start;
                        input.max = weekEnd;
                        if (!input.value) input.value = start;
                    });
                }
            }
        }
        
        async function loadMLBPitchers() {
            try {
                const res = await fetch('https://statsapi.mlb.com/api/v1/sports/1/players?season=2024');
                const data = await res.json();
                if (data.people) {
                    allPitchers = data.people
                        .filter(p => p.primaryPosition && p.primaryPosition.abbreviation === 'P')
                        .map(p => ({ name: p.fullName, id: p.id, team: p.currentTeam?.abbreviation || 'FA' }));
                    console.log('‚úÖ Loaded ' + allPitchers.length + ' pitchers');
                    
                    // Check for Chase Dollander specifically
                    const dollander = allPitchers.find(p => p.name.toLowerCase().includes('dollander'));
                    if (dollander) {
                        console.log('Found Chase Dollander:', dollander);
                    } else {
                        console.log('‚ö†Ô∏è Chase Dollander not in 2024 roster (may be rookie/minor leaguer)');
                    }
                }
            } catch(e) { console.error('‚ùå Error loading pitchers:', e); }
        }
        
        function searchPitcher(input) {
            const query = input.value.toLowerCase();
            const div = input.parentElement.querySelector('.search-results');
            if (query.length < 2) { div.style.display = 'none'; return; }
            if (!allPitchers.length) {
                div.innerHTML = '<div class="search-result-item">Loading...</div>';
                div.style.display = 'block';
                return;
            }
            const matches = allPitchers.filter(p => p.name.toLowerCase().includes(query)).slice(0, 10);
            if (!matches.length) {
                div.innerHTML = '<div class="search-result-item">No matches</div>';
                div.style.display = 'block';
                return;
            }
            div.innerHTML = matches.map(p => 
                `<div class="search-result-item" onclick='selectPitcher(this, ${JSON.stringify(p)})'>
                    <strong>${p.name}</strong><span style="color:#6b7280;">${p.team}</span>
                </div>`
            ).join('');
            div.style.display = 'block';
        }
        
        function selectPitcher(el, p) {
            const entry = el.closest('.pitcher-entry');
            entry.querySelector('.pitcher-name').value = p.name;
            entry.querySelector('.pitcher-name').dataset.playerId = p.id;
            entry.querySelector('.mlb-team').value = p.team;
            el.parentElement.style.display = 'none';
        }
        
        function addRow() {
            const div = document.createElement('div');
            div.className = 'pitcher-entry';
            const ws = document.getElementById('weekStart').value;
            const we = document.getElementById('weekEnd').value;
            div.innerHTML = `
                <div class="form-group"><input type="text" class="fantasy-team" placeholder="Fantasy Team"></div>
                <div class="form-group" style="position: relative;">
                    <input type="text" class="pitcher-name" placeholder="Pitcher Name" autocomplete="off">
                    <div class="search-results" style="display: none;"></div>
                </div>
                <div class="form-group"><input type="text" class="mlb-team" placeholder="NYY" maxlength="3"></div>
                <div class="form-group"><input type="date" class="game-date" min="${ws}" max="${we}" value="${ws}"></div>
                <button class="btn btn-danger" onclick="removeRow(this)">‚úï</button>
            `;
            document.getElementById('pitcherList').appendChild(div);
        }
        
        function removeRow(btn) {
            if (document.querySelectorAll('.pitcher-entry').length > 1) {
                btn.closest('.pitcher-entry').remove();
            }
        }
        
        async function fetchGames() {
            const entries = document.querySelectorAll('.pitcher-entry');
            const pitchers = [];
            entries.forEach(e => {
                const ft = e.querySelector('.fantasy-team').value;
                const name = e.querySelector('.pitcher-name').value;
                const mlb = e.querySelector('.mlb-team').value;
                const date = e.querySelector('.game-date').value;
                const id = e.querySelector('.pitcher-name').dataset.playerId;
                
                console.log('Entry:', { ft, name, mlb, date, id });
                
                if (ft && name && mlb && date) {
                    pitchers.push({ fantasyTeam: ft, name, mlbTeam: mlb, gameDate: date, playerId: id });
                }
            });
            
            console.log('Collected pitchers:', pitchers);
            
            if (!pitchers.length) { alert('Add at least one pitcher'); return; }
            
            document.getElementById('reviewResults').innerHTML = '<div class="loading">Fetching...</div>';
            switchTab(1);
            
            gameData = [];
            const notFound = [];
            
            for (const p of pitchers) {
                console.log('Fetching game for:', p.name);
                const g = await fetchGameData(p.playerId, p.mlbTeam, p.gameDate, p.name);
                console.log('Result for', p.name, ':', g);
                if (g) {
                    gameData.push({ ...p, gameTime: g.gameTime, type: g.type, stats: g.stats });
                } else {
                    notFound.push(p);
                }
            }
            
            console.log('Final gameData:', gameData);
            console.log('Not found:', notFound);
            
            if (notFound.length > 0) {
                const names = notFound.map(p => `${p.name} (${p.mlbTeam}, ${p.gameDate})`).join('\n');
                alert(`‚ö†Ô∏è Could not find game data for:\n\n${names}\n\nThese pitchers will not appear in Step 2. Check:\n- Team abbreviation is correct\n- Date is correct\n- Pitcher actually appeared in that game`);
            }
            
            displayReview();
        }
        
        async function fetchGameData(id, team, date, name) {
            try {
                console.log(`üîç Searching for: ${name} (${team}) on ${date}, ID: ${id || 'none'}`);
                
                const teams = {NYY:147,BOS:111,TOR:141,TB:139,BAL:110,CLE:114,MIN:142,CWS:145,CHW:145,DET:116,KC:118,
                              HOU:117,TEX:140,SEA:136,LAA:108,OAK:133,ATL:144,NYM:121,PHI:143,MIA:146,WSH:120,
                              MIL:158,CHC:112,STL:138,PIT:134,CIN:113,LAD:119,SD:135,SF:137,ARI:109,COL:115};
                const tid = teams[team.toUpperCase()];
                
                if (!tid) {
                    console.error('‚ùå Unknown team:', team);
                    return null;
                }
                
                console.log(`üìÖ Fetching schedule for team ${team} (${tid}) on ${date}`);
                const sched = await fetch(`https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=${tid}&startDate=${date}&endDate=${date}`);
                const sd = await sched.json();
                
                if (!sd.dates || !sd.dates.length) {
                    console.log('‚ùå No games found for', team, 'on', date);
                    return null;
                }
                
                console.log(`Found ${sd.dates[0].games.length} game(s)`);
                
                for (const dt of sd.dates) {
                    for (const game of dt.games) {
                        console.log(`üì¶ Fetching boxscore for game ${game.gamePk}`);
                        const box = await fetch(`https://statsapi.mlb.com/api/v1/game/${game.gamePk}/boxscore`);
                        const bd = await box.json();
                        
                        let pitcher = null, teamData = null;
                        
                        // Search both teams
                        for (const t of [bd.teams.home, bd.teams.away]) {
                            const teamName = t.team.name;
                            console.log(`  Searching ${teamName} roster...`);
                            
                            for (const [k,p] of Object.entries(t.players || {})) {
                                // Check by ID if available
                                if (id && p.person.id == id) {
                                    console.log(`    ‚úì Found by ID: ${p.person.fullName}`);
                                    if (p.stats?.pitching && (p.stats.pitching.battersFaced > 0 || parseFloat(p.stats.pitching.inningsPitched||0) > 0)) {
                                        pitcher = p; teamData = t; break;
                                    }
                                }
                                // Check by name if no ID
                                if (!id && p.person.fullName.toLowerCase().includes(name.toLowerCase())) {
                                    console.log(`    ‚úì Found by name: ${p.person.fullName}`);
                                    if (p.stats?.pitching && (p.stats.pitching.battersFaced > 0 || parseFloat(p.stats.pitching.inningsPitched||0) > 0)) {
                                        pitcher = p; teamData = t; break;
                                    }
                                }
                            }
                            if (pitcher) break;
                        }
                        
                        if (pitcher) {
                            const isStart = teamData.pitchers && teamData.pitchers[0] == pitcher.person.id;
                            console.log(`‚úÖ Found ${pitcher.person.fullName} - ${isStart ? 'SP' : 'RP'}`);
                            return { gameTime: new Date(game.gameDate), type: isStart ? 'SP' : 'RP', stats: pitcher.stats.pitching };
                        } else {
                            console.log('‚ùå Pitcher not found in this game');
                        }
                    }
                }
                
                console.log(`‚ùå ${name} not found in any games for ${team} on ${date}`);
                return null;
            } catch(e) { 
                console.error('‚ùå Error fetching game:', e); 
                return null; 
            }
        }
        
        function displayReview() {
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            Object.keys(teams).forEach(t => teams[t].sort((a,b) => a.gameTime - b.gameTime));
            
            let html = '<div class="summary-card"><h2>Review by Team</h2></div>';
            Object.keys(teams).sort().forEach((tn, i) => {
                const apps = teams[tn];
                let sp = 0, rp = 0;
                html += `<div class="team-section"><div class="team-header" onclick="toggle(${i})">
                    <h3>${tn}</h3><span id="a${i}">‚ñº</span></div><div id="t${i}" class="team-content">
                    <table><tr><th>#</th><th>Pitcher</th><th>Type</th><th>Time</th><th>Status</th></tr>`;
                apps.forEach((a,j) => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    html += `<tr class="${ok?'counted':'excluded'}"><td>${j+1}</td><td>${a.name}</td><td>${a.type}</td>
                        <td>${a.gameTime.toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})}</td>
                        <td>${ok?'‚úì Counts':'‚úó Excluded'}</td></tr>`;
                });
                html += '</table></div></div>';
            });
            html += '<button class="btn btn-primary" onclick="switchTab(2);calculateStats();" style="width:100%;padding:15px;margin-top:20px;">Continue ‚Üí</button>';
            document.getElementById('reviewResults').innerHTML = html;
        }
        
        function calculateStats() {
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            
            let html = '<div class="summary-card"><h2>Corrected Totals</h2><button class="btn btn-success" onclick="exportCSV()">üìä Export CSV</button></div>';
            Object.keys(teams).sort().forEach((tn,i) => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0, total = 0;
                const pitchers = {};
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    if (!pitchers[a.name]) pitchers[a.name] = {counted:[],excluded:[]};
                    (ok ? pitchers[a.name].counted : pitchers[a.name].excluded).push(a);
                });
                
                html += `<div class="team-section"><div class="team-header" onclick="toggleC(${i})">
                    <h3>${tn}</h3><span id="ca${i}">‚ñº</span></div><div id="c${i}" class="team-content">`;
                
                Object.keys(pitchers).forEach(pn => {
                    const p = pitchers[pn];
                    const all = [...p.counted, ...p.excluded];
                    let ip=0,er=0,k=0,bb=0,h=0,hb=0,sv=0,hld=0,qs=0;
                    all.forEach(a => {
                        if (a.stats) {
                            ip += parseIP(a.stats.inningsPitched);
                            er += parseInt(a.stats.earnedRuns||0);
                            k += parseInt(a.stats.strikeOuts||0);
                            bb += parseInt(a.stats.baseOnBalls||0);
                            h += parseInt(a.stats.hits||0);
                            hb += parseInt(a.stats.hitBatsmen||0);
                            sv += parseInt(a.stats.saves||0);
                            hld += parseInt(a.stats.holds||0);
                            // QS: 6+ IP with 3 or fewer ER
                            const gameIP = parseIP(a.stats.inningsPitched||0);
                            const gameER = parseInt(a.stats.earnedRuns||0);
                            if (gameIP >= 6 && gameER <= 3) qs++;
                        }
                    });
                    
                    // Calculate points using league scoring rules
                    const pts = (ip*1.5) + (er*-2) + (k*0.75) + (bb*-0.25) + (h*-0.25) + (hb*-0.25) + (sv*1) + (hld*1) + (qs*1);
                    
                    let cpts = pts;
                    if (p.counted.length > 0 && p.excluded.length > 0) {
                        const cip = p.counted.reduce((s,a) => s + parseIP(a.stats?.inningsPitched||0), 0);
                        cpts = ip > 0 ? pts * (cip / ip) : 0;
                    } else if (!p.counted.length) cpts = 0;
                    
                    total += cpts;
                    html += `<div style="background:white;padding:15px;margin:10px 0;border-radius:6px;border-left:4px solid ${cpts>0?'#10b981':'#ef4444'};">
                        <div style="display:flex;justify-content:space-between;"><strong>${pn}</strong>
                        <strong style="color:${cpts>0?'#10b981':'#ef4444'};">${cpts.toFixed(2)} pts</strong></div>
                        <div style="font-size:13px;color:#6b7280;margin-top:5px;">
                            IP:${ip.toFixed(1)} ER:${er} K:${k} BB:${bb} H:${h} HB:${hb}
                            ${sv > 0 ? ` SV:${sv}` : ''}${hld > 0 ? ` HLD:${hld}` : ''}${qs > 0 ? ` QS:${qs}` : ''}
                        </div>
                        <div style="font-size:12px;color:#6b7280;margin-top:5px;">${p.counted.length} counted, ${p.excluded.length} excluded</div></div>`;
                });
                
                html += `<div style="background:#667eea;color:white;padding:15px;border-radius:6px;margin-top:15px;">
                    <strong>Team Total: ${total.toFixed(2)} points</strong></div></div></div>`;
            });
            document.getElementById('calcResults').innerHTML = html;
        }
        
        function parseIP(s) {
            if (!s) return 0;
            const f = parseFloat(s), w = Math.floor(f), d = Math.round((f-w)*10);
            return d === 1 ? w + 1/3 : d === 2 ? w + 2/3 : w;
        }
        
        function exportCSV() {
            const ws = document.getElementById('weekStart').value;
            const we = document.getElementById('weekEnd').value;
            const maxS = parseInt(document.getElementById('maxStarts').value);
            const maxR = parseInt(document.getElementById('maxRP').value);
            
            let csv = 'Matchup Period,Max Starts,Max Relief\n';
            csv += `"${ws} to ${we}",${maxS},${maxR}\n\n`;
            
            const teams = {};
            gameData.forEach(g => {
                if (!teams[g.fantasyTeam]) teams[g.fantasyTeam] = [];
                teams[g.fantasyTeam].push(g);
            });
            
            // Add summary section FIRST
            csv += 'Summary by Team\n';
            csv += 'Fantasy Team,Original Fantrax Points (All Appearances),Total Points to Remove,Corrected Net Points\n';
            
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0, totalAllPoints = 0, totalRemoved = 0, totalCounted = 0;
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    const stats = a.stats || {};
                    const ip = parseIP(stats.inningsPitched || 0);
                    const er = parseInt(stats.earnedRuns || 0);
                    const k = parseInt(stats.strikeOuts || 0);
                    const bb = parseInt(stats.baseOnBalls || 0);
                    const h = parseInt(stats.hits || 0);
                    const hb = parseInt(stats.hitBatsmen || 0);
                    const sv = parseInt(stats.saves || 0);
                    const hld = parseInt(stats.holds || 0);
                    const qs = (ip >= 6 && er <= 3) ? 1 : 0;
                    
                    const points = (ip*1.5) + (er*-2) + (k*0.75) + (bb*-0.25) + (h*-0.25) + (hb*-0.25) + (sv*1) + (hld*1) + (qs*1);
                    
                    // Add to total (what Fantrax shows - includes everything)
                    totalAllPoints += points;
                    
                    if (ok) {
                        totalCounted += points;
                    } else {
                        totalRemoved += points;
                    }
                });
                
                csv += `"${tn}",${totalAllPoints.toFixed(2)},${totalRemoved.toFixed(2)},${totalCounted.toFixed(2)}\n`;
            });
            
            // Now add detailed breakdown
            csv += '\n\nDetailed Breakdown by Appearance\n';
            csv += 'Fantasy Team,Pitcher,MLB Team,Game Date,Game Time (ET),Type,Status,Points,Points to Remove,IP,ER,K,BB,H,HB,SV,HLD,QS\n';
            
            Object.keys(teams).sort().forEach(tn => {
                const apps = teams[tn].sort((a,b) => a.gameTime - b.gameTime);
                let sp = 0, rp = 0;
                
                apps.forEach(a => {
                    if (a.type === 'SP') sp++; else rp++;
                    const ok = (a.type === 'SP' && sp <= maxS) || (a.type === 'RP' && rp <= maxR);
                    
                    // Calculate points for this single appearance
                    const stats = a.stats || {};
                    const ip = parseIP(stats.inningsPitched || 0);
                    const er = parseInt(stats.earnedRuns || 0);
                    const k = parseInt(stats.strikeOuts || 0);
                    const bb = parseInt(stats.baseOnBalls || 0);
                    const h = parseInt(stats.hits || 0);
                    const hb = parseInt(stats.hitBatsmen || 0);
                    const sv = parseInt(stats.saves || 0);
                    const hld = parseInt(stats.holds || 0);
                    const qs = (ip >= 6 && er <= 3) ? 1 : 0;
                    
                    const points = (ip*1.5) + (er*-2) + (k*0.75) + (bb*-0.25) + (h*-0.25) + (hb*-0.25) + (sv*1) + (hld*1) + (qs*1);
                    const countedPoints = ok ? points : 0;
                    const removedPoints = ok ? 0 : points;
                    
                    const date = a.gameTime.toLocaleDateString('en-US', {month: 'numeric', day: 'numeric', year: 'numeric'});
                    const time = a.gameTime.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true});
                    
                    csv += `"${tn}","${a.name}","${a.mlbTeam}","${date}","${time}","${a.type}","${ok?'COUNTS':'EXCLUDED'}",`;
                    csv += `${countedPoints.toFixed(2)},${removedPoints.toFixed(2)},`;
                    csv += `${stats.inningsPitched||0},${er},${k},${bb},${h},${hb},${sv},${hld},${qs}\n`;
                });
            });
            
            const blob = new Blob([csv], {type: 'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Pitcher_Overages_${ws}_to_${we}.csv`;
            a.click();
        }
        
        function switchTab(i) {
            document.querySelectorAll('.tab').forEach((t,j) => t.classList.toggle('active', j===i));
            document.querySelectorAll('.tab-content').forEach((c,j) => c.classList.toggle('active', j===i));
        }
        
        function toggle(i) {
            const c = document.getElementById('t'+i), a = document.getElementById('a'+i);
            if (c.style.display === 'none') { c.style.display = 'block'; a.textContent = '‚ñº'; }
            else { c.style.display = 'none'; a.textContent = '‚ñ∂'; }
        }
        
        function toggleC(i) {
            const c = document.getElementById('c'+i), a = document.getElementById('ca'+i);
            if (c.style.display === 'none') { c.style.display = 'block'; a.textContent = '‚ñº'; }
            else { c.style.display = 'none'; a.textContent = '‚ñ∂'; }
        }
        
        function resetAll() { if (confirm('Clear all?')) location.reload(); }
        
        async function loadFantraxTeams() {
            const leagueId = document.getElementById('fantraxLeagueId').value;
            if (!leagueId) return;
            
            try {
                console.log('üîç Loading teams from Fantrax...');
                
                // Try getTeamRosters endpoint which should have actual rosters
                const rostersUrl = `https://www.fantrax.com/fxea/general/getTeamRosters?leagueId=${leagueId}`;
                const rostersRes = await fetch(rostersUrl);
                
                if (!rostersRes.ok) {
                    throw new Error(`HTTP ${rostersRes.status}: ${rostersRes.statusText}`);
                }
                
                const rostersData = await rostersRes.json();
                console.log('Team Rosters response:', rostersData);
                
                const select = document.getElementById('fantraxTeamSelect');
                select.innerHTML = '<option value="">-- Select Your Team --</option>';
                
                // getTeamRosters should return rosters keyed by team ID
                if (rostersData && rostersData.rosters) {
                    console.log('Roster keys:', Object.keys(rostersData.rosters));
                    
                    let teamCount = 0;
                    Object.keys(rostersData.rosters).forEach(teamId => {
                        const roster = rostersData.rosters[teamId];
                        console.log(`Team ${teamId}:`, roster);
                        
                        const option = document.createElement('option');
                        option.value = teamId;
                        option.textContent = roster.teamName || roster.name || `Team ${teamId}`;
                        select.appendChild(option);
                        teamCount++;
                    });
                    
                    console.log('‚úÖ Loaded', teamCount, 'teams from Fantrax');
                } else {
                    console.warn('‚ö†Ô∏è No rosters found in response:', rostersData);
                }
                
            } catch(e) {
                console.error('‚ùå Error loading Fantrax teams:', e);
            }
        }
        
        async function loadFromFantrax() {
            const leagueId = document.getElementById('fantraxLeagueId').value;
            const teamId = document.getElementById('fantraxTeamSelect').value;
            const statusDiv = document.getElementById('fantraxStatus');
            
            if (!teamId) {
                alert('Please select your team first');
                return;
            }
            
            statusDiv.innerHTML = 'üîç Fetching data from Fantrax...';
            
            try {
                const weekStart = document.getElementById('weekStart').value;
                const weekEnd = document.getElementById('weekEnd').value;
                
                if (!weekStart || !weekEnd) {
                    alert('Please select week start and end dates first');
                    statusDiv.innerHTML = '';
                    return;
                }
                
                // Get rosters
                const rostersUrl = `https://www.fantrax.com/fxea/general/getTeamRosters?leagueId=${leagueId}`;
                const rostersRes = await fetch(rostersUrl);
                
                if (!rostersRes.ok) {
                    throw new Error('Failed to fetch roster data');
                }
                
                const rostersData = await rostersRes.json();
                console.log('Rosters data:', rostersData);
                
                if (!rostersData.rosters || !rostersData.rosters[teamId]) {
                    statusDiv.innerHTML = '‚ùå Could not find roster for selected team';
                    return;
                }
                
                const teamRoster = rostersData.rosters[teamId];
                const teamName = teamRoster.teamName || 'Your Team';
                
                console.log('Team roster:', teamRoster);
                console.log('Team roster keys:', Object.keys(teamRoster));
                console.log('Team roster structure:', {
                    hasPlayers: !!teamRoster.players,
                    hasRosterItems: !!teamRoster.rosterItems,
                    hasLineup: !!teamRoster.lineup,
                    playersLength: teamRoster.players ? teamRoster.players.length : 0,
                    rosterItemsLength: teamRoster.rosterItems ? teamRoster.rosterItems.length : 0,
                    allKeys: Object.keys(teamRoster)
                });
                
                // Try different possible fields
                let players = teamRoster.players || teamRoster.rosterItems || teamRoster.lineup || [];
                
                // If still empty, try getting from nested structure
                if (players.length === 0 && teamRoster.roster) {
                    players = teamRoster.roster.players || teamRoster.roster.items || [];
                }
                
                console.log('Players on roster:', players);
                
                if (players.length === 0) {
                    statusDiv.innerHTML = '‚ö†Ô∏è No players found on roster';
                    return;
                }
                
                // Filter for pitchers
                const pitchers = players.filter(p => {
                    const pos = p.position || '';
                    return pos.includes('P') || pos === 'SP' || pos === 'RP';
                });
                
                console.log('Found pitchers:', pitchers);
                
                if (pitchers.length === 0) {
                    statusDiv.innerHTML = '‚ö†Ô∏è No pitchers found on roster';
                    return;
                }
                
                // Populate the form
                const container = document.getElementById('pitcherList');
                container.innerHTML = '';
                
                pitchers.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'pitcher-entry';
                    
                    div.innerHTML = `
                        <div class="form-group"><input type="text" class="fantasy-team" value="${teamName}"></div>
                        <div class="form-group" style="position: relative;">
                            <input type="text" class="pitcher-name" value="${p.name || p.playerName}">
                            <div class="search-results" style="display: none;"></div>
                        </div>
                        <div class="form-group"><input type="text" class="mlb-team" value="${p.team || p.proTeam || ''}" maxlength="3"></div>
                        <div class="form-group"><input type="date" class="game-date" min="${weekStart}" max="${weekEnd}" value="${weekStart}"></div>
                        <button class="btn btn-danger" onclick="removeRow(this)">‚úï</button>
                    `;
                    container.appendChild(div);
                });
                
                statusDiv.innerHTML = `‚úÖ Loaded ${pitchers.length} pitchers! Adjust dates as needed, then click "Fetch Games".`;
                
            } catch(e) {
                console.error('Error loading from Fantrax:', e);
                statusDiv.innerHTML = `‚ùå Error: ${e.message}<br><small>You can still add pitchers manually below.</small>`;
            }
        }
        
        async function testFantraxId() {
            const id = document.getElementById('testId').value.trim();
            const resultDiv = document.getElementById('testResult');
            
            if (!id) {
                resultDiv.innerHTML = '‚ö†Ô∏è Please enter an ID';
                return;
            }
            
            resultDiv.innerHTML = 'üîç Testing...';
            
            // Test as League ID
            try {
                const leagueUrl = `https://www.fantrax.com/fxea/general/getLeagueInfo?leagueId=${id}`;
                const leagueRes = await fetch(leagueUrl);
                const leagueData = await leagueRes.json();
                
                if (leagueData && !leagueData.error && leagueData.leagueName) {
                    resultDiv.innerHTML = `‚úÖ <strong>This is a LEAGUE ID!</strong><br>League: ${leagueData.leagueName}<br>Sport: ${leagueData.sport || 'Unknown'}`;
                    return;
                }
            } catch(e) {
                console.log('Not a league ID:', e);
            }
            
            // Test as Secret ID (User ID)
            try {
                const secretUrl = `https://www.fantrax.com/fxea/general/getLeagues?userSecretId=${id}`;
                const secretRes = await fetch(secretUrl);
                const secretData = await secretRes.json();
                
                if (secretData && secretData.leagues && secretData.leagues.length > 0) {
                    const leagueList = secretData.leagues.map(l => `- ${l.leagueName}`).join('<br>');
                    resultDiv.innerHTML = `‚úÖ <strong>This is a SECRET ID!</strong><br>Found ${secretData.leagues.length} leagues:<br>${leagueList}`;
                    return;
                }
            } catch(e) {
                console.log('Not a secret ID:', e);
            }
            
            resultDiv.innerHTML = '‚ùå Could not identify this ID. Make sure it\'s copied correctly from Fantrax.';
        }
    </script>
</body>
</html>
